<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-content">
  <title>CB360_DOCUMENTOS</title>
  flex-shrink: 0; /* Impede o header de ser esmagado */
    height: auto;
</head>
<body>
  <header class="header">
    <img id="corpLogo" class="header-logo" alt="Logo" src="https://rjkbodfqsvckvnhjwmhg.supabase.co/storage/v1/object/public/cb_logos/Mark_Logo_White.png">
    <h1>CHAT INTERNO</h1>
    <div class="header-subtitle">CHAT DE CONVERSA√á√ÉO INTERNA</div>
  </header> 
  <div class="action-bar" id="action-bar">
    <button class="action-bar-close" onclick="clearSelection()" title="Cancelar"><span class="material-icons">close</span></button> 
    <div class="action-bar-counter" id="action-counter"></div>
    <div class="action-bar-actions">
      <button class="action-btn" id="action-reply" onclick="actionReply()" title="Responder"><span class="material-icons">reply</span></button>
      <button class="action-btn" id="action-star" onclick="actionStar()" title="Favoritar"><span class="material-icons">star_border</span></button>
      <button class="action-btn" id="action-copy" onclick="actionCopy()" title="Copiar"><span class="material-icons">content_copy</span></button>
      <button class="action-btn" id="action-forward" onclick="actionForward()" title="Encaminhar"><span class="material-icons">forward</span></button>
      <button class="action-btn" id="action-delete" onclick="actionDelete()" title="Apagar"><span class="material-icons">delete</span></button>
      <button class="action-btn" id="action-edit" onclick="actionEdit()" title="Editar"><span class="material-icons">edit</span></button>
    </div>
  </div> 
  <div class="main-content">
    <div id="chat-header-group" style="display: contents;"> 
      <div id="back-header" class="back-header" onclick="goBackToMain()" style="display: none;">
        <span class="material-icons back-arrow">arrow_back</span>
        <span class="back-text" style="margin-left: 10px; font-weight: 500;">Voltar</span>
      </div>
      <div id="chat-id-info" class="chat-id-info" style="display: none;"></div>    
      <div id="pinned-message" class="pinned-banner" style="display: none;">
        <span class="material-icons" style="font-size: 18px;">push_pin</span>
        <div class="pinned-text" id="pinned-text-content">...</div>
      </div>
    </div>
    <div id="contact-title" class="contact-id-info">Contactos</div>
    <div id="contact-list"></div>
    <div id="messages" class="message-container"></div>
    <div id="typing-status" class="typing-indicator"></div>
  </div>
  <div class="chat-input-bar">
    <div class="input-wrapper">
      <button id="emoji-open-btn" type="button"><span class="material-icons">sentiment_satisfied_alt</span></button>
      <input type="text" id="chat-input" placeholder="Mensagem" autocomplete="off" />    
      <button id="attachment-btn" type="button"><span class="material-icons">attach_file</span></button>    
      <button id="camera-btn" type="button"><span class="material-icons">photo_camera</span></button>
    </div>
    <button id="chat-send-btn">
      <span class="material-icons" id="send-icon">mic</span>
    </button>
  </div>
  <div class="edit-bar" id="edit-bar">
    <div class="edit-bar-content">
      <span class="material-icons edit-icon">edit</span>
      <div class="edit-info">
        <div class="edit-label">Editar mensagem</div>
        <div class="edit-text-preview" id="edit-text-preview">...</div>
      </div>
      <button class="edit-cancel" onclick="cancelEdit()">‚úï</button>
    </div>
  </div>
  <div class="reply-bar" id="reply-bar">
    <div class="reply-bar-content">
      <span class="reply-icon">‚Ü©Ô∏è</span>
      <div class="reply-info">
        <div class="reply-to-name" id="reply-to-name">Nome</div>
        <div class="reply-to-text" id="reply-to-text">Mensagem...</div>
      </div>
      <button class="reply-cancel" onclick="cancelReply()">‚úï</button>
    </div>
  </div>
  <div id="reaction-menu" class="reaction-menu">
    <div class="emoji-scroll-container">
      <span class="reaction-emoji-container" onclick="handleReactionClick('üëç')">üëç</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üòÇ')">üòÇ</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üòÆ')">üòÆ</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üò¢')">üò¢</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üôè')">üôè</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üî•')">üî•</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üëè')">üëè</span>
    </div>
    <div class="plus-button" onclick="openFullEmojiPicker()">
      <span class="material-icons">add</span>
    </div>
  </div>  
  <div id="modal-confirm" class="custom-confirm-overlay" style="display:none;">
    <div class="custom-confirm-card">
      <p class="confirm-text">Eliminar mensagem?</p>
      <div class="confirm-buttons-stack">
        <button onclick="resConfirm('todos')" class="btn-confirm-action">Eliminar para todos</button>
        <button onclick="resConfirm('mim')" class="btn-confirm-action">Eliminar s√≥ para mim</button>
        <button onclick="resConfirm('cancel')" class="btn-confirm-cancel">Cancelar</button>
      </div>
    </div>
  </div>
  <div class="footer">
    <div class="footer-content">
      <div class="powered-by"><strong>Powered by:</strong> F√°bio Martins | Sistemas de Informa√ß√£o - Grupo CB360</div>
      <div class="footer-year">¬© 2023-2025 - Sistema CB360 Mobile</div>
    </div>
  </div>
  <div id="full-emoji-picker-container">
    <emoji-picker locale="pt" class="light"></emoji-picker
  </div> 
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
(function () {
  function setVH() {
    document.documentElement.style.setProperty(
      '--vh',
      (window.innerHeight * 0.01) + 'px'
    );
  }
  window.addEventListener('resize', setVH);
  window.addEventListener('orientationchange', setVH);
  setVH();
})();
</script>
  <script> 
    /* ===================== SUPABASE CONFIGURATION ====================== */
    const SUPABASE_URL = 'https://rjkbodfqsvckvnhjwmhg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqa2JvZGZxc3Zja3ZuaGp3bWhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNjM3NjQsImV4cCI6MjA2MzczOTc2NH0.jX5OPZkz1JSSwrahCoFzqGYw8tYkgE8isbn12uP43-0';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);    
    /* ======================== GLOBAL VARIABLES ========================= */
    let currentChat = 'null';
    let currentChatName = '';
    let lastDateLabel = "";
    let totalTeam = 0;
    let currentReplyToMessage = null;
    let currentEditingMessage = null;
    let selectedMessages = [];
    let messagesToForward = [];
    let reactionTargetId = null;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let recordTimeout;
    let recordingTimer;
    const currentUserNint = String(localStorage.getItem("currentCorpNint") || "205");
    function getSupabaseHeaders(options = {}) {
      const corp = localStorage.getItem("currentCorpOperNr") || sessionStorage.getItem("currentCorpOperNr");
      const nint = localStorage.getItem("currentCorpNint") || sessionStorage.getItem("currentNInt");
      const headers = {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'x-my-corpo': corp,
        'x-my-nint': nint
      };
      if (options.returnRepresentation) headers['Prefer'] = 'return=representation';
      return headers;
    }
    /* ================== TYPING BAR & EMOJI CONTROLER =================== */
    const inputMensage = document.getElementById('chat-input');
    const barraDeInput = document.querySelector('.chat-input-bar');
    const iconBtn = document.getElementById('send-icon'); 
    const emojiBtn = document.getElementById('emoji-open-btn');
    const emojiContainer = document.getElementById('full-emoji-picker-container');
    const picker = document.querySelector('emoji-picker');
    const messageContainer = document.querySelector('.message-container');
    function resetLayout() {
      emojiContainer.style.display = 'none';
      barraDeInput.style.bottom = '60px'; 
      messageContainer.style.marginBottom = '80px';
      setTimeout(() => {
        messageContainer.scrollTop = messageContainer.scrollHeight;
      }, 100);
    }
    inputMensage.addEventListener('input', function() {
      const hasText = this.value.trim().length > 0;
      const novoIcone = hasText ? 'send' : 'mic';
      if (iconBtn.textContent !== novoIcone) {
        iconBtn.style.transform = 'rotate(180deg) scale(0)';
        iconBtn.style.opacity = '0';
        setTimeout(() => {
          iconBtn.textContent = novoIcone;
          iconBtn.style.transform = 'rotate(0deg) scale(1)';
          iconBtn.style.opacity = '1';
          if (hasText) {
            barraDeInput.classList.add('typing');
          } else {
            barraDeInput.classList.remove('typing');
          }
        }, 150);
      }
    });
    emojiBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (emojiContainer.style.display === 'block') {
        resetLayout();
        inputMensage.focus();
      } else {
        inputMensage.blur(); 
        setTimeout(() => {
          emojiContainer.style.display = 'block';
          barraDeInput.style.bottom = '305px'; 
          messageContainer.style.marginBottom = '325px'; 
          let scrollAcompanha = setInterval(() => {
            messageContainer.scrollTop = messageContainer.scrollHeight;
          }, 10);
          setTimeout(() => clearInterval(scrollAcompanha), 400);
        }, 50);
      }
    });
    picker.addEventListener('emoji-click', event => {
      const emoji = event.detail.unicode;
      const inicio = inputMensage.selectionStart;
      const fim = inputMensage.selectionEnd;
      inputMensage.value = inputMensage.value.substring(0, inicio) + emoji + inputMensage.value.substring(fim);
      const novaPosicao = inicio + emoji.length;
      inputMensage.setSelectionRange(novaPosicao, novaPosicao);
      inputMensage.dispatchEvent(new Event('input'));
    });
    inputMensage.addEventListener('focus', () => {
      resetLayout();
    });
    messageContainer.addEventListener('click', (e) => {
      if (emojiContainer.style.display === 'block') {
        resetLayout();
      }
    });
    
    
    
    
    
    
    // --- LOGICA DE GRAVA√á√ÉO ---

// SUBSTITUI a fun√ß√£o startAudioLogic() por esta vers√£o melhorada:
async function startAudioLogic(e) {
    if (iconBtn.textContent !== 'mic') return;
    if (currentChat === 'null') return;

    recordTimeout = setTimeout(async () => {
        try {
            // ‚úÖ NOVO: Verificar permiss√£o antes de pedir acesso
            const permission = await navigator.permissions.query({ name: 'microphone' });
            
            if (permission.state === 'denied') {
                alert('‚ö†Ô∏è Acesso ao microfone bloqueado!\n\nPor favor, ativa nas defini√ß√µes do browser.');
                return;
            }

            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
            
            mediaRecorder.onstop = async () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                if (audioBlob.size > 2000) {
                    await uploadAudioToSupabase(audioBlob);
                }
                stream.getTracks().forEach(t => t.stop());
            };

            mediaRecorder.start();
            isRecording = true;
            
            iconBtn.classList.add("recording-pulse");
            inputMensage.placeholder = "üî¥ A gravar... solte para enviar";
            if (barraDeInput) barraDeInput.style.backgroundColor = "#fff5f5";
            
        } catch (err) {
            console.error("Erro ao aceder ao microfone:", err);
            
            if (err.name === 'NotAllowedError') {
                alert('‚ö†Ô∏è Permiss√£o negada!\n\nClica no cadeado ao lado do URL e permite o acesso ao microfone.');
            } else if (err.name === 'NotFoundError') {
                alert('‚ö†Ô∏è Microfone n√£o encontrado!\n\nVerifica se tens um microfone ligado.');
            } else {
                alert('‚ùå Erro ao aceder ao microfone: ' + err.message);
            }
        }
    }, 250);
}

function stopAudioLogic() {
    clearTimeout(recordTimeout);
    
    if (isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        iconBtn.classList.remove("recording-pulse");
        inputMensage.placeholder = "Mensagem"; // ‚úÖ Nome correto da vari√°vel
        if (barraDeInput) barraDeInput.style.backgroundColor = "";
    } else {
        // ‚úÖ NOVO: Mesmo que n√£o tenha gravado, reseta o placeholder
        inputMensage.placeholder = "Mensagem";
        if (barraDeInput) barraDeInput.style.backgroundColor = "";
    }
}

// Eventos para Desktop
iconBtn.addEventListener('mousedown', startAudioLogic);
window.addEventListener('mouseup', stopAudioLogic);

// Eventos para Mobile (Importante: passive false para e.preventDefault funcionar)
iconBtn.addEventListener('touchstart', (e) => {
    if (iconBtn.textContent === 'mic') e.preventDefault();
    startAudioLogic();
}, { passive: false });
window.addEventListener('touchend', stopAudioLogic);
    
    
    
    
    
    async function uploadAudioToSupabase(blob) {
    const fileName = `audio_${Date.now()}.webm`;
    const filePath = `${currentChat}/${fileName}`;

    try {
        const { data, error } = await supabaseClient.storage
            .from('cb_files')
            .upload(filePath, blob);

        if (error) throw error;

        const { data: { publicUrl } } = supabaseClient.storage
            .from('cb_files')
            .getPublicUrl(filePath);

        // Chamamos o envio indicando que o conte√∫do √© um √°udio
        await sendMessage("Enviou um √°udio", publicUrl); 

    } catch (err) {
        console.error("Erro:", err.message);
    }
}
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    
    /* ==================== LOADING CORPORATION DATA ===================== */
    async function loadCorpInfo() {
      const corpOperNr = localStorage.getItem("currentCorpOperNr") || "0805";
      const logoEl = document.getElementById("corpLogo");
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/corporation_data?select=corporation,corp_oper_nr,logo_url&corp_oper_nr=eq.${corpOperNr}`, {
            headers: getSupabaseHeaders()
          }
        );
        const data = await response.json();
        if (data && data.length > 0 && logoEl && data[0].logo_url) logoEl.src = data[0].logo_url.trim();
      } catch (err) {console.error('Erro no loadCorpInfo:', err);}
    }
    /* ========================== LOADING THEME ========================== */
    function loadTheme() {
      if (localStorage.getItem('sgo-theme') === 'dark') document.body.classList.add('dark-mode');
    }
    /* ======================== LOADING CONTACTS ========================= */
    async function loadContacts() {
  const corpOperNr = localStorage.getItem("currentCorpOperNr") || "0805";
  const colors = {
    'A': '#f44336','B': '#e91e63','C': '#9c27b0','D': '#673ab7','E': '#3f51b5','F': '#2196f3','G': '#03a9f4',
    'H': '#00bcd4','I': '#009688','J': '#4caf50','K': '#8bc34a','L': '#cddc39','M': '#ffeb3b','N': '#ffc107',
    'O': '#ff9800','P': '#ff5722','Q': '#795548','R': '#9e9e9e','S': '#60727b','T': '#333333','U': '#ff4081',
    'V': '#7c4dff','W': '#536dfe','X': '#448aff','Y': '#00e676','Z': '#cfd8dc'
  };    

  const {data: users, error} = await supabaseClient.from('reg_elems')
    .select('n_int, abv_name, photo_url, elem_state')
    .eq('corp_oper_nr', corpOperNr)
    .eq('elem_state', true)
    .order('n_int', {ascending: true});    

  if (error) return console.error(error);
  
  totalTeam = users.length + 1;
  const listEl = document.getElementById("contact-list");
  listEl.innerHTML = '';      

  // --- 1. CHAT GERAL ---
  const geral = document.createElement("div");
  geral.className = "contact";
  geral.dataset.nint = 'geral';
  geral.onclick = () => openChat('geral', 'Chat Geral');
  
  // Verificar rascunho do Geral
  const draftGeral = localStorage.getItem("draft_geral");
  const subTextGeral = draftGeral ? `<div class="draft-preview">Rascunho: ${draftGeral}</div>` : `<div class="nint">Broadcast</div>`;

  geral.innerHTML = `
    <div class="contact-avatar" style="background-color: #333;">G</div>
    <div class="contact-info">
      <div class="name">Chat Geral</div>
      ${subTextGeral}
    </div>`;
  listEl.appendChild(geral);

  // --- 2. LISTA DE UTILIZADORES ---
  users.forEach(user => {
    if (String(user.n_int) === currentUserNint) return;
    
    const contactId = String(user.n_int);
    const firstLetter = user.abv_name.charAt(0).toUpperCase();
    const avatarColor = colors[firstLetter] || '#d32f2f';
    
    // VERIFICA√á√ÉO DE RASCUNHO PARA O CONTACTO
    const savedDraft = localStorage.getItem(`draft_${contactId}`);
    // Se houver rascunho, mostra o rascunho, sen√£o mostra o ID normal
    const subText = savedDraft 
      ? `<div class="draft-preview">Rascunho: ${savedDraft}</div>` 
      : `<div class="nint">ID: ${user.n_int}</div>`;

    const div = document.createElement("div");
    div.className = "contact";
    div.setAttribute('data-nint', contactId);
    div.onclick = () => openChat(user.n_int, user.abv_name);
    
    const avatarContent = user.photo_url ? `<img src="${user.photo_url}">` : firstLetter;
    
    div.innerHTML = `
      <div class="contact-avatar" style="background-color: ${user.photo_url ? 'transparent' : avatarColor};">
        ${avatarContent}
        <div class="status-dot"></div>
      </div>
      <div class="contact-info">
        <div class="name">${user.abv_name}</div>
        ${subText}
      </div>`;
    listEl.appendChild(div);
  });
}
    /* ========================== UPDATE BADGES ========================== */
    async function updateUnreadBadges() {
      const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
      const { count: totalGeral } = await supabaseClient
      .from('chat_messages')
      .select('*', { count: 'exact', head: true })
      .eq('recipient_nint', 'geral')
      .eq('corp_oper_nr', currentCorp)
      .neq('n_int', currentUserNint);
      const { count: lidasGeral } = await supabaseClient
      .from('chat_message_reads')
      .select('*', { count: 'exact', head: true })
      .eq('n_int', currentUserNint)
      .eq('corp_oper_nr', currentCorp);
      const unreadGeral = Math.max(0, (totalGeral || 0) - (lidasGeral || 0));
      const { data: privData } = await supabaseClient
      .from('chat_messages')
      .select('n_int')
      .eq('recipient_nint', currentUserNint)
      .eq('corp_oper_nr', currentCorp)
      .is('read_at', null);
      const privCounts = {};
      if (privData) {
        privData.forEach(msg => {
          privCounts[msg.n_int] = (privCounts[msg.n_int] || 0) + 1;
        });
      }
      document.querySelectorAll('.contact').forEach(contactEl => {
        const nint = contactEl.getAttribute('data-nint');
        let finalCount = (nint === 'geral') ? unreadGeral : (privCounts[nint] || 0);
        let badge = contactEl.querySelector('.unread-badge');
        if (finalCount > 0) {
          if (!badge) {
            badge = document.createElement('div');
            badge.className = 'unread-badge';
            contactEl.appendChild(badge);
          }
          badge.textContent = finalCount > 99 ? '99+' : finalCount;
        } else {
          if (badge) badge.remove();
        }
      });
    }
    /* ====================== BACK TO CONTACT LIST ======================= */
    function goBackToMain() {
      const text = inputMensage.value.trim();
      if (text !== "" && currentChat !== 'null') {
        localStorage.setItem(`draft_${currentChat}`, text);
      } else if (currentChat !== 'null') {
        localStorage.removeItem(`draft_${currentChat}`);
      }
      resetLayout();
      inputMensage.value = "";
      inputMensage.dispatchEvent(new Event('input'));
      document.getElementById("pinned-message").style.display = 'none';
      document.getElementById("messages").style.display = 'none';
      document.getElementById("back-header").style.display = 'none';
      document.getElementById("chat-id-info").style.display = 'none';
      document.getElementById("typing-status").style.display = 'none';
      const inputBar = document.querySelector(".chat-input-bar");
      if (inputBar) inputBar.style.display = 'none';
      document.getElementById("contact-list").style.display = 'flex';
      document.getElementById("contact-title").style.display = 'block';
      currentChat = 'null';
      loadContacts();
    }
    /* ======================== SCROLL TO BOTTOM ========================= */
    function scrollToBottom() {
      const messagesEl = document.getElementById("messages");
      if (messagesEl && messagesEl.style.display !== 'none') {
        setTimeout(() => {
          messagesEl.scrollTo({
            top: messagesEl.scrollHeight,
            behavior: 'smooth'
          });
        }, 50);
      }
    }
    /* ========================= FETCH USER NAME ========================= */
    async function fetchUserName() {
      try {
        const {data} = await supabaseClient.from('reg_elems').select('abv_name').eq('n_int', currentUserNint).maybeSingle();
        return (data && data.abv_name) ? data.abv_name : "Utilizador";
      } catch {return "Utilizador";}
    }
    /* ======================= RENDER REACTIONS ========================== */
    function renderReactions(reactions, messageId) {
      if (!reactions || Object.keys(reactions).length === 0) return '';
      const grouped = {};
      for (const [nint, emoji] of Object.entries(reactions)) {
        if (!grouped[emoji]) grouped[emoji] = [];
        grouped[emoji].push(nint);
      }
      let html = '<div class="message-reactions">';
      for (const [emoji, users] of Object.entries(grouped)) {
        const count = users.length;
        const isMyReaction = users.includes(currentUserNint);
        const myClass = isMyReaction ? 'my-reaction' : '';
        const isThumb = emoji === 'üëç' || emoji === 'üëé';
        const thumbClass = isThumb ? 'thumb-emoji' : '';
        const countHTML = count > 1 ? `<span class="reaction-count">${count}</span>` : '';
        html += `
          <div class="reaction-badge ${myClass}" onclick="event.stopPropagation(); toggleReaction('${messageId}', '${emoji}')">
            <span class="reaction-emoji ${thumbClass}">${emoji}</span>
            ${countHTML}
          </div>
        `;
      }
      html += '</div>';
      return html;
    }
    /* ======================= TOGGLE REACTIONS ========================== */
    async function toggleReaction(messageId, emoji) {
      const { data: msg, error: fetchError } = await supabaseClient
      .from('chat_messages')
      .select('reactions')
      .eq('id', messageId)
      .single();
      if (fetchError) {
        console.error("Erro ao ler rea√ß√µes:", fetchError);
        return;
      }
      let currentReactions = msg.reactions || {};
      if (!currentReactions[emoji]) {
        currentReactions[emoji] = [];
      }
      const userIndex = currentReactions[emoji].indexOf(currentUserNint);
      if (userIndex === -1) {
        currentReactions[emoji].push(currentUserNint);
      } else {
        currentReactions[emoji].splice(userIndex, 1);
        if (currentReactions[emoji].length === 0) {
          delete currentReactions[emoji];
        }
      }
      const { error: updateError } = await supabaseClient
      .from('chat_messages')
      .update({ reactions: currentReactions })
      .eq('id', messageId);
      if (updateError) {
        console.error("Erro ao atualizar rea√ß√£o:", updateError);
      }
    }
    /* ======================= ADD MESSAGE TO DOM ======================== */
    function addMessageToDOM(msg, chatRef) {
      if (!currentChat || currentChat !== String(chatRef)) return;
      const messagesEl = document.getElementById("messages");
      if (!messagesEl) return;

      // 1. GEST√ÉO DE DATAS
      const msgDate = new Date(msg.created_at);
      const dateLabel = getDateLabel(msgDate);
      if (dateLabel !== lastDateLabel) {
        const divider = document.createElement("div");
        divider.className = "date-divider";
        divider.innerHTML = `<span>${dateLabel}</span>`;
        messagesEl.appendChild(divider);
        lastDateLabel = dateLabel;
      }

      const emptyMsg = messagesEl.querySelector(".empty-chat-placeholder");
      if (emptyMsg) emptyMsg.remove();

      // 2. GEST√ÉO DE TEMPO E EDI√á√ÉO
      let time = "";
      if (msg.edited_at) {
        time = new Date(msg.edited_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      } else if (msg.created_at) {
        time = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
      }

      // 3. L√ìGICA DE VERIFICA√á√ÉO DE LEITURA (CHECKS)
      const isMe = String(msg.n_int) === currentUserNint;
      let checkHTML = '';
      if (isMe) {
        let icon = 'done';
        let checkClass = 'sent';
        if (chatRef === 'geral') {
          const numLeituras = (msg.chat_message_reads && msg.chat_message_reads[0]) ? msg.chat_message_reads[0].count : 0;
          icon = 'done_all';
          checkClass = (numLeituras >= (totalTeam - 1) && totalTeam > 1) ? 'read' : 'delivered';
          const contador = numLeituras > 0 ? `<span style="font-size:9px; margin-left:2px; opacity:0.8;">${numLeituras}</span>` : '';
          const msgId = msg.id || 'temp-' + Date.now();
          checkHTML = `<span id="check-${msgId}" class="material-icons status-checks ${checkClass}">${icon}</span>${contador}`;
        } else {
          const recipientDot = document.querySelector(`.contact[data-nint="${chatRef}"] .status-dot`);
          const isOnline = recipientDot && recipientDot.classList.contains('online');
          if (msg.read_at) {
            icon = 'done_all'; checkClass = 'read';
          } else if (isOnline) {
            icon = 'done_all'; checkClass = 'delivered';
          }
          const msgId = msg.id || 'temp-' + Date.now();
          checkHTML = `<span id="check-${msgId}" class="material-icons status-checks ${checkClass}">${icon}</span>`;
        }
      }

      // 4. CRIA√á√ÉO DO ELEMENTO DA MENSAGEM
      const div = document.createElement("div");
      div.className = "message " + (isMe ? "self" : "other");
      div.dataset.messageId = msg.id;
      div.dataset.messageText = msg.message;
      div.dataset.senderName = msg.abv_name;
      div.dataset.senderNint = msg.n_int;

      const isDeleted = msg.deleted_at !== null && msg.deleted_at !== undefined;
      if (isDeleted) div.classList.add('deleted');

      const nameHTML = (chatRef === 'geral' && !isMe) ? `<div class="msg-sender-name">${msg.abv_name}</div>` : "";  

      // 5. RESPOSTA (REPLY)
      let replyPreviewHTML = '';
      if (msg.reply_to_message_id && msg.reply_to_message) {
        const replyMsg = msg.reply_to_message;
        replyPreviewHTML = `
          <div class="reply-preview" onclick="scrollToMessage('${msg.reply_to_message_id}')">
            <div class="reply-preview-name">${replyMsg.abv_name || 'Utilizador'}</div>
            <div class="reply-preview-text">${replyMsg.message || ''}</div>
          </div>
        `;
      }

      const reactionsHTML = renderReactions(msg.reactions, msg.id);
      const isStarred = msg.starred_by && msg.starred_by.includes(currentUserNint);
      const starIcon = isStarred ? '<span class="star-icon" style="color: #ffd700; margin-left: 5px; font-size: 14px;">‚≠ê</span>' : '';

      // 6. CONTE√öDO DIN√ÇMICO (TEXTO, IMAGEM, √ÅUDIO, FICHEIRO)
      let finalContentHTML = "";
      if (isDeleted) {
        finalContentHTML = '<span class="deleted-icon">üö´</span> Mensagem apagada';
      } else {
        switch(msg.message_type) {
          case 'image':
            finalContentHTML = `<img src="${msg.file_url}" class="chat-img" style="max-width:230px; border-radius:10px; display:block; margin-bottom:5px; cursor:pointer;" onclick="window.open('${msg.file_url}', '_blank')">`;
            if (msg.message) finalContentHTML += `<div class="img-caption">${msg.message}</div>`;
            break;
          
          case 'audio':
            const audioID = `audio-${msg.id || Date.now()}`;
            finalContentHTML = `
              <div class="audio-bubble">
                <div class="audio-play-btn" onclick="toggleAudio('${audioID}', this)">
                  <span class="material-icons">play_arrow</span>
                </div>
                <div class="audio-progress-container">
                  <div class="audio-progress-bar">
                    <div id="fill-${audioID}" class="audio-progress-fill"></div>
                  </div>
                  <div class="audio-time" id="time-${audioID}">0:00</div>
                </div>
                <audio id="${audioID}" src="${msg.file_url}" ontimeupdate="updateProgress('${audioID}')" onended="resetAudioIcon('${audioID}')"></audio>
              </div>`;
            break;

          case 'file':
            finalContentHTML = `
              <div class="file-msg" style="display:flex; align-items:center; gap:10px; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 8px;">
                <span class="material-icons">insert_drive_file</span>
                <a href="${msg.file_url}" target="_blank" style="font-size:13px; color:inherit; text-decoration:none; overflow:hidden; text-overflow:ellipsis;">${msg.file_name || 'Documento'}</a>
              </div>`;
            break;

          default:
            const tempSpan = document.createElement('span');
            tempSpan.textContent = msg.message;
            finalContentHTML = tempSpan.innerHTML;
        }
      }

      // 7. MONTAGEM FINAL DO INNERHTML
      div.innerHTML = `
        ${nameHTML}
        ${replyPreviewHTML}
        <span class="msg-text-content">${finalContentHTML}</span>${starIcon}
        ${reactionsHTML}
        <div class="msg-meta">
          ${time} ${checkHTML}
        </div>
      `;

      // 8. ETIQUETA DE EDI√á√ÉO
      if (!isDeleted && msg.edited_at) {
        const metaDiv = div.querySelector('.msg-meta');
        if (metaDiv) {
          const editTag = document.createElement('span');
          editTag.className = 'message-edited-tag';
          editTag.textContent = 'editada';
          metaDiv.insertBefore(editTag, metaDiv.firstChild);
        }
      }    

      // 9. FINALIZA√á√ÉO E RENDERIZA√á√ÉO
      setupMessageInteraction(div, msg);
      messagesEl.appendChild(div);

      if (messagesEl.style.display !== 'none') {
        scrollToBottom();
      }
}
    /* ======================== GET MESSAGE DATE  ======================== */
    function getDateLabel(date) {
      const today = new Date();
      const yesterday = new Date();
      yesterday.setDate(today.getDate() - 1);
      if (date.toDateString() === today.toDateString()) return "Hoje";
      if (date.toDateString() === yesterday.toDateString()) return "Ontem";
      return date.toLocaleDateString('pt-PT', {day: '2-digit', month: '2-digit', year: 'numeric'});
    }
    
    
    function toggleAudio(id, btn) {
    const audio = document.getElementById(id);
    const icon = btn.querySelector('.material-icons');

    if (audio.paused) {
        // Pausa outros √°udios para n√£o sobrepor
        document.querySelectorAll('audio').forEach(a => {
            if (a.id !== id) {
                a.pause();
                const otherBtn = document.querySelector(`[onclick*="${a.id}"] .material-icons`);
                if (otherBtn) otherBtn.textContent = 'play_arrow';
            }
        });
        audio.play();
        icon.textContent = 'pause';
    } else {
        audio.pause();
        icon.textContent = 'play_arrow';
    }
}

function updateProgress(id) {
    const audio = document.getElementById(id);
    const fill = document.getElementById(`fill-${id}`);
    const timeDisplay = document.getElementById(`time-${id}`);
    if (!audio.duration) return;

    const percent = (audio.currentTime / audio.duration) * 100;
    fill.style.width = percent + "%";

    const mins = Math.floor(audio.currentTime / 60);
    const secs = Math.floor(audio.currentTime % 60);
    timeDisplay.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

function resetAudioIcon(id) {
    const icon = document.querySelector(`[onclick*="${id}"] .material-icons`);
    if (icon) icon.textContent = 'play_arrow';
    const fill = document.getElementById(`fill-${id}`);
    if (fill) fill.style.width = "0%";
}
    
    
    
    
    
    
    
    
    
    
    /* ============================ OPEN CHAT ============================ */
    async function openChat(n_int, name) {
      const messagesEl = document.getElementById("messages");
      const contactListEl = document.getElementById("contact-list");
      const contactTitle = document.getElementById("contact-title");
      const chatIdInfo = document.getElementById("chat-id-info");
      const backBtn = document.getElementById("back-header");
      const pinnedEl = document.getElementById("pinned-message");
      const inputBar = document.querySelector(".chat-input-bar");    
      const typingStatusEl = document.getElementById("typing-status");
      messagesEl.innerHTML = '';
      if (typeof messagesToForward !== 'undefined' && messagesToForward.length > 0) {
        const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
        const senderName = await fetchUserName();
        for (const msg of messagesToForward) {
          const { error } = await supabaseClient.from('chat_messages').insert([{n_int: currentUserNint, recipient_nint: String(n_int), corp_oper_nr: currentCorp, abv_name: senderName,
                                                                                message: msg.message, is_forwarded: true}]);
          if (error) console.error("Erro ao encaminhar mensagem:", error);
        }
        messagesToForward = [];
        await new Promise(resolve => setTimeout(resolve, 150));
      }
      currentChat = String(n_int);
      currentChatName = name;
      if (currentChat === 'geral') {
        await markGeralAsRead();
        updateUnreadBadges();
      } else {
        const badge = document.querySelector(`.contact[data-nint="${n_int}"] .unread-badge`);
        if (badge) badge.remove();
        sendReadReceipt(currentChat);
      }
      contactListEl.style.display = 'none';
      contactTitle.style.display = 'none';
      messagesEl.style.display = 'flex';
      backBtn.style.display = 'flex';
      chatIdInfo.style.display = 'block';
      typingStatusEl.style.display = 'none';
      inputBar.style.display = 'flex';
      chatIdInfo.textContent = `A conversar com: ${name}`;
      if (currentChat === 'geral') {
        pinnedEl.style.display = 'flex';
        document.getElementById("pinned-text-content").textContent = "ATEN√á√ÉO! Este chat √© supervisionado por IA. Qualquer mensagem que viole normas √©ticas ser√° imediatamente bloqueada.";
      } else { 
        pinnedEl.style.display = 'none';
      }
      const savedDraft = localStorage.getItem(`draft_${currentChat}`);
      if (savedDraft) {
        inputMensage.value = savedDraft;
        inputMensage.dispatchEvent(new Event('input'));
      } else {
        inputMensage.value = "";
        inputMensage.dispatchEvent(new Event('input'));
      }
      await loadMessages(currentChat);
    }
    /* ======================== LOADING MESSAGES ========================= */
    async function loadMessages(chat = currentChat) {
  const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
  const messagesEl = document.getElementById("messages");
  const chatRef = chat || 'geral';
  
  messagesEl.innerHTML = '';
  lastDateLabel = "";

  // Garantimos que selecionamos todas as colunas (*), incluindo file_url
  let query = supabaseClient
    .from('chat_messages')
    .select('*, chat_message_reads(count), reply_to_message:reply_to_message_id(id, message, abv_name)')
    .eq('corp_oper_nr', currentCorp);

  if (chatRef === 'geral') {
    query = query.eq('recipient_nint', 'geral');
  } else {
    query = query.or(`and(n_int.eq.${currentUserNint},recipient_nint.eq.${chatRef}),and(n_int.eq.${chatRef},recipient_nint.eq.${currentUserNint})`);
  }      

  try {
    const {data: msgs, error} = await query.order('created_at', {ascending: true});
    if (currentChat !== chatRef) return;    
    if (error) return console.error(error);

    if (!msgs || msgs.length === 0) {
      const emptyMsg = document.createElement("div");
      emptyMsg.className = "empty-chat-placeholder";
      // ... (teu estilo de placeholder)
      emptyMsg.innerHTML = `<span class="material-icons" style="font-size:48px; display:block; margin-bottom:10px; opacity:0.5;">chat_bubble_outline</span>Ainda n√£o iniciou nenhuma conversa com<br><strong>${currentChatName || 'este contacto'}</strong>`;
      messagesEl.appendChild(emptyMsg);
    } else {
      msgs.forEach(msg => addMessageToDOM(msg, chatRef)); 
      scrollToBottom();
    }
  } catch (err) {
    console.error(err);
  }
}
    /* ====================== MARK MESSAGE AS READ ======================= */    
    async function markGeralAsRead() {
      const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
      const { data: messages } = await supabaseClient
      .from('chat_messages')
      .select('id')
      .eq('recipient_nint', 'geral')
      .eq('corp_oper_nr', currentCorp)
      .neq('n_int', currentUserNint);
      if (!messages || messages.length === 0) return;
      const { data: alreadyRead } = await supabaseClient
      .from('chat_message_reads')
      .select('message_id')
      .eq('n_int', currentUserNint);
      const readIds = new Set(alreadyRead?.map(r => r.message_id) || []);
      const toInsert = messages
      .filter(m => !readIds.has(m.id))
      .map(m => ({message_id: m.id, n_int: currentUserNint, read_at: new Date().toISOString(), corp_oper_nr: currentCorp}));
      if (toInsert.length === 0) return;
      const { error } = await supabaseClient
      .from('chat_message_reads')
      .insert(toInsert);
      if (error) {
        console.error("Erro na 2¬™ leitura:", error);
      } else {
        updateUnreadBadges();
      }
    }
    /* ========================== SEND MESSAGE (UPDATED) =========================== */
    async function sendMessage(audioText = null, audioUrl = null) {
  const inputEl = document.getElementById("chat-input");
  const sendBtn = document.getElementById("chat-send-btn");
  
  // Se for √°udio, usamos o texto do √°udio. Se for texto, lemos o input.
  const text = audioText || inputEl.value.trim();
  
  // S√≥ trava se n√£o houver texto nem URL de √°udio
  if (!text && !audioUrl) return;

  sendBtn.disabled = true;
  
  // S√≥ limpa o input se for envio de texto normal
  if (!audioUrl) {
    inputEl.value = "";
    resetLayout();
    inputEl.dispatchEvent(new Event('input'));
  }

  const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";

  // L√≥gica de Edi√ß√£o (mantida igual)
  if (currentEditingMessage && !audioUrl) {
    // ... (teu c√≥digo de edi√ß√£o atual permanece aqui)
    return;
  }

  const senderName = await fetchUserName();
  
  // 2. MONTAGEM DOS DADOS (Agora com file_url e type)
  const messageData = {
    n_int: currentUserNint, 
    recipient_nint: currentChat, 
    corp_oper_nr: currentCorp, 
    abv_name: senderName, 
    message: text,
    file_url: audioUrl, // Grava a URL do Supabase Storage aqui
    message_type: audioUrl ? 'audio' : 'text' // Opcional: ajuda a filtrar na DB
  };

  if (currentReplyToMessage) {
    messageData.reply_to_message_id = currentReplyToMessage.id;
  }

  const { error } = await supabaseClient.from('chat_messages').insert([messageData]);

  sendBtn.disabled = false;

  if (error) {
    console.error(error); 
    if (!audioUrl) {
      inputEl.value = text;
      inputEl.dispatchEvent(new Event('input'));
    }
  } else {
    cancelReply();
    clearSelection();
    const messageContainer = document.querySelector('.message-container');
    messageContainer.scrollTop = messageContainer.scrollHeight;
  }
}
    /* ==================== TOOGLE MESSAGE SELECTION ===================== */
    function toggleMessageSelection(messageElement, messageData) {
      const messageId = messageData.id;
      const index = selectedMessages.findIndex(m => m.id === messageId);
      if (index > -1) {
        selectedMessages.splice(index, 1);
        messageElement.classList.remove('selected');
      } else {
        selectedMessages.push(messageData);
        messageElement.classList.add('selected');
      }
      const menu = document.getElementById('reaction-menu');
      if (menu) {
        if (selectedMessages.length === 1) {          
        } else {
          menu.style.display = 'none';
        }
      }
      updateActionBar();
    }
    /* ======================== UPDATE ACTION BAR ======================== */
    function updateActionBar() {
      const actionBar = document.getElementById('action-bar');
      const counter = document.getElementById('action-counter');
      const replyBtn = document.getElementById('action-reply');
      const copyBtn = document.getElementById('action-copy');
      const editBtn = document.getElementById('action-edit');
      const deleteBtn = document.getElementById('action-delete');
      const starBtn = document.getElementById('action-star');
      const menu = document.getElementById('reaction-menu');      
      const count = selectedMessages.length;
      if (count === 0) {
        actionBar.classList.remove('show');
        if (menu) menu.style.display = 'none';
        return;
      }      
      actionBar.classList.add('show');
      if (count > 1 && menu) {
        menu.style.display = 'none';
      }      
      counter.textContent = count === 1 ? '1' : `${count}`;
      const isOne = count === 1;
      const firstMsg = selectedMessages[0];
      const allMine = selectedMessages.every(m => String(m.n_int) === currentUserNint);      
      if (isOne) {
        replyBtn.classList.remove('disabled');
      } else {
        replyBtn.classList.add('disabled');
      }      
      if (isOne) {
        copyBtn.classList.remove('disabled');
      } else {
        copyBtn.classList.add('disabled');
      }      
      if (isOne && String(firstMsg.n_int) === currentUserNint) {
        editBtn.classList.remove('disabled');
      } else {
        editBtn.classList.add('disabled');
      }      
      if (allMine) {
        deleteBtn.classList.remove('disabled');
      } else {
        deleteBtn.classList.add('disabled');
      }
      if (starBtn && count > 0) {
        const allStarred = selectedMessages.every(m => 
          m.starred_by && m.starred_by.includes(currentUserNint)
        );        
        const starIcon = starBtn.querySelector('.material-icons');
        if (starIcon) {
          starIcon.textContent = allStarred ? 'star' : 'star_border';
        }
      }
    }
    /* =================================================================== */
    /* ======================== ACTION FUNCTIONS ========================= */
    /* =================================================================== */
    /* ========================== ACTION REPLAY ========================== */
    function actionReply() {
      if (selectedMessages.length !== 1) return;
      const msg = selectedMessages[0];
      replyToMessage(msg.id, msg.abv_name, msg.message);
      clearSelection();
    }
    /* =========================== ACTION STAR =========================== */
    async function actionStar() {
      if (selectedMessages.length === 0) return;      
      const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";      
      try {
        for (const msg of selectedMessages) {
          const { data: msgData, error: fetchError } = await supabaseClient
            .from('chat_messages')
            .select('starred_by')
            .eq('id', msg.id)
            .single();          
          if (fetchError) {
            console.error("Erro ao buscar favoritos:", fetchError);
            continue;
          }          
          let starredBy = msgData?.starred_by || [];
          const index = starredBy.indexOf(currentUserNint);          
          if (index > -1) {
            starredBy.splice(index, 1);
          } else {
            starredBy.push(currentUserNint);
          }          
          const { error: updateError } = await supabaseClient
            .from('chat_messages')
            .update({ starred_by: starredBy })
            .eq('id', msg.id)
            .eq('corp_oper_nr', currentCorp);          
          if (updateError) {
            console.error("Erro ao atualizar favorito:", updateError);
          }          
          const msgIndex = selectedMessages.findIndex(m => m.id === msg.id);
          if (msgIndex > -1) {
            selectedMessages[msgIndex].starred_by = starredBy;
          }
        }        
        updateActionBar();
        setTimeout(() => {
          clearSelection();
        }, 300);        
      } catch (error) {
        console.error("Erro inesperado em actionStar:", error);
      }
    }
    /* =========================== ACTION COPY =========================== */
    function actionCopy() {
      if (selectedMessages.length !== 1) return;
      const msg = selectedMessages[0];
      copyMessageText(msg.message);
      clearSelection();
    }
    /* ========================= ACTION FORWARD ========================== */
    function actionForward() {
      if (selectedMessages.length === 0) return;
      messagesToForward = selectedMessages.map(msg => ({
        message: msg.message
      }));
      clearSelection();
      const messagesEl = document.getElementById("messages");
      const contactListEl = document.getElementById("contact-list");
      const contactTitle = document.getElementById("contact-title");
      const backBtn = document.getElementById("back-header");
      if (window.innerWidth <= 768) {
        messagesEl.style.display = 'none';
        contactListEl.style.display = 'block';
        contactTitle.style.display = 'block';
        backBtn.style.display = 'none';
      }
      console.log("Modo encaminhar: Selecione o contacto de destino na lista.");
    }
    /* ========================== ACTION DELETE ========================== */
    let confirmResolver = null;
    async function actionDelete() {
      if (!selectedMessages || selectedMessages.length === 0) return;
      const allMine = selectedMessages.every(m => String(m.n_int) === currentUserNint);
      const choice = await askConfirm(selectedMessages.length, allMine);
      if (choice === 'cancel') return;
      const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
      for (const msg of selectedMessages) {
        if (choice === 'todos') {
          if (String(msg.n_int) === currentUserNint) {
            await supabaseClient
              .from('chat_messages')
              .update({ 
              deleted_at: new Date().toISOString(),
              message: 'Mensagem apagada'
            })
              .eq('id', msg.id);
          }
        } 
        else if (choice === 'mim') {
          const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
          if (msgElement) msgElement.style.display = 'none';
        }
      }
      clearSelection();
    }
    function askConfirm(count, allMine) {
      const modal = document.getElementById('modal-confirm');
      if (modal) {
        const textElement = modal.querySelector('.confirm-text');
        if (textElement) {
          textElement.innerText = count === 1 ? 'Elimininar mensagem?' : `Elimininar ${count} mensagens?`;
        }
        const btnTodos = modal.querySelector('.btn-confirm-action');
        if (btnTodos) {
          btnTodos.style.display = allMine ? 'block' : 'none';
        }
        modal.style.display = 'flex';
      }
      return new Promise(resolve => {
        confirmResolver = resolve;
      });
    }
    function resConfirm(choice) {
      const modal = document.getElementById('modal-confirm');
      if (modal) modal.style.display = 'none'; 
      if (confirmResolver) {
        confirmResolver(choice);
        confirmResolver = null;
      }
    }
    /* =========================== ACTION EDIT =========================== */
    function actionEdit() {
      if (selectedMessages.length !== 1) return;
      const msg = selectedMessages[0];
      if (String(msg.n_int) !== currentUserNint) return;
      if (msg.deleted_at) return;
      currentEditingMessage = {
        id: msg.id,
        originalText: msg.message
      };
      document.getElementById('edit-text-preview').textContent = msg.message;
      document.getElementById('edit-bar').style.display = 'block';
      const inputEl = document.getElementById('chat-input');
      inputEl.value = msg.message;
      inputEl.focus();
      clearSelection();
    }
    function cancelEdit() {
      currentEditingMessage = null;
      document.getElementById('edit-bar').style.display = 'none';
      document.getElementById('chat-input').value = '';
    }
    /* =================== INITIALIZATION AND REALTIME =================== */
    document.addEventListener('DOMContentLoaded', async () => {
      loadCorpInfo();
      loadTheme();
      await loadContacts();
      updateUnreadBadges();
      const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
      supabaseClient.channel('chat_realtime')
        .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'chat_messages',
        filter: `corp_oper_nr=eq.${currentCorp}`
      }, async (payload) => {
        let msg = payload.new;
        if (msg.reply_to_message_id) {
          const { data: replyData } = await supabaseClient
          .from('chat_messages')
          .select('id, message, abv_name')
          .eq('id', msg.reply_to_message_id)
          .single();
          if (replyData) {
            msg.reply_to_message = replyData;
          }
        }   
        const involved = [msg.n_int, msg.recipient_nint].map(String);
        if (currentChat === 'geral' && msg.recipient_nint === 'geral') {
          addMessageToDOM(msg, 'geral');
          if (String(msg.n_int) !== currentUserNint && document.getElementById("messages")?.style.display !== 'none') {
            const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
            const geralContact = document.querySelector('.contact[data-nint="geral"]');
            const currentBadge = geralContact?.querySelector('.unread-badge');
            const badgeValue = currentBadge ? currentBadge.textContent : null;
            supabaseClient.from('chat_message_reads').insert({message_id: msg.id, n_int: currentUserNint, read_at: new Date().toISOString(), corp_oper_nr: currentCorp}).then(() => {
              if (badgeValue && geralContact) {
                setTimeout(() => {
                  let badge = geralContact.querySelector('.unread-badge');
                  if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'unread-badge';
                    geralContact.appendChild(badge);
                  }
                  badge.textContent = badgeValue;
                }, 100);
              }
            });
          }
        } else if (currentChat !== 'geral' && involved.includes(currentUserNint) && involved.includes(currentChat)) {
          addMessageToDOM(msg, currentChat);
          if (String(msg.recipient_nint) === currentUserNint) {
            setTimeout(() => sendReadReceipt(currentChat), 100);
          }
        }
        if (String(msg.n_int) !== currentUserNint) {
          updateUnreadBadges();
        }
      })
        .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'chat_messages',
        filter: `corp_oper_nr=eq.${currentCorp}`
      }, payload => {
        const msg = payload.new;
        if (msg.deleted_at) {
          const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
          if (msgElement) {
            msgElement.classList.add('deleted');
            const textContent = msgElement.querySelector('.msg-text-content');
            if (textContent) {
              textContent.innerHTML = '<span class="deleted-icon">üö´</span> Mensagem apagada';
            }
          }
        }
        if (msg.reactions !== undefined) {
          const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
          if (msgElement) {
            const oldReactions = msgElement.querySelector('.message-reactions');
            if (oldReactions) oldReactions.remove();
            const newReactionsHTML = renderReactions(msg.reactions, msg.id);            
            if (newReactionsHTML) {
              const textContent = msgElement.querySelector('.msg-text-content');
              if (textContent) {
                textContent.insertAdjacentHTML('afterend', newReactionsHTML);
              }
            }
          }
        }        
        if (msg.starred_by !== undefined) {
        const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
        if (msgElement) {
          const oldStar = msgElement.querySelector('.star-icon');
          if (oldStar) oldStar.remove();
          const isStarred = msg.starred_by && msg.starred_by.includes(currentUserNint);
          if (isStarred) {
            const textContent = msgElement.querySelector('.msg-text-content');
            if (textContent) {
              textContent.insertAdjacentHTML('afterend', 
                '<span class="star-icon" style="color: #ffd700; margin-left: 5px; font-size: 14px;">‚≠ê</span>'
              );
            }
          }
        }
      }
        if (msg.read_at && String(msg.n_int) === currentUserNint) {
          const checkEl = document.getElementById(`check-${msg.id}`);
          if (checkEl) {
            checkEl.classList.remove('sent', 'delivered');
            checkEl.classList.add('read');
            checkEl.textContent = 'done_all';
          }
        }
      }).subscribe();
      supabaseClient.channel('reads_realtime')
        .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'chat_message_reads',
        filter: `corp_oper_nr=eq.${currentCorp}`
      }, () => {
        updateUnreadBadges();
      }).subscribe();    
      const readReceiptChannel = supabaseClient.channel('read-receipts');
      readReceiptChannel.on('broadcast', {event: 'read'}, (payload) => {
        if (String(payload.payload.readerNint) === currentChat) {
          document.querySelectorAll('.status-checks').forEach(check => {
            if (!check.classList.contains('read')) {
              check.classList.remove('sent', 'delivered');
              check.classList.add('read');
              check.textContent = 'done_all';
            }
          });
        }
      }).subscribe();
      const typingChannel = supabaseClient.channel('typing-status', {config: {broadcast: {ack: true, self: false}}});
      typingChannel.on('broadcast', {event: 'typing'}, (payload) => {
        const data = payload.payload;
        if (currentChat !== 'geral' && String(data.nint) === currentChat) {
          const statusEl = document.getElementById("typing-status");
          statusEl.textContent = `${currentChatName} est√° a escrever...`;
          statusEl.style.display = data.isTyping ? 'block' : 'none';
          if (data.isTyping) scrollToBottom();
        }
      }).subscribe();
      window.readReceiptChannel = readReceiptChannel;
      const presenceChannel = supabaseClient.channel('presence-cb360', {
        config: {presence: {key: String(currentUserNint)}},
      });
      presenceChannel.on('presence', {event: 'sync'}, () => {
        const state = presenceChannel.presenceState();
        document.querySelectorAll('.status-dot').forEach(dot => dot.classList.remove('online'));
        Object.keys(state).forEach((nint) => {
          const dot = document.querySelector(`.contact[data-nint="${nint}"] .status-dot`);
          if (dot) dot.classList.add('online');
        if (currentChat !== 'geral' && String(nint) === currentChat) {
          document.querySelectorAll('.status-checks.sent').forEach(check => {
            check.classList.remove('sent');
            check.classList.add('delivered');
            check.textContent = 'done_all';
          });
        }
        });
      }).subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          await presenceChannel.track({
            online_at: new Date().toISOString(),
            nint: String(currentUserNint)
          });
        }
      });
      let typingTimer;
      const inputEl = document.getElementById("chat-input");
      inputEl.addEventListener('input', () => {
        if (currentChat === 'geral') return;
        typingChannel.send({type: 'broadcast', event: 'typing', payload: {nint: String(currentUserNint), isTyping: true}});
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          typingChannel.send({type: 'broadcast', event: 'typing', payload: {nint: String(currentUserNint), isTyping: false}});
        }, 2000);
      });    
      document.getElementById("chat-send-btn").onclick = () => sendMessage(); // ‚úÖ Chama sem passar evento
inputEl.onkeydown = e => {
  if (e.key === 'Enter') {
    e.preventDefault(); // ‚úÖ Previne quebra de linha
    sendMessage(); // ‚úÖ Chama sem passar evento
  }
};
      inputEl.addEventListener('focus', () => {
        if (currentChat !== 'geral') sendReadReceipt(currentChat);
      });
    });
    /* ======================= MESSAGE INTERACTION ======================= */
    function setupMessageInteraction(messageElement, messageData) {
      let pressTimer;
      let isLongPress = false;
      messageElement.addEventListener('touchstart', (e) => {
        isLongPress = false;
        pressTimer = setTimeout(() => {
          isLongPress = true;
          if (navigator.vibrate) navigator.vibrate(50);
          const menu = document.getElementById('reaction-menu');
          if (menu) menu.style.display = 'none';
          toggleMessageSelection(messageElement, messageData);
          if (selectedMessages.length === 1 && menu) {
            reactionTargetId = messageData.id;
            const scrollContainer = menu.querySelector('.emoji-scroll-container');
            if (scrollContainer) scrollContainer.scrollLeft = 0;
            menu.style.display = 'flex';
            const menuWidth = 215; 
            const menuHeight = 45;
            const rect = messageElement.getBoundingClientRect();
            let posX = rect.left + (rect.width / 2) - (menuWidth / 2);
            if (posX < 10) posX = 10;
            if (posX + menuWidth > window.innerWidth) {
              posX = window.innerWidth - menuWidth - 10;
            }
            let posY = rect.bottom + 10;
            if (posY + menuHeight > window.innerHeight - 60) {
              posY = rect.top - menuHeight - 10;
            }
            menu.style.left = posX + 'px';
            menu.style.top = posY + 'px';
          }
        }, 500);
      }, { passive: true });
      messageElement.addEventListener('touchend', () => clearTimeout(pressTimer));
      messageElement.addEventListener('touchmove', () => clearTimeout(pressTimer));
      messageElement.addEventListener('click', (e) => {
        const menu = document.getElementById('reaction-menu');
        if (selectedMessages.length > 0) {
          e.preventDefault();
          toggleMessageSelection(messageElement, messageData);
          if (menu) menu.style.display = 'none';
        }
      });
    }
    document.addEventListener('touchstart', (e) => {
      const menu = document.getElementById('reaction-menu');
      if (menu && menu.style.display === 'flex') {
        const clicouNoMenu = menu.contains(e.target);
        const clicouNaMensagem = e.target.closest('.message');
        const clicouNaBarra = e.target.closest('#action-bar');
        if (clicouNaBarra) {
          menu.style.display = 'none';
          return; 
        }
        if (!clicouNoMenu && !clicouNaMensagem) {
          menu.style.display = 'none';
      clearSelection();
        }
      }
    }, {passive: true});
    function clearSelection() {
      selectedMessages = [];
      document.querySelectorAll('.message.selected').forEach(el => {
        el.classList.remove('selected');
      });      
      const actionBar = document.getElementById('action-bar');
      if (actionBar) actionBar.classList.remove('show');      
      const menu = document.getElementById('reaction-menu');
      if (menu) menu.style.display = 'none';
      const starBtn = document.getElementById('action-star');
      if (starBtn) {
        const starIcon = starBtn.querySelector('.material-icons');
        if (starIcon) {
          starIcon.textContent = 'star_border';
        }
      }      
      reactionTargetId = null;
    }
    /* ======================== HANDLE REACTION CLICK ======================== */
    async function handleReactionClick(emoji) {
      if (!reactionTargetId) {
        console.warn("Nenhuma mensagem selecionada para reagir.");
        return;
      }
      const targetId = reactionTargetId;
      const menu = document.getElementById('reaction-menu');
      if (menu) menu.style.display = 'none';
      clearSelection();
      try {
        const { data: msg, error: fetchError } = await supabaseClient
        .from('chat_messages')
        .select('reactions')
        .eq('id', targetId)
        .single();
        if (fetchError) {
          console.error("Erro ao ler do Supabase:", fetchError);
          return;
        }
        let currentReactions = msg.reactions || {};
        if (currentReactions[currentUserNint] === emoji) {
          delete currentReactions[currentUserNint];
        } else {
          currentReactions[currentUserNint] = emoji;
        }
        const { error: updateError } = await supabaseClient
        .from('chat_messages')
        .update({ reactions: currentReactions })
        .eq('id', targetId);
        if (updateError) {
          console.error("Erro ao gravar rea√ß√£o:", updateError);
        } else {
          
        }
      } catch (err) {
        console.error("Erro inesperado:", err);
      }
    }
    function openFullEmojiPicker() {
      const menu = document.getElementById('reaction-menu');
      const pickerContainer = document.getElementById('full-emoji-picker-container');
      const picker = pickerContainer.querySelector('emoji-picker');    
      if (menu) menu.style.display = 'none';
      pickerContainer.style.display = 'block';
      if (!picker.dataset.listenerSet) {
        picker.addEventListener('emoji-click', event => {
          handleReactionClick(event.detail.unicode);
          pickerContainer.style.display = 'none';
        });
        picker.dataset.listenerSet = "true";
      }
    }
    document.addEventListener('touchstart', (e) => {
      const menu = document.getElementById('reaction-menu');
      const picker = document.getElementById('full-emoji-picker-container');
      if (menu && menu.style.display === 'flex') {
        if (!menu.contains(e.target) && !picker.contains(e.target)) {
          setTimeout(() => {
            if (selectedMessages.length !== 1) {
              menu.style.display = 'none';
              picker.style.display = 'none';
            }
          }, 50);
        }
      }
    }, {passive: true});    
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('reaction-menu');
      const picker = document.getElementById('full-emoji-picker-container');
      
      if (menu && !menu.contains(e.target) && !picker.contains(e.target) && selectedMessages.length === 0) {
        menu.style.display = 'none';
        picker.style.display = 'none';
      }
    });
    /* ======================== REPLY TO MESSAGE ========================= */
    function replyToMessage(messageId, senderName, messageText) {
      currentReplyToMessage = {
        id: messageId,
        name: senderName,
        text: messageText
      };
      document.getElementById('reply-to-name').textContent = senderName;
      document.getElementById('reply-to-text').textContent = messageText;
      document.getElementById('reply-bar').style.display = 'block';
      document.getElementById('chat-input').focus();      
    }
    /* ========================== CANCEL REPLY =========================== */
    function cancelReply() {
      currentReplyToMessage = null;
      document.getElementById('reply-bar').style.display = 'none';
    }
    /* ======================== COPY MESSAGE TEXT ======================== */
    function copyMessageText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          alert('‚úÖ Texto copiado!');
        }).catch(() => {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-9999px';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        alert('‚úÖ Texto copiado!');
      } catch (err) {
        alert('‚ùå Erro ao copiar texto');
      }
      document.body.removeChild(textArea);
    }
    /* ========================= DELETE MESSAGE ========================== */
    async function deleteMessage(messageId) {
      const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
      const {error} = await supabaseClient
      .from('chat_messages')
      .update({ 
        deleted_at: new Date().toISOString(),
        message: 'Mensagem apagada'
      })
      .eq('id', messageId)
      .eq('n_int', currentUserNint)
      .eq('corp_oper_nr', currentCorp);
      if (error) {
        console.error('Erro ao apagar:', error);
      } else {
        const msgElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (msgElement) {
          msgElement.classList.add('deleted');
          const textContent = msgElement.querySelector('.msg-text-content');
          if (textContent) {
            textContent.innerHTML = '<span class="deleted-icon">üö´</span> Mensagem apagada';
          }
        }
      }
    }
    /* ======================== SCROLL TO MESSAGE ======================== */
    function scrollToMessage(messageId) {
      const msgElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (msgElement) {
        msgElement.scrollIntoView({behavior: 'smooth', block: 'center'});
        msgElement.style.background = 'rgba(188, 217, 255, 0.5)';
        setTimeout(() => {
          msgElement.style.background = '';
        }, 1500);
      }
    }
    /* ======================= SEND READ RECIPIENT ======================= */
    async function sendReadReceipt(toNint) {
      if (toNint === 'geral' || !toNint) return;    
      const currentCorp = localStorage.getItem("currentCorpOperNr") || "0805";
      const {error} = await supabaseClient
        .from('chat_messages')
        .update({read_at: new Date().toISOString()})
        .eq('n_int', toNint)
        .eq('recipient_nint', currentUserNint)
        .eq('corp_oper_nr', currentCorp)
        .is('read_at', null);
      if (!error && window.readReceiptChannel) {
        window.readReceiptChannel.send({
          type: 'broadcast',
          event: 'read',
          payload: {readerNint: String(currentUserNint)}
        });
      }
    }
  </script>
</body>
</html> 































