<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CB360 Mobile">
  <script>
    (function () {
      try {
        if (localStorage.getItem('sgo-theme') === 'dark') {
          document.documentElement.classList.add('dark-mode');
        }
      } catch (e) {}
    })();
  </script>
  <title>CB360 Mobile - Chat Interno</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
  <style>
    /* ==================== BODY ==================== */
    html {background-color: #d32f2f !important; scrollbar-width: none; -ms-overflow-style: none;}
    * {margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent !important; -webkit-touch-callout: none !important;}
    body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); min-height: 100vh; user-select: none;
          transition: all 0.3s ease; display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden;}
    /* ============= DARK MODE OPTIONS ============== */
    .dark-mode {background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #fff;}
    .dark-mode .main-content {background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);}
    .dark-mode .msg-sender-name {color: #ffffff !important;}
    .dark-mode #contact-list::-webkit-scrollbar-thumb, .dark-mode #chat-messages::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.15);}
    .dark-mode #contact-list::-webkit-scrollbar-thumb:hover, .dark-mode #chat-messages::-webkit-scrollbar-thumb:hover {background: rgba(255,255, 255, 0.3);}
    .dark-mode .contact-id-info {color: #ddd;}
    .dark-mode .contact {background: rgba(255, 255, 255, 0.08); color: #fff; border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);}
    .dark-mode .contact:hover {background: rgba(255, 255, 255, 0.12);}
    .dark-mode .unread-badge {background-color: #f44336; box-shadow: 0 0 8px rgba(244, 67, 54, 0.4);}
    .dark-mode .chat-input-bar .input-wrapper {background: rgba(255, 255, 255, 0.15); transition: bottom 0.2s ease-in-out;}    
    .dark-mode .chat-input-bar {background: transparent;}
    .dark-mode .chat-input-bar button {color: #ddd;}
    .dark-mode .chat-input-bar input {background: transparent; border: none; color: #fff;}
    .dark-mode .chat-id-info {color: #f9a825; background: rgba(255, 255, 255, 0.10); border-left: 4px solid #f9a825;}
    .dark-mode #back-header {color: #ddd;}
    .dark-mode .pinned-banner {background: rgba(68, 68, 68, 0.95); border-bottom: 1px solid #555; color: #f9a825;}
    .dark-mode #messages div[style*="color: #888"] {color: #aaa !important;}
    .dark-mode .date-divider span {background: rgba(255, 255, 255, 0.10); color: #ddd;}
    .dark-mode .message.self {background: #005c4b; color: #e9edef;}
    .dark-mode .message.self::after {border-left-color: #005c4b;}    
    .dark-mode .message.other {background: #386580; color: #e9edef;}
    .dark-mode .message.other::after {border-right-color: #386580;}
    .dark-mode .message.other .msg-meta {color: rgba(255, 255, 255, 0.5) !important;}
    .dark-mode .typing-indicator {background: rgba(40, 40, 40, 0.50); color: #bbb !important; border: 1px solid rgba(255,255,255,0.1);}
    .dark-mode .action-bar-counter {color: #fff;}
    .dark-mode .action-bar {background: #2d2d2d; border-bottom-color: #f9a825;}
    .dark-mode .action-bar-close {color: #f9a825;}
    .dark-mode .action-btn {color: #f9a825;}
    .dark-mode .action-btn:active {background: rgba(249, 168, 37, 0.1);}
    .dark-mode {--selection-color: #2b5278; }
    .dark-mode .message.selected {color: #fff !important;}
    .dark-mode .message.selected .status-checks {color: rgba(255,255,255,0.7) !important;}
    .dark-mode .reply-bar {background: rgba(45, 45, 45, 0.95); border-top: 1px solid #555;}
    .dark-mode .reply-icon {color: #f9a825;}
    .dark-mode .reply-to-name {color: #f9a825;}
    .dark-mode .reply-to-text {color: #aaa;}
    .dark-mode .reply-preview {background: rgba(255, 255, 255, 0.1); border-left-color: #f9a825;}
    .dark-mode .reply-preview-name {color: #f9a825;}
    .dark-mode .reply-preview-text {color: #aaa;}
    .dark-mode .message.deleted .msg-text-content {color: #aaa !important;}
    .dark-mode .edit-bar {background: rgba(249, 168, 37, 0.2);border-top-color: #f9a825;}
    .dark-mode .edit-icon {color: #ffa726;}
    .dark-mode .edit-label {color: #ffb74d;}
    .dark-mode .edit-text-preview {color: #ffa726;}
    .dark-mode .edit-cancel {color: #ffb74d;}
    .dark-mode .reaction-menu {background: #232d36; box-shadow: 0 4px 20px rgba(0,0,0,0.4);}
    .dark-mode .plus-button {background-color: #3b4a54; box-shadow: -8px 0 12px #232d36;}
    .dark-mode .plus-button .material-icons {color: #aebac1;}
    .dark-mode .reaction-badge {background: #333; border: 1px solid #555;}
    .dark-mode .reaction-badge.my-reaction {background: #f9a825; border-color: #fbc02d; color: #fff;}
    .dark-mode .reaction-count {color: #ddd;} 
    .dark-mode .reaction-badge:hover {box-shadow: 0 2px 5px rgba(0, 0, 0, 0.6);}
    .dark-mode .custom-confirm-card {background: #2b2b2b; color: white;}
    .dark-mode .confirm-text {color: #eee;}
    .dark-mode .btn-confirm-action:active {background-color: rgba(255, 255, 255, 0.05);}
    .dark-mode .draft-preview {color: #aaa !important;}
    .dark-mode .attach-modal {background: rgba(0,0,0,0.92);}
    .dark-mode .attach-card {background: #2b2b2b; color: #fff; box-shadow: 0 10px 40px rgba(0,0,0,0.6);}
    .dark-mode .attach-header {color: #f9a825; border-bottom: 1px solid rgba(255,255,255,0.08);}
    .dark-mode .attach-x {color: #ddd;}
    .dark-mode .attach-x:hover {color: #fff; background: rgba(255,255,255,0.08); border-radius: 6px;}
    .dark-mode .attach-preview {background: #000;}
    .dark-mode .attach-preview img {background: #000;}
    .dark-mode #attach-caption {background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: #fff;}
    .dark-mode #attach-caption::placeholder {color: #aaa;}
    .dark-mode #attach-send {background: #f9a825; color: #1a1a1a;}
    .dark-mode #attach-send:hover {background: #ffb300;}
    .dark-mode #attach-send:disabled {opacity: 0.6;}
    .dark-mode .attach-loading {background: rgba(0,0,0,0.7); color: #fff;}
    .dark-mode .attach-file-card {background: rgba(255,255,255,0.10); border: 1px solid rgba(255,255,255,0.12);}
    .dark-mode .attach-file-card .material-icons {color: #f9a825;}
    .dark-mode .attach-file-name {color: #fff;}
    .dark-mode .attach-file-type {color: #bbb;}
    /* ==================== PWA KEYBOARD FIX ==================== */
    :root {--kb: 0px; --footer-h: 60px; --gap: 10px; --safe: env(safe-area-inset-bottom, 0px);}
    .message-container{overflow-y:auto; -webkit-overflow-scrolling: touch; padding-bottom: calc(var(--footer-h) + 80px + var(--kb) + var(--safe));}
    .message-container.keyboard-active{scroll-behavior: auto;}
    .chat-input-bar{position: fixed; left:0; right:0; bottom: calc(var(--footer-h) + var(--kb) + var(--gap) + var(--safe)); z-index: 10001; transition: bottom 0.12s ease;}
    .chat-input-bar.keyboard-active{box-shadow: 0 -4px 12px rgba(0,0,0,0.12); background: rgba(255,255,255,0.98);}
    .dark-mode .chat-input-bar.keyboard-active{background: rgba(0,0,0,0.15);}
    body.keyboard-open{overflow:hidden; touch-action:none;}
    @supports (-webkit-touch-callout: none) {body.keyboard-open {position: fixed; width: 100%;}}
    body.keyboard-open #full-emoji-picker-container{display:none !important;}
    /* ============= LIGHT MODE OPTIONS ============= */
    .header {background-color: #d32f2f; color: white; padding: 20px 15px; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); border-bottom: 2px solid #c62828; position: fixed;
             top: 0; left: 0; right: 0; z-index: 1000;}
    .header h1 {margin: 0; font-size: 1.5em; font-weight: bold;}
    .header-subtitle {margin-top: 5px; font-size: 12px; opacity: 0.9;}
    .header-logo {position: absolute; left: 10px; top: 50%; transform: translateY(-50%); height: 80px; width: auto; border-radius: 8px; z-index: 1001;}
    .footer {background-color: #d32f2f; color: white; padding: 8px 15px; text-align: center; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3); border-top: 2px solid #c62828; position: fixed;
             bottom: 0; left: 0; right: 0; z-index: 1000;}
    .footer-content {max-width: 400px; margin: 0 auto;}
    .powered-by {font-size: 13px; font-weight: bold; margin-bottom: 3px;}
    .footer-year {font-size: 10px; opacity: 0.8; color: #ffcdd2;}
    .footer strong {color: #ffebee;}
    .main-content {flex: 1 1 auto; max-height: calc(100dvh - 0px - 0px); display: flex; flex-direction: column; overflow-y: auto; padding-top: 100px; padding-bottom: 0px;}
    .contact-id-info {padding: 10px 20px 10px 20px; font-size: 20px; font-weight: bold; color: #444;}
    #contact-list {display: flex; flex-direction: column; padding: 0 20px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;}
    .contact {display: flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 12px; background: rgba(0, 0, 0, 0.15); color: #444; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer;
              transition: background 0.2s, transform 0.2s; margin-bottom: 5px;}
    .contact:hover {background: #ddd;}
    .contact-avatar {width: 40px; height: 40px; border-radius: 50%; border: 2px solid #666; background: #d32f2f; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;
                     font-size: 18px; text-transform: uppercase; overflow: visible; position: relative;}
    .contact-avatar img {width: 100%; height: 100%; object-fit: cover; border-radius: 50%;}
    .status-dot {width: 13px; height: 13px; background-color: #bbb; border-radius: 50%; border: 2.5px solid white; position: absolute; bottom: -1px; right: -1px; transition: all 0.3s ease; z-index: 2;}
    .status-dot.online {background-color: #00ff00; box-shadow: 0 0 8px #00ff00, 0 0 12px rgba(0, 255, 0, 0.5); animation: pulse-green 2s infinite;}    
    .contact-info {display: flex; flex-direction: column; justify-content: center;}
    .contact-info .nint {font-size: 14px; opacity: 0.6;}
    .contact-info .name {font-size: 14px; font-weight: bold;}
    .unread-badge {background-color: #d32f2f;color: white; font-size: 13px; font-weight: bold; padding: 0 6px; min-width: 30px; height: 20px; line-height: 20px; border-radius: 10px; display: flex;
                   align-items: center; justify-content: center; margin-left: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
    .back-header {font-size: 20px; color: #444; text-align: left; display: flex; align-items: center; height: 40px; margin: 2px 0 0 0;}
    #back-header {position: relative; padding: 0 5px; z-index: 1001; color: #444;}
    .back-text {font-weight: bold !important;}
    .back-header.show {opacity: 1; pointer-events: auto;}   
    .back-arrow {font-size: 25px !important; margin: 4px 0 0 0px; font-weight: bold !important;} 
    .back-header:hover {opacity: 0.75;}
    .chat-id-info {padding: 5px 20px; font-size: 15px; font-weight: bold; color: #d32f2f; background: rgba(0, 0, 0, 0.10); border-left: 4px solid #d32f2f;}    
    .message-container {display: none; flex-direction: column; gap: 0; padding: 15px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 80px; max-height: calc(100dvh - 220px);
                        transition: margin-bottom 0.3s cubic-bezier(0.25, 1, 0.5, 1); transition: max-height 0.3s ease, margin-bottom 0.3s ease;}
    .pinned-banner {background: rgba(255, 248, 225, 0.95); border-bottom: 1px solid #ffe082; padding: 10px 15px; display: flex; align-items: flex-start; gap: 10px; font-size: 12px; color: #856404;
                    position: sticky; top: 0; z-index: 10; backdrop-filter: blur(5px); max-height: 100px; overflow-y: auto;}
    .pinned-text {white-space: normal; word-wrap: break-word; flex: 1; font-weight: 500; line-height: 1.4;}
     #messages {display: none;}
    .message {max-width: 75%; padding: 10px; border-radius: 7.5px; margin-bottom: 4px; position: relative; font-size: 14.5px; line-height: 1.5; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); 
              word-wrap: break-word;}
    .msg-sender-name {font-size: 12px; font-weight: bold; color: #d32f2f; margin-bottom: 2px;}
    .message.self {align-self: flex-end; background: #6b9e59; color: #fff; margin-right: 10px; border-top-right-radius: 0;}
    .message.self::after {content: ""; position: absolute; right: -10px; top: 0; width: 0; height: 0; border-left: 10px solid #6b9e59; border-bottom: 10px solid transparent;}
    .message.other {align-self: flex-start; background: #ddd; color: #000; margin-left: 10px; border-top-left-radius: 0;}
    .message.other::after {content: ""; position: absolute; left: -10px; top: 0; width: 0; height: 0; border-right: 10px solid #ddd; border-bottom: 10px solid transparent;}
    .msg-meta {float: right; margin: 10px 0px 0px 25px; font-size: 11px; color: rgba(255, 255, 255, 0.6); white-space: nowrap; display: flex; align-items: center;}
    .message.other .msg-meta {color: rgba(0, 0, 0, 0.45);}
    .status-checks {font-size: 16px !important; margin-left: 5px; line-height: 1; vertical-align: middle; display: inline-flex;}
    .status-checks.sent, .status-checks.delivered {color: rgba(255, 255, 255, 0.5) !important;}
    .status-checks.read {color: #07e5f5 !important;}
    .date-divider {text-align: center; margin: 20px 0 10px 0; clear: both; width: 100%; display: flex; justify-content: center;}
    .date-divider span {background: rgba(0, 0, 0, 0.05); color: #555; padding: 5px 15px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;}
    .message.other .status-checks {display: none;}
    .status-checks.read {color: #07e5f5 !important;}
    .chat-input-bar {position: fixed; align-items: flex-end; background: transparent; display: none; padding: 8px 10px; bottom: 40px; gap: 8px;  z-index: 1001; transition: bottom 0.3s cubic-bezier(0.25, 1, 0.5, 1);
                     box-sizing: border-box;  width: 100%; max-width: 100%;}    
    .input-wrapper {display: flex; flex: 1; min-width: 0; align-items: flex-end; flex; align-items: center; background: #ccc; border-radius: 25px; padding: 5px 12px; gap: 2px;  min-height: 40px;
                    transition: all 0.3s ease;}
    #chat-input {color: #fff; flex: 1; min-width: 0; border: none; background: transparent; outline: none; resize: none; padding: 10px 5px; font-size: 15px; max-height: 100px; overflow-y: auto;
                 font-family: inherit; &::-webkit-scrollbar {width: 0px; background: transparent;} scrollbar-width: none; -ms-overflow-style: none;}
    .chat-input-bar button {height: 40px; width: 40px; padding: 4px; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; background: transparent;
                            color: #54656f; transition: transform 0.1s ease, background 0.2s; flex-shrink: 0;}  
    #chat-send-btn {background: #00a884; color: white; border-radius: 50%; width: 50px; height: 50px; flex-shrink: 0;}
    #send-icon {display: inline-block;transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s;}
    .icon-spin {transform: rotate(360deg) scale(0.5); opacity: 0;}
    #camera-btn {display: flex; width: 30px; opacity: 1; overflow: hidden; transition: width 0.3s ease, opacity 0.2s ease, margin 0.3s ease;}
    .chat-input-bar.typing #camera-btn {width: 0; opacity: 0; margin: 0; padding: 0; pointer-events: none;}
    #contact-list::-webkit-scrollbar, #messages::-webkit-scrollbar {width: 6px;}
    #contact-list::-webkit-scrollbar-track, #messages::-webkit-scrollbar-track {background: transparent;}
    #contact-list::-webkit-scrollbar-thumb, #chat-messages::-webkit-scrollbar-thumb {background: rgba(0, 0, 0, 0.15); border-radius: 10px; transition: background 0.3s ease;}
    #contact-list::-webkit-scrollbar-thumb:hover, #chat-messages::-webkit-scrollbar-thumb:hover {background: rgba(0, 0, 0, 0.3);}
    .typing-indicator {position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #888; font-style: italic; background: rgba(255, 255, 255, 0.95); padding: 6px 16px;
                       border-radius: 20px; z-index: 1100; display: none; pointer-events: none; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: opacity 0.2s ease;
                       white-space: nowrap; max-width: 80%;}
    .action-bar {position: fixed; top: 100px; left: 0; right: 0; background: #f0f0f0; border-bottom: 2px solid #d32f2f; padding: 8px 15px; display: none; align-items: center; gap: 15px; z-index: 2000;
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); transform: translateY(-100%); transition: transform 0.3s ease;}
    .action-bar.show {display: flex; transform: translateY(0); animation: slideDown 0.3s ease;}    
    .action-bar-close {background: none; border: none; color: #d32f2f; font-size: 24px; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;}
    .action-bar-close:active {transform: scale(0.9);}
    .action-bar-counter {flex: 1; font-size: 15px; font-weight: 500; color: #333;}
    .action-bar-actions {display: flex; gap: 8px; align-items: center;}
    .action-btn {background: none; border: none; color: #d32f2f; font-size: 22px; cursor: pointer; padding: 0px; display: flex; align-items: center; justify-content: center; border-radius: 50%; 
                 transition: all 0.2s; min-width: 35px; min-height: 35px;}
    .action-btn:active {transform: scale(0.9); background: rgba(211, 47, 47, 0.1);}
    .action-btn.disabled {opacity: 0.3; pointer-events: none;}
    :root {--selection-color: #bcd9ff;}
    .message.selected {background-color: var(--selection-color) !important; position: relative; box-shadow: none !important;}
    .message.self.selected::after {border-left-color: var(--selection-color) !important; filter: none !important; border-right-color: transparent !important;}
    .message.other.selected::after {border-right-color: var(--selection-color) !important; filter: none !important; border-left-color: transparent !important;}
    .message.selected {color: #000 !important;}.message.selected .status-checks {color: rgba(0,0,0,0.5) !important;}    
    .messages-with-action-bar {margin-top: 60px;}
    .message.selecting {animation: pulse-select 0.5s;}
    .message.highlighted {animation: highlight-fade 1.5s ease-out;}
    .message.deleted {opacity: 0.6; font-style: italic;}
    .message.deleted .msg-text-content {color: #888 !important; display: flex; align-items: center; gap: 6px;}
    .deleted-icon {font-size: 16px; opacity: 0.7;}
    .message.deleted .msg-meta {opacity: 0.5;}
    .message.is-forwarded::before{content: "forward"; font-family: "Material Symbols Outlined"; font-size: 16px; opacity: 0.6; position: absolute; left: -22px; top: 50%; pointer-events: none;
                                  transform: translateY(-50%); user-select: none; line-height: 1; direction: ltr;}
    .edit-bar {position: fixed; bottom: 100px; left: 0; right: 0; background: rgba(255, 235, 59, 0.95); border-top: 2px solid #f9a825; padding: 10px 15px; z-index: 1002; display: none;
               box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px);}
    .edit-bar-content {display: flex; align-items: center; gap: 10px;}
    .edit-icon {font-size: 20px; color: #f57c00;}
    .edit-info {flex: 1; min-width: 0;}
    .edit-label {font-size: 12px; font-weight: bold; color: #e65100; margin-bottom: 2px;}
    .edit-text-preview {font-size: 13px; color: #f57c00; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}    
    .edit-cancel {background: none; border: none; color: #e65100; font-size: 20px; cursor: pointer; padding: 5px; line-height: 1;}    
    .edit-cancel:active {transform: scale(0.9);}   
    .message-edited-tag {font-size: 10px; color: rgba(255, 255, 255, 0.5); font-style: italic; margin-left: 5px;}
    .message.other .message-edited-tag {color: rgba(0, 0, 0, 0.4);}
    .chat-img{max-width: 230px; width: 100%; height: auto; border-radius: 10px; display: block; cursor: pointer; 
              -webkit-touch-callout: none !important; -webkit-user-select: none !important; -moz-user-select: none !important; 
              -ms-user-select: none !important; user-select: none !important; pointer-events: auto; -webkit-user-drag: none !important;}
    .img-caption{line-height: 1.35; opacity: 0.95; word-wrap: break-word;}
    .reply-bar {position: fixed; bottom: 100px; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); border-top: 1px solid #ddd; padding: 10px 15px; z-index: 5000; display: none;
                box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px);}
    .reply-bar-content {display: flex; align-items: center; gap: 10px;}
    .reply-icon {font-size: 20px; color: #d32f2f;}
    .reply-info {flex: 1; min-width: 0;}
    .reply-to-name {font-size: 12px; font-weight: bold; color: #d32f2f; margin-bottom: 2px;}
    .reply-to-text {font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .reply-cancel {background: none; border: none; color: #888; font-size: 20px; cursor: pointer; padding: 5px; line-height: 1;}
    .reply-cancel:active {transform: scale(0.9);}
    .reply-preview {background: rgba(0, 0, 0, 0.08); border-left: 3px solid #d32f2f; padding: 6px 10px; margin-bottom: 6px; border-radius: 4px; font-size: 12px; cursor: pointer;}
    .reply-preview:active {opacity: 0.7;}
    .reply-preview-name {font-weight: bold; color: #d32f2f; margin-bottom: 2px;}
    .reply-preview-text {color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;}
    .reaction-menu {display: none; position: fixed; z-index: 10000; background: #fff; border-radius: 30px; padding: 3px 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); align-items: center;
                    justify-content: space-between; animation: popScale 0.1s ease-out; width: 215px;}
    .emoji-scroll-container {display: flex; gap: 5px; overflow-x: auto; padding-right: 8px; scrollbar-width: none; -ms-overflow-style: none; flex: 1;}
    .emoji-scroll-container::-webkit-scrollbar {display: none;}
    .reaction-emoji-container {font-size: 25px; cursor: pointer; margin: 0 0 5px 0; flex-shrink: 0; transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);}
    .plus-button {display: flex !important; align-items: center; justify-content: center; width: 28px; height: 28px; background-color: #f0f2f5; border-radius: 50%; cursor: pointer; flex-shrink: 0;
                  margin-left: 5px; box-shadow: -8px 0 12px #fff;}
    .plus-button .material-icons {font-size: 20px; color: #667781;}
    .message-reactions {position: absolute; bottom: -12px; right: 10px; display: flex; flex-wrap: wrap; gap: 4px; z-index: 5; pointer-events: all;}
    .reaction-badge {display: inline-flex; align-items: center; justify-content: center; background: #f0f0f0; border: 1px solid #ccc; border-radius: 20px; height: 21px; width: 21px; padding: 0 5px; 
                     box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer; flex-shrink: 0;}
    .reaction-badge.my-reaction  {background: #ffd54f; border-color: #ffb300;}
    .reaction-badge.my-reaction .reaction-count {color: #d32f2f; font-weight: 700;}
    .reaction-emoji {font-size: 12px; line-height: 1; display: flex; align-items: center; justify-content: center;}
    .reaction-count {font-size: 11px; font-weight: 700; margin-left: 2px; color: #444;}    
    .reaction-badge:hover {transform: scale(1.1); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.18);}
    .reaction-badge:active {transform: scale(0.95);}
    .thumb-emoji {margin-bottom: 5px;}
    .msg-meta {position: relative; z-index: 1;}
    .message:has(.reaction-badge) {padding-bottom: 8px; position: relative;}
    .reaction-badge:has(.reaction-count) {min-width: 35px; padding: 0 8px;}
    .message.self:has(.reaction-badge) {margin-bottom:15px;}
    .custom-confirm-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;}
    .custom-confirm-card {background: white; padding: 24px; border-radius: 15px; width: 85%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);}
    .confirm-text {margin-bottom: 30px; font-size: 14px; color: #333;}
    .confirm-buttons-stack {display: flex; flex-direction: column; gap: 8px; width: 100%;}
    .btn-confirm-action {background: none; border: none; padding: 12px 0; text-align: right; color: #55cf29; font-size: 16px; font-weight: 500; cursor: pointer; width: 100%; display: block;}
    .btn-confirm-cancel {background: none; border: none; padding: 12px 0; text-align: right; color: #55cf29; font-size: 16px; font-weight: 500; cursor: pointer  width: 100%; margin-top: 10px;}
    .btn-confirm-action:active, .btn-confirm-cancel:active {background-color: rgba(0, 0, 0, 0.05);}
    #full-emoji-picker-container {display: none; position: fixed; bottom: 0; width: 100%; height: 300px; z-index: 10001; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); overflow: hidden; 
                                  animation: slideUp 0.3s ease-out; transition: opacity 0.2s ease-in-out;}    
    emoji-picker {width: 100%; height: 100%;}
    .draft-preview {color: #444 !important; font-size: 0.85em; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;}    
    .audio-bubble {display: flex; align-items: center; gap: 12px; padding: 6px 10px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(16px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.2);
                   border-radius: 10px; width: 200px; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3), 0 4px 16px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); position: relative; top: 5px;
                   transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);}
    .audio-play-btn {width: 35px; height: 35px; background: linear-gradient(135deg, #34b7f1 0%, #2196F3 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;
                     cursor: pointer; flex-shrink: 0; box-shadow: 0 4px 12px rgba(52, 183, 241, 0.5), 0 2px 6px rgba(52, 183, 241, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.25); position: relative;
                     transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);}
    .audio-play-btn::after {content: ''; position: absolute; inset: -3px; border-radius: 50%; background: radial-gradient(circle, rgba(52, 183, 241, 0.4), transparent 70%); opacity: 0;
                            transition: opacity 0.25s ease;}
    .audio-play-btn:hover {transform: scale(1.12); box-shadow: 0 6px 18px rgba(52, 183, 241, 0.6), 0 3px 10px rgba(52, 183, 241, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);}
    .audio-play-btn:hover::after {opacity: 1;}
    .audio-play-btn:active {transform: scale(0.95);}
    .audio-play-btn .material-icons {font-size: 24px; filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));}
    .audio-bubble.playing .audio-play-btn {animation: gentle-pulse 2s ease-in-out infinite;}
    .audio-progress-container {flex-grow: 1; display: flex; flex-direction: column; gap: 7px;}
    .audio-progress-bar {width: 100%; height: 5px; background: rgba(0, 0, 0, 0.15); border-radius: 999px; overflow: hidden; position: relative; cursor: pointer; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
                         transition: all 0.2s ease;}
    .audio-progress-bar:hover {height: 6px; background: rgba(0, 0, 0, 0.18);}
    .audio-progress-fill {height: 100%; width: 0%; background: linear-gradient(90deg, #34b7f1 0%, #2196F3 100%); border-radius: 999px; transition: width 0.1s linear; position: relative;
                          box-shadow: 0 0 8px rgba(52, 183, 241, 0.8), 0 0 4px rgba(52, 183, 241, 0.6);}
    .audio-progress-fill::after {content: ''; position: absolute; right: -1px; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; background: white; border-radius: 50%; opacity: 0;
                                 box-shadow: 0 2px 6px rgba(52, 183, 241, 0.5), 0 0 0 2px #34b7f1; transition: opacity 0.2s ease;}
    .audio-progress-bar:hover .audio-progress-fill::after {opacity: 1;}
    .audio-info {display: flex; justify-content: space-between; align-items: center;}
    .audio-time {font-size: 11px; font-weight: 600; opacity: 0.8; color: #fff; letter-spacing: 0.4px; font-variant-numeric: tabular-nums; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);}
    .audio-bubble.loading .audio-progress-fill {background: linear-gradient(90deg, rgba(52, 183, 241, 0.3) 0%, rgba(52, 183, 241, 0.7) 50%, rgba(52, 183, 241, 0.3) 100%); background-size: 200% 100%;
                                                animation: shimmer 1.5s ease-in-out infinite;}
    .audio-bubble.dark {background: rgba(20, 20, 25, 0.85); border-color: rgba(255, 255, 255, 0.08); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 4px 16px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);}
    .audio-bubble.dark:hover {background: rgba(25, 25, 30, 0.9);}
    .audio-bubble.dark .audio-progress-bar {background: rgba(255, 255, 255, 0.08);}
    .audio-bubble.dark .audio-time {color: rgba(255, 255, 255, 0.9);}
    .attach-modal{position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999999; display: none; align-items: center; justify-content: center;}
    .attach-card{background:#fff; width:min(500px,95vw); border-radius:16px; overflow:hidden;}
    .attach-header{display:flex;justify-content:space-between;align-items:center; padding:10px 12px;font-weight:700;}
    .attach-x{border:none;background:transparent;font-size:18px;padding:8px 10px;}
    .attach-preview{position:relative;background:#000;min-height:240px;display:flex;align-items:center;justify-content:center;}
    .attach-preview img{max-width:100%;max-height:65vh;object-fit:contain;}
    .attach-footer{display:flex;gap:8px;padding:12px;}
    #attach-caption{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;}
    #attach-send{background:#00a884;color:#fff;border:none;border-radius:8px;padding:0 15px;font-weight:700;}
    .attach-loading{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);color:#fff;font-weight:700;}
    .attach-file-card{display:flex; align-items:center; gap:12px; padding:14px; border-radius:12px; background: rgba(255,255,255,0.08); color:#fff; max-width: 90%;}
    .attach-file-card .material-icons{font-size: 32px;}
    .attach-file-meta{overflow:hidden;}
    .attach-file-name{font-size:14px; font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .attach-file-type{font-size:12px; opacity:0.8;}
    .file-caption{margin-top: 6px; font-size: 12px; opacity: 0.85; line-height: 1.2;}
    .attach-grid{width: 100%; max-height: 65vh; display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 6px; padding: 10px; box-sizing: border-box;}
    .attach-grid-cell{position:relative; background:#111; border-radius:12px; overflow:hidden; min-height:120px; cursor:pointer;}
    .attach-grid-cell img{width: 100%; height: 100%; object-fit: cover; display :block;}
    .attach-grid-more{position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.55); color: #fff; 
                      font-weight: 800; font-size: 26px;}
    .attach-viewer{position: absolute; inset: 0; background: rgba(0,0,0,0.95); display: flex; align-items: center; justify-content: center; z-index: 9999999;}
    .attach-viewer-img{max-width: 96%; max-height: 86vh; object-fit: contain; user-select: none; -webkit-user-drag: none;}
    .attach-viewer-close{position: absolute; top: 10px; right: 10px; border: none; background: rgba(255,255,255,0.12); color: #fff; font-size: 18px; padding: 10px 12px;
                         border-radius: 10px;}
    .attach-viewer-nav{position: absolute; top: 50%; transform: translateY(-50%); border: none; background: rgba(255,255,255,0.12); color: #fff; font-size: 34px;
                       width: 44px; height: 60px; border-radius: 12px;}
    .attach-viewer-nav.prev{left: 10px;}
    .attach-viewer-nav.next{right:10px;}
    .attach-viewer-count{position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: #fff; font-weight: 700; font-size: 12px;
                         background: rgba(255,255,255,0.12); padding: 6px 10px; border-radius: 999px;}
    .batch-cell {-webkit-touch-callout: none !important; -webkit-user-select: none !important; -moz-user-select: none !important; 
                 -ms-user-select: none !important; user-select: none !important; -webkit-user-drag: none !important;}
    .batch-cell img {-webkit-touch-callout: none !important; -webkit-user-select: none !important; -moz-user-select: none !important; 
                     -ms-user-select: none !important; user-select: none !important; -webkit-user-drag: none !important; pointer-events: none;}
    .batch-grid-2x2 {-webkit-touch-callout: none !important; -webkit-user-select: none !important;}
    .contact{display: flex; align-items: center;}
    .contact-info{flex: 1; min-width: 0;}
    .contact-right{display: flex; align-items: center; gap: 8px; margin-left: 8px;}
    .contact-status{display: flex; flex-direction: column; align-items: center; gap: 5px; opacity: 0.85;}
    .unread-slot {order: 1;}
    .contact-status {order: 2;}
    @keyframes slideUp {from {transform: translateY(100%); opacity: 0;} to {transform: translateY(0); opacity: 1;}}
    @keyframes popScale {0% {transform: scale(0.85); opacity: 0;} 100% {transform: scale(1); opacity: 1;}}    
    @keyframes pulse-green {0% {transform: scale(1); box-shadow: 0 0 5px #00ff00;} 50% {transform: scale(1.15); box-shadow: 0 0 12px #00ff00;} 100% {transform: scale(1); box-shadow: 0 0 5px #00ff00;}}
    @keyframes slideDown {from {transform: translateY(-100%); opacity: 0;} to {transform: translateY(0); opacity: 1;}}
    @keyframes pulse-select {0% {background: inherit;} 50% {opacity: 0.7; transform: scale(1.02);} 100% {background: inherit;}}
    @keyframes highlight-fade {0% {background: rgba(211, 47, 47, 0.3);} 100% {background: inherit;}}
    @keyframes gentle-pulse {0%, 100% {box-shadow: 0 4px 12px rgba(52, 183, 241, 0.5), 0 2px 6px rgba(52, 183, 241, 0.3);} 50% {box-shadow: 0 6px 16px rgba(52, 183, 241, 0.7), 0 3px 8px rgba(52, 183, 241, 0.5);}}
    @keyframes shimmer {0% {background-position: -200% 0;} 100% {background-position: 200% 0;}}
    /* =================================================
    MEDIA QUERIES - FULL RESPONSIVENESS
    ================================================= */
    /* ============ RESPONSIVENESS 480px ============ */
    @media (max-width: 480px) {
      .header {padding: 8px 15px;}
      .header h1 {font-size: 1.2em !important; margin: 0 !important;}
      .header-logo {height: 50px; top: 32px; left: 10px;}
      .main-content {padding-top: 60px; padding-bottom: 30px;}
      .footer {padding: 5px 15px;}
      .powered-by {font-size: 11px;}
      .footer-year {font-size: 9px;}  
      .action-bar {top: 60px; padding: 2px 12px; gap: 10px;}
      .action-btn {font-size: 20px; min-width: 36px; min-height: 36px; padding: 6px;}
      .action-bar-counter {font-size: 14px;}}
    /* ============ RESPONSIVENESS 385px ============ */
    @media (max-width: 385px) {
      .powered-by {font-size: 10px !important; white-space: nowrap;}
      .footer-year {font-size: 8px !important;}
      .chat-input-bar {bottom: 38px;}}
  </style>
</head>
<body>
  <header class="header">
    <img id="corpLogo" class="header-logo" alt="" src="...">
    <h1>CHAT INTERNO</h1>
    <div class="header-subtitle">CHAT DE CONVERSA√á√ÉO INTERNA</div>
  </header> 
  <div class="action-bar" id="action-bar">
    <button class="action-bar-close" onclick="clearSelection()" title="Cancelar"><span class="material-icons">close</span></button> 
    <div class="action-bar-counter" id="action-counter"></div>
    <div class="action-bar-actions">
      <button class="action-btn" id="action-reply" onclick="actionReply()" title="Responder"><span class="material-icons">reply</span></button>
      <button class="action-btn" id="action-star" onclick="actionStar()" title="Favoritar"><span class="material-icons">star_border</span></button>
      <button class="action-btn" id="action-copy" onclick="actionCopy()" title="Copiar"><span class="material-icons">content_copy</span></button>
      <button class="action-btn" id="action-forward" onclick="actionForward()" title="Encaminhar"><span class="material-icons">forward</span></button>
      <button class="action-btn" id="action-delete" onclick="actionDelete()" title="Apagar"><span class="material-icons">delete</span></button>
      <button class="action-btn" id="action-edit" onclick="actionEdit()" title="Editar"><span class="material-icons">edit</span></button>
    </div>
  </div> 
  <div class="main-content">
    <div id="chat-header-group" style="display: contents;"> 
      <div id="back-header" class="back-header" onclick="goBackToMain()" style="display: none;">
        <span class="material-icons back-arrow">arrow_back</span>
        <span class="back-text" style="margin-left: 10px; font-weight: 500;">Voltar</span>
      </div>
      <div id="chat-id-info" class="chat-id-info" style="display: none;"></div>    
      <div id="pinned-message" class="pinned-banner" style="display: none;">
        <span class="material-icons" style="font-size: 18px;">push_pin</span>
        <div class="pinned-text" id="pinned-text-content">...</div>
      </div>
    </div>
    <div id="contact-title" class="contact-id-info">Contactos</div>
    <div id="contact-list"></div>
    <div id="messages" class="message-container"></div>
    <div id="typing-status" class="typing-indicator"></div>
  </div>
  <div class="chat-input-bar">
    <div class="input-wrapper">
      <button id="emoji-open-btn" type="button"><span class="material-icons">sentiment_satisfied_alt</span></button>
      <input type="text" id="chat-input" placeholder="Mensagem" autocomplete="off" />    
      <button id="attachment-btn" type="button"><span class="material-icons">attach_file</span></button>
      <input type="file" id="doc-file-input" accept="*/*" multiple style="position:fixed; left:-9999px; top:0; width:1px; height:1px; opacity:0;">
      <button id="camera-btn" type="button"><span class="material-icons">photo_camera</span></button>
    </div>
    <button id="chat-send-btn">
      <span class="material-icons" id="send-icon">mic</span>
    </button>
  </div>
  <div class="edit-bar" id="edit-bar">
    <div class="edit-bar-content">
      <span class="material-icons edit-icon">edit</span>
      <div class="edit-info">
        <div class="edit-label">Editar mensagem</div>
        <div class="edit-text-preview" id="edit-text-preview">...</div>
      </div>
      <button class="edit-cancel" onclick="cancelEdit()">‚úï</button>
    </div>
  </div>
  <div class="reply-bar" id="reply-bar">
    <div class="reply-bar-content">
      <span class="reply-icon">‚Ü©Ô∏è</span>
      <div class="reply-info">
        <div class="reply-to-name" id="reply-to-name">Nome</div>
        <div class="reply-to-text" id="reply-to-text">Mensagem...</div>
      </div>
      <button class="reply-cancel" onclick="cancelReply()">‚úï</button>
    </div>
  </div>
  <div id="reaction-menu" class="reaction-menu">
    <div class="emoji-scroll-container">
      <span class="reaction-emoji-container" onclick="handleReactionClick('üëç')">üëç</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üòÇ')">üòÇ</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üòÆ')">üòÆ</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üò¢')">üò¢</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üôè')">üôè</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üî•')">üî•</span>
      <span class="reaction-emoji-container" onclick="handleReactionClick('üëè')">üëè</span>
    </div>
    <div class="plus-button" onclick="openFullEmojiPicker()">
      <span class="material-icons">add</span>
    </div>
  </div>  
  <div id="modal-confirm" class="custom-confirm-overlay" style="display:none;">
    <div class="custom-confirm-card">
      <p class="confirm-text">Eliminar mensagem?</p>
      <div class="confirm-buttons-stack">
        <button onclick="resConfirm('todos')" class="btn-confirm-action">Eliminar para todos</button>
        <button onclick="resConfirm('mim')" class="btn-confirm-action">Eliminar s√≥ para mim</button>
        <button onclick="resConfirm('cancel')" class="btn-confirm-cancel">Cancelar</button>
      </div>
    </div>
  </div>
  <div id="modal-alert-system" class="custom-confirm-overlay" style="display: none;">
    <div class="custom-confirm-card">
      <span id="alerta-icon" class="material-icons" style="font-size: 48px; margin-bottom: 10px;"></span>
      <h3 id="alerta-titulo" style="margin: 0 0 10px 0; font-size: 1.2rem;"></h3>
      <p id="alerta-mensagem" class="confirm-text"></p>
      <div class="confirm-buttons-stack">
        <button onclick="closeAlertSystem()" class="btn-confirm-action">OK</button>
      </div>
    </div>
  </div>
  <div id="modal-confirm-critical" class="custom-confirm-overlay" style="display:none;">
    <div class="custom-confirm-card">
      <span class="material-icons" style="font-size: 48px; color: #ef4444;">warning</span>
      <h3 style="color: #ef4444; margin: 10px 0;">ATEN√á√ÉO!</h3>
      <p id="critical-message" class="confirm-text"></p>
      <div class="confirm-buttons-stack">
        <button id="btn-confirm-delete" class="btn-confirm-action" style="background: #ef4444;">Sim, Eliminar Tudo</button>
        <button onclick="closeConfirmCritical()" class="btn-confirm-cancel">Cancelar</button>
        </div>
    </div>
  </div>  
  <div id="contact-menu-overlay" class="custom-confirm-overlay" style="display:none;">
    <div class="custom-confirm-card">
      <p class="confirm-text" id="contact-menu-title">Op√ß√µes</p>
      <div class="confirm-buttons-stack">
        <button id="contact-menu-block" class="btn-confirm-action" style="color:#ccc;"><span class="material-icons">block</span>Bloquear</button>
        <button id="contact-menu-mute" class="btn-confirm-action" style="color:#ccc;"><span class="material-icons">notifications_active</span>Silenciar</button>
        <button id="contact-menu-clear" class="btn-confirm-action" style="color: #ccc;">
          <span class="material-icons" style="vertical-align: middle; margin-bottom: 4px; margin-right: 8px;">delete</span>Limpar Conversa
        </button>
        <button onclick="closeContactMenu()" class="btn-confirm-cancel">Cancelar</button>
      </div>
    </div>
  </div>  
  <div class="footer">
    <div class="footer-content">
      <div class="powered-by"><strong>Powered by:</strong> F√°bio Martins | Sistemas de Informa√ß√£o - Grupo CB360</div>
      <div class="footer-year">¬© 2023-2025 - Sistema CB360 Mobile</div>
    </div>
  </div>
  <div id="full-emoji-picker-container">
    <emoji-picker locale="pt" class="light"></emoji-picker>
  </div>
  <input type="file" id="camera-file-input" accept="image/*" capture="environment" style="position:fixed; left:-9999px; top:0; width:1px; height:1px; opacity:0;"/>
  <div id="attach-modal" class="attach-modal">
    <div class="attach-card">
      <div class="attach-header">
        <span>Enviar Foto</span>
        <button id="attach-cancel" class="attach-x" type="button">‚úï</button>
      </div>
      <div class="attach-preview">
        <img id="attach-preview-img" src="..." alt="preview" style="display:none;" />        
        <div id="attach-grid" class="attach-grid" style="display:none;">
          <div class="attach-grid-cell" data-idx="0"><img id="attach-grid-img-0" alt="thumb0"></div>
          <div class="attach-grid-cell" data-idx="1"><img id="attach-grid-img-1" alt="thumb1"></div>
          <div class="attach-grid-cell" data-idx="2"><img id="attach-grid-img-2" alt="thumb2"></div>
          <div class="attach-grid-cell attach-grid-last" data-idx="3">
            <img id="attach-grid-img-3" alt="thumb3">
            <div id="attach-grid-more" class="attach-grid-more" style="display:none;"></div>              
          </div>
        </div>        
        <div id="attach-file-card" class="attach-file-card" style="display:none;">
          <span class="material-icons" id="attach-file-icon">insert_drive_file</span>
          <div class="attach-file-meta">
            <div id="attach-file-name" class="attach-file-name"></div>
            <div id="attach-file-type" class="attach-file-type"></div>
          </div>
        </div>
        <div id="attach-loading" class="attach-loading" style="display:none;">A enviar...</div>
        <div id="attach-viewer" class="attach-viewer" style="display:none;">
          <button id="attach-viewer-close" class="attach-viewer-close" type="button">‚úï</button>
          <button id="attach-viewer-prev" class="attach-viewer-nav prev" type="button">‚Äπ</button>
          <img id="attach-viewer-img" class="attach-viewer-img" alt="viewer">
          <button id="attach-viewer-next" class="attach-viewer-nav next" type="button">‚Ä∫</button>
          <div id="attach-viewer-count" class="attach-viewer-count"></div>
        </div>
      </div>
      <div class="attach-footer">
        <input id="attach-caption" type="text" placeholder="Adicione uma legenda..." autocomplete="off" />
        <button id="attach-send" type="button">Enviar</button>
      </div>
    </div>
  </div>
  <div id="chat-batch-viewer" class="attach-viewer" style="display:none;">
    <button id="chat-batch-viewer-close" class="attach-viewer-close" type="button">‚úï</button>
    <button id="chat-batch-viewer-prev" class="attach-viewer-nav prev" type="button">‚Äπ</button>
    <img id="chat-batch-viewer-img" class="attach-viewer-img" alt="viewer" style="display:none;">
    <div id="chat-batch-viewer-file" class="attach-file-card" style="display:none; max-width:90%;">
      <span class="material-icons" id="chat-batch-file-icon">insert_drive_file</span>
      <div class="attach-file-meta">
        <div id="chat-batch-file-name" class="attach-file-name"></div>
        <div id="chat-batch-file-type" class="attach-file-type"></div>
        <a id="chat-batch-file-open" target="_blank" style="margin-top:6px; display:inline-block; text-decoration:none;">Abrir</a>
      </div>
    </div>
    <button id="chat-batch-viewer-next" class="attach-viewer-nav next" type="button">‚Ä∫</button>
    <div id="chat-batch-viewer-count" class="attach-viewer-count"></div>
  </div>
  <script type="module" src="https://cdn.jsdelivr.net/npm/emoji-picker-element@1/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    (function () {
      function setVH() {
        document.documentElement.style.setProperty(
          '--vh',
          (window.innerHeight * 0.01) + 'px'
        );
      }
      window.addEventListener('resize', setVH);
      window.addEventListener('orientationchange', setVH);
      setVH();
    })();
  </script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script>
    if (window.pdfjsLib) {
      window.pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }
  </script>
  <script> 
    /* ===================== SUPABASE CONFIGURATION ====================== */
    const SUPABASE_URL = 'https://rjkbodfqsvckvnhjwmhg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqa2JvZGZxc3Zja3ZuaGp3bWhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNjM3NjQsImV4cCI6MjA2MzczOTc2NH0.jX5OPZkz1JSSwrahCoFzqGYw8tYkgE8isbn12uP43-0';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);    
    /* ======================== GLOBAL VARIABLES ========================= */
    let currentChat = 'null';
    let currentChatName = '';
    let lastDateLabel = "";
    let totalTeam = 0;
    let currentReplyToMessage = null;
    let currentEditingMessage = null;
    let selectedMessages = [];
    let messagesToForward = [];
    let reactionTargetId = null;
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let recordTimeout;
    let recordingTimer;
    const currentUserNint = String(localStorage.getItem("currentCorpNint"));
    function getSupabaseHeaders(options = {}) {
      const corp = localStorage.getItem("currentCorpOperNr");
      const nint = localStorage.getItem("currentCorpNint");
      const headers = {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'x-my-corpo': corp,        
        'x-my-nint': nint
      };
      if (options.returnRepresentation) headers['Prefer'] = 'return=representation';
      return headers;
    }
    /* ======================= FUNCTION FIX LAYOUT ======================= */
    function adjustMainContent() {
      const main = document.querySelector('.main-content');
      const header = document.querySelector('.header');
      const footer = document.querySelector('.footer');
      if (!main) return;
      const alturaViewport = window.innerHeight;
      const headerHeight = header?.offsetHeight || 0;
      const footerHeight = footer?.offsetHeight || 0;
      const extra = 100;
      const alturaMain = alturaViewport - headerHeight - footerHeight + extra;
      main.style.height = alturaMain + 'px';
      main.style.maxHeight = alturaMain + 'px';
    }    
    window.addEventListener('load', adjustMainContent);
    window.addEventListener('resize', adjustMainContent);
    window.addEventListener('pageshow', adjustMainContent);
    /* ================== TYPING BAR & EMOJI CONTROLER =================== */
    const inputMensage = document.getElementById('chat-input');
    const inputBar = document.querySelector('.chat-input-bar');
    const iconBtn = document.getElementById('send-icon'); 
    const emojiBtn = document.getElementById('emoji-open-btn');
    const emojiContainer = document.getElementById('full-emoji-picker-container');
    const picker = document.querySelector('emoji-picker');
    const messageContainer = document.querySelector('.message-container');
    function resetLayout() {
      emojiContainer.style.display = 'none';
      inputBar.style.removeProperty('bottom');
      messageContainer.style.removeProperty('margin-bottom');
      setTimeout(() => {
        scrollToBottom();
      }, 100);
    }
    inputMensage.addEventListener('input', function() {
      const hasText = this.value.trim().length > 0;
      const novoIcone = hasText ? 'send' : 'mic';
      if (iconBtn.textContent !== novoIcone) {
        iconBtn.style.transform = 'rotate(180deg) scale(0)';
        iconBtn.style.opacity = '0';
        setTimeout(() => {
          iconBtn.textContent = novoIcone;
          iconBtn.style.transform = 'rotate(0deg) scale(1)';
          iconBtn.style.opacity = '1';
          if (hasText) {
            inputBar.classList.add('typing');
          } else {
            inputBar.classList.remove('typing');
          }
        }, 150);
      }
    });
    emojiBtn.addEventListener('click', (e) => {
      e.preventDefault();
      if (emojiContainer.style.display === 'block') {
        resetLayout();
        inputMensage.focus();
      } else {
        inputMensage.blur(); 
        setTimeout(() => {
          emojiContainer.style.display = 'block';
          inputBar.style.bottom = '305px'; 
          messageContainer.style.marginBottom = '325px'; 
          let scrollAcompanha = setInterval(() => {
            messageContainer.scrollTop = messageContainer.scrollHeight;
          }, 10);
          setTimeout(() => clearInterval(scrollAcompanha), 400);
        }, 50);
      }
    });
    picker.addEventListener('emoji-click', event => {
      const emoji = event.detail.unicode;
      const inicio = inputMensage.selectionStart;
      const fim = inputMensage.selectionEnd;
      inputMensage.value = inputMensage.value.substring(0, inicio) + emoji + inputMensage.value.substring(fim);
      const novaPosicao = inicio + emoji.length;
      inputMensage.setSelectionRange(novaPosicao, novaPosicao);
      inputMensage.dispatchEvent(new Event('input'));
    });
    inputMensage.addEventListener('focus', () => {
      resetLayout();
    });
    messageContainer.addEventListener('click', (e) => {
      if (emojiContainer.style.display === 'block') {
        resetLayout();
      }
    });
    /* ========================= AUDIO RECORDING ========================= */
    async function startAudioLogic(e) {
      if (iconBtn.textContent !== 'mic') return;
      if (currentChat === 'null') return;
      recordTimeout = setTimeout(async () => {
        try {
          const permission = await navigator.permissions.query({name: 'microphone'});
          if (permission.state === 'denied') {
            showSystemWarning('microfone', 'Acesso Negado', 'Ativa o microfone nas defini√ß√µes para enviares √°udios.');
            return;
          }
          const stream = await navigator.mediaDevices.getUserMedia({audio: true});
          mediaRecorder = new MediaRecorder(stream);
          audioChunks = [];
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = async () => {
            const audioBlob = new Blob(audioChunks, {type: 'audio/webm'});
            if (audioBlob.size > 2000) {
              await uploadAudioToSupabase(audioBlob);
            }
            stream.getTracks().forEach(t => t.stop());
          };
          mediaRecorder.start();
          isRecording = true;
          iconBtn.classList.add("recording-pulse");
          inputMensage.placeholder = "üî¥ A gravar... solte para enviar";
          if (inputBar) inputBar.style.backgroundColor = "#fff5f5";
        } catch (err) {
          console.error("Erro ao aceder ao microfone:", err);
          if (err.name === 'NotAllowedError') {
            showSystemWarning('configuracao', 'Ajuste Necess√°rio', 'Clica no √≠cone do cadeado ao lado do URL (barra de endere√ßo) e permite o acesso ao microfone para poderes gravar.');
          } else if (err.name === 'NotFoundError') {
            showSystemWarning('hardware_error', 'Microfone n√£o detetado', 'Verifica se tens um microfone ligado ao dispositivo ou se o mesmo est√° funcional.');
          } else {
            showSystemWarning('sistema_erro', 'Erro de Sistema', 'Houve um problema t√©cnico ao tentar aceder ao √°udio: ' + err.message);
          }
        }
      }, 250);
    }
    function stopAudioLogic() {
      clearTimeout(recordTimeout);
      if (isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        iconBtn.classList.remove("recording-pulse");
        inputMensage.placeholder = "Mensagem";
        if (inputBar) inputBar.style.backgroundColor = "";
      } else {
        inputMensage.placeholder = "Mensagem";
        if (inputBar) inputBar.style.backgroundColor = "";
      }
    }
    iconBtn.addEventListener('mousedown', startAudioLogic);
    window.addEventListener('mouseup', stopAudioLogic);
    iconBtn.addEventListener('touchstart', (e) => {
      if (iconBtn.textContent === 'mic') e.preventDefault();
      startAudioLogic();
    }, {passive: false});
    window.addEventListener('touchend', stopAudioLogic);
    async function uploadAudioToSupabase(blob) {
      const fileName = `audio_${Date.now()}.webm`;
      const filePath = `${currentChat}/${fileName}`;
      try {
        const {data, error} = await supabaseClient.storage
        .from('cb_files')
        .upload(filePath, blob);
        if (error) throw error;
        const {data: {publicUrl}} = supabaseClient.storage
        .from('cb_files')
        .getPublicUrl(filePath);
        await sendMessage("Enviou um √°udio", publicUrl); 
      } catch (err) {
        console.error("Erro:", err.message);
      }
    }    
    /* ================== CAMERA, FILE & IMAGE HANDLER =================== */
    window.attachState = window.attachState || {mode: null, files: [], previewUrl: null};
    function clearAttachGridPreviews() {
      if (window.gridPreviewUrls && Array.isArray(window.gridPreviewUrls)) {
        window.gridPreviewUrls.forEach(u => {try {URL.revokeObjectURL(u);} catch(e){}});
      }
      window.gridPreviewUrls = [];
    }
    function renderAttachGrid(files) {
      const grid = document.getElementById("attach-grid");
      const imgMain = document.getElementById("attach-preview-img");
      const more = document.getElementById("attach-grid-more");
      if (!grid || !imgMain) return;
      clearAttachGridPreviews();
      if (!files || files.length < 2) {
        grid.style.display = "none";
        if (more) more.style.display = "none";
        return;
      }
      imgMain.style.display = "none";
      grid.style.display = "grid";
      window.gridPreviewUrls = window.gridPreviewUrls || [];
      for (let i = 0; i < 4; i++) {
        const imgEl = document.getElementById(`attach-grid-img-${i}`);
        if (!imgEl) continue;
        const f = files[i];
        if (f && f.type?.startsWith("image/")) {
          const url = URL.createObjectURL(f);
          window.gridPreviewUrls.push(url);
          imgEl.src = url;
          imgEl.style.display = "block";
        } else {
          imgEl.src = "";
          imgEl.style.display = "none";
        }
      }
      const extra = files.length - 4;
      if (more) {
        if (extra > 0) {
          more.textContent = `+${extra}`;
          more.style.display = "flex";
        } else {
          more.style.display = "none";
        }
      }
    }
    function openAttachViewer(startIndex = 0) {
      const viewer = document.getElementById("attach-viewer");
      const img = document.getElementById("attach-viewer-img");
      const count = document.getElementById("attach-viewer-count");
      const prevBtn = document.getElementById("attach-viewer-prev");
      const nextBtn = document.getElementById("attach-viewer-next");
      const files = (Array.isArray(window.pendingAttachFiles) && window.pendingAttachFiles.length ? window.pendingAttachFiles :
                    (Array.isArray(window.attachState?.files) && window.attachState.files.length ? window.attachState.files : []));
      if (!viewer || !img || !count || !files.length) return;
      window.viewerIndex = Math.max(0, Math.min(startIndex, files.length - 1));
      if (window.viewerUrl) {try {URL.revokeObjectURL(window.viewerUrl);} catch(e){}}
      window.viewerUrl = null;
      const f = files[window.viewerIndex];
      if (!f || !f.type?.startsWith("image/")) return;
      window.viewerUrl = URL.createObjectURL(f);
      img.src = window.viewerUrl;
      count.textContent = `${window.viewerIndex + 1} / ${files.length}`;
      prevBtn.style.display = files.length > 1 ? "block" : "none";
      nextBtn.style.display = files.length > 1 ? "block" : "none";
      viewer.style.display = "flex";
    }
    function closeAttachViewer() {
      const viewer = document.getElementById("attach-viewer");
      if (viewer) viewer.style.display = "none";
      if (window.viewerUrl) {try {URL.revokeObjectURL(window.viewerUrl);} catch(e){}}
      window.viewerUrl = null;
    }
    function viewerGo(delta) {
      const files = (Array.isArray(window.pendingAttachFiles) && window.pendingAttachFiles.length ? window.pendingAttachFiles :
                    (Array.isArray(window.attachState?.files) && window.attachState.files.length ? window.attachState.files : []));
      if (!files.length) return;
      let idx = (window.viewerIndex ?? 0) + delta;
      if (idx < 0) idx = files.length - 1;
      if (idx >= files.length) idx = 0;
      openAttachViewer(idx);
    }
    function initAttachViewerHandlers() {
      const closeBtn = document.getElementById("attach-viewer-close");
      const prevBtn = document.getElementById("attach-viewer-prev");
      const nextBtn = document.getElementById("attach-viewer-next");
      const viewer = document.getElementById("attach-viewer");
      const img = document.getElementById("attach-viewer-img");
      closeBtn?.addEventListener("click", closeAttachViewer);
      prevBtn?.addEventListener("click", () => viewerGo(-1));
      nextBtn?.addEventListener("click", () => viewerGo(+1));
      viewer?.addEventListener("click", (e) => {
        if (e.target === viewer) closeAttachViewer();
      });
      let startX = 0;
      let isDown = false;
      const onDown = (x) => {startX = x; isDown = true;};
      const onUp = (x) => {
        if (!isDown) return;
        isDown = false;
        const dx = x - startX;
        if (Math.abs(dx) > 40) {
          if (dx < 0) viewerGo(+1);
          else viewerGo(-1);
        }
      };
      img?.addEventListener("touchstart", (e) => onDown(e.touches[0].clientX), {passive:true});
      img?.addEventListener("touchend", (e) => onUp(e.changedTouches[0].clientX), {passive:true});
      img?.addEventListener("mousedown", (e) => onDown(e.clientX));
      window.addEventListener("mouseup", (e) => onUp(e.clientX));
    }    
    const cameraBtn = document.getElementById("camera-btn");
    const cameraInput = document.getElementById("camera-file-input");
    const attachModal = document.getElementById("attach-modal");
    const attachImg = document.getElementById("attach-preview-img");
    const attachFileCard = document.getElementById("attach-file-card");
    const attachCaption = document.getElementById("attach-caption");
    const attachSend = document.getElementById("attach-send");
    const attachCancel = document.getElementById("attach-cancel");
    const attachLoading = document.getElementById("attach-loading");
    let pendingFile = null;
    window.previewUrl = window.previewUrl || null;
    cameraBtn.addEventListener("click", (e) => {
      e.preventDefault();
      if (!currentChat || currentChat === "null") return;
      cameraInput.value = "";
      cameraInput.click();
    });
    cameraInput.addEventListener("change", () => {
      const file = cameraInput.files?.[0];
      if (!file) return;    
      pendingFile = file;
      window.attachMode = "camera";
      window.pendingAttachFile = null;
      window.pendingAttachFiles = null;    
      closeAttachViewer?.();
      clearAttachGridPreviews?.();
      const grid = document.getElementById("attach-grid");
      if (grid) grid.style.display = "none";
      const more = document.getElementById("attach-grid-more");
      if (more) more.style.display = "none";    
      if (window.previewUrl) URL.revokeObjectURL(window.previewUrl);
      window.previewUrl = URL.createObjectURL(file);    
      attachImg.src = window.previewUrl;
      attachImg.style.display = "block";
      if (attachFileCard) attachFileCard.style.display = "none";    
      attachCaption.value = "";
      attachModal.style.display = "flex";
      setTimeout(() => attachCaption.focus(), 150);
    });
    function closeModalFileAndFoto() {
      attachModal.style.display = "none";
      attachLoading.style.display = "none";
      attachSend.disabled = false;
      if (window.previewUrl) URL.revokeObjectURL(window.previewUrl);
      window.previewUrl = null;
      if (window.viewerUrl) {try {URL.revokeObjectURL(window.viewerUrl);} catch(e) {}}
      window.viewerUrl = null;
      window.viewerIndex = 0;
      pendingFile = null;
      window.pendingAttachFile = null;
      window.pendingAttachFiles = null;
      window.attachMode = null;
      attachImg.src = "";
      attachImg.style.display = "none";
      if (attachFileCard) attachFileCard.style.display = "none";
      attachCaption.value = "";
      cameraInput.value = "";
      const docInput = document.getElementById("doc-file-input");
      if (docInput) docInput.value = "";
      closeAttachViewer?.();
      clearAttachGridPreviews?.();
      const grid = document.getElementById("attach-grid");
      if (grid) {
        grid.style.display = "none";
        grid.querySelectorAll(".attach-grid-cell").forEach(cell => cell.onclick = null);
      }
      const more = document.getElementById("attach-grid-more");
      if (more) more.style.display = "none";
    }
    attachCancel.addEventListener("click", closeModalFileAndFoto);
    attachSend.addEventListener("click", async () => {
      const caption = (attachCaption.value || "").trim();
      if (window.attachMode === "files" && Array.isArray(window.pendingAttachFiles) && window.pendingAttachFiles.length) {
        const batchId = crypto.randomUUID();
        try {
          attachLoading.style.display = "block";
          attachSend.disabled = true;
          for (const f of window.pendingAttachFiles) {
            await uploadFile(f, caption, {batchId});
          }
          closeModalFileAndFoto();
        } catch (err) {
          console.error("Erro ao enviar album:", err);
          showSystemWarning('upload_error', 'Falha no Envio', 'N√£o foi poss√≠vel enviar as fotos. Por favor, verifica a tua liga√ß√£o.');
          attachLoading.style.display = "none";
          attachSend.disabled = false;
        }
        return;
      }
      if (window.attachMode === "multi" && Array.isArray(window.pendingAttachFiles) && window.pendingAttachFiles.length) {
        const batchId = crypto.randomUUID();
        try {
          attachLoading.style.display = "block";
          attachSend.disabled = true;
          for (const f of window.pendingAttachFiles) {
            await uploadFile(f, caption, {batchId});
          }
          closeModalFileAndFoto();
        } catch (err) {
          console.error("Erro ao enviar multi:", err);
          showSystemWarning('file_error', 'Erro no Upload', 'N√£o foi poss√≠vel enviar os ficheiros. Tenta novamente em alguns instantes.');
          attachLoading.style.display = "none";
          attachSend.disabled = false;
        }
        return;
      }
      if (window.attachMode === "file" && window.pendingAttachFile) {
        try {
          attachLoading.style.display = "block";
          attachSend.disabled = true;
          await uploadFile(window.pendingAttachFile, caption);
          closeModalFileAndFoto();
        } catch (err) {
          console.error("Erro ao enviar anexo:", err);
          showSystemWarning('anexo_error', 'Erro no Anexo', 'N√£o foi poss√≠vel enviar o anexo. Por favor, tenta carregar o ficheiro novamente.');
          attachLoading.style.display = "none";
          attachSend.disabled = false;
        }
        return;
      }
      if (window.attachMode !== "camera") return;
      if (!pendingFile) return;
      try {
        attachLoading.style.display = "block";
        attachSend.disabled = true;
        const publicUrl = await uploadImageToSupabase(pendingFile);
        await sendImageMessage(publicUrl, pendingFile.name || `foto_${Date.now()}.jpg`, caption);
        closeModalFileAndFoto();
      } catch (err) {
        console.error("Erro ao enviar foto:", err);
        showSystemWarning('foto_error',  'Erro na Imagem', 'N√£o foi poss√≠vel enviar a foto. Por favor, tenta novamente.');
        attachLoading.style.display = "none";
        attachSend.disabled = false;
      }
    });  
    async function uploadImageToSupabase(file) {
      if (file.type && !file.type.startsWith("image/")) throw new Error("Ficheiro n√£o √© imagem.");
      const ext = (file.name?.split(".").pop() || "jpg").toLowerCase();
      const fileName = `photo_${Date.now()}.${ext}`;
      const filePath = `${currentChat}/${fileName}`;
      const {error} = await supabaseClient
      .storage
      .from("cb_files")
      .upload(filePath, file, {contentType: file.type || "image/jpeg"});
      if (error) throw error;
      const {data: {publicUrl}} = supabaseClient
      .storage
      .from("cb_files")
      .getPublicUrl(filePath);
      if (!publicUrl) throw new Error("Sem URL p√∫blico.");
      return publicUrl;
    }
    async function sendImageMessage(imageUrl, fileName, caption = "") {
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const senderName = await fetchUserName();
      const payload = {n_int: currentUserNint, recipient_nint: String(currentChat), corp_oper_nr: currentCorp, abv_name: senderName, message_type: "image", file_url: imageUrl,
                       file_name: fileName, message: caption};
      const {error} = await supabaseClient
      .from("chat_messages")
      .insert([payload]);
      if (error) throw error;
      fetch('/api/sendPush', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({recipient_nint: String(currentChat), corp_nr: currentCorp, sender_name: senderName, message_text: caption?.trim() ? `üì∑ ${caption.trim()}` : "üì∑ Foto", 
                              sender_nint: currentUserNint})
      }).catch(err => console.error("Erro no push:", err));
    }
    /* ========================== FILE HANDLER =========================== */
    async function compressImage(file, {
      maxWidth = 1280,
      maxHeight = 1280,
      quality = 0.7,
      mimeType = 'image/jpeg'} = {}) {
      if (!file || !file.type?.startsWith('image/')) return file;
      const bitmap = await createImageBitmap(file);
      const srcW = bitmap.width;
      const srcH = bitmap.height;
      const scale = Math.min(maxWidth / srcW, maxHeight / srcH, 1);
      const dstW = Math.max(1, Math.round(srcW * scale));
      const dstH = Math.max(1, Math.round(srcH * scale));
      const canvas = document.createElement('canvas');
      canvas.width = dstW;
      canvas.height = dstH;
      const ctx = canvas.getContext('2d', {alpha: true});
      ctx.imageSmoothingEnabled = true;
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(bitmap, 0, 0, dstW, dstH);
      const blob = await new Promise(resolve => canvas.toBlob(resolve, mimeType, quality));
      if (!blob) return file;
      const baseName = (file.name || 'imagem').replace(/\.[^.]+$/, '');
      const ext = mimeType === 'image/png' ? 'png' : 'jpg';
      const outName = `${baseName}_opt.${ext}`;
      return new File([blob], outName, {type: mimeType});
    }
    /* ====================== UPLOAD FILES & IMAGES ====================== */    
    async function uploadFile(file, caption = "", opts = {}) {
      if (!file) return;
      const MAX_MB = 25;
      if (file.size > MAX_MB * 1024 * 1024) {
        showSystemWarning('limite_tamanho',  'Ficheiro muito grande', `O ficheiro que selecionaste √© demasiado pesado. O limite m√°ximo √© de ${MAX_MB}MB.`);
        return;
      }
      if (!currentChat || currentChat === "null") return;
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const chatId = String(currentChat);
      if (file.type?.startsWith('image/')) {
        try {
          file = await compressImage(file, {
            maxWidth: 1280, maxHeight: 1280, quality: 0.7, mimeType: 'image/jpeg'
          });
        } catch (e) {
          console.warn("Falha a comprimir imagem, enviando original.", e);
        }
      }
      const now = Date.now();
      const safeName = (file.name || 'ficheiro').replace(/[^\w.\-() ]+/g, '_');
      const rand = (crypto.randomUUID?.() || Math.random().toString(16).slice(2));
      const basePath = `${chatId}/${now}_${rand}_${safeName}`;
      try {
        let previewUrl = null;
        const isPdf = file.type === 'application/pdf' || (file.name || '').toLowerCase().endsWith('.pdf');
        const isImage = file.type?.startsWith('image/');
        if (isPdf && window.pdfjsLib) {
          try {
            const thumbBlob = await renderPdfFirstPageToBlob(file, {scale: 0.35, quality: 0.7});
            if (thumbBlob) {
              const thumbPath = `${chatId}/previews/${now}_${rand}_thumb.jpg`;
              const {error: upThumbErr} = await supabaseClient.storage
              .from('cb_files')
              .upload(thumbPath, thumbBlob, {contentType: 'image/jpeg'});
              if (!upThumbErr) {
                const {data: pubThumb} = supabaseClient.storage
                .from('cb_files')
                .getPublicUrl(thumbPath);
                previewUrl = pubThumb?.publicUrl || null;
              }
            }
          } catch (e) {
            console.warn("Falha ao gerar preview do PDF, continuando apenas com o ficheiro.", e);
          }
        }
        const {error: upErr} = await supabaseClient.storage
        .from('cb_files')
        .upload(basePath, file, {contentType: file.type || 'application/octet-stream'});
        if (upErr) throw upErr;
        const {data: pubFile} = supabaseClient.storage
        .from('cb_files')
        .getPublicUrl(basePath);
        const publicUrl = pubFile?.publicUrl;
        if (!publicUrl) throw new Error("Sem URL p√∫blico do ficheiro.");
        const senderName = await fetchUserName();
        const defaultMsg = isImage
        ? "Enviou uma foto üì∑"
        : (isPdf ? `Documento PDF: ${file.name}` : `Ficheiro: ${file.name}`);
        const finalMsg = (caption || "").trim() || defaultMsg;
        const payload = {n_int: currentUserNint, recipient_nint: chatId, corp_oper_nr: currentCorp, abv_name: senderName, created_at: new Date().toISOString(), message_type: isImage ? 'image' : 'file',
                         file_url: publicUrl, file_name: file.name || safeName, preview_url: previewUrl, message: finalMsg, batch_id: opts?.batchId || null};
        const {error: insertError} = await supabaseClient
        .from('chat_messages')
        .insert([payload]);
        if (insertError) throw insertError;
        const hasBatch = !!opts?.batchId;
        const pushText = isImage
        ? (hasBatch ? "üì∑ √Ålbum" : ((caption || "").trim() ? `üì∑ ${(caption || "").trim()}` : "üì∑ Foto"))
        : (hasBatch ? "üìé Ficheiros" : ((caption || "").trim() ? `üìé ${(caption || "").trim()}` : `üìÑ ${file.name}`));
        fetch('/api/sendPush', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({recipient_nint: chatId, corp_nr: currentCorp, sender_name: senderName, message_text: pushText, sender_nint: currentUserNint})
        }).catch(err => console.error("Erro no push:", err));
      } catch (err) {
        console.error("Erro no envio (detalhes):", err);
        showSystemWarning('upload_falha_tecnica', 'Erro de Transfer√™ncia', "N√£o foi poss√≠vel completar o envio: " + (err?.message || "erro desconhecido"));
      }
    }
    async function renderPdfFirstPageToBlob(file) {
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({data: arrayBuffer}).promise;
      const page = await pdf.getPage(1);
      const viewport = page.getViewport({scale: 0.4});
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({canvasContext: ctx, viewport}).promise;
      return new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    }
    /* ==================== LOADING CORPORATION DATA ===================== */
    async function loadCorpInfo() {
      const corpOperNr = localStorage.getItem("currentCorpOperNr");
      const h2 = document.getElementById("corpInfo");
      const logoEl = document.getElementById("corpLogo");
      if (!corpOperNr) return;
      const cachedLogo = localStorage.getItem("cached_logo_url");
      if (cachedLogo && logoEl) {
        logoEl.src = cachedLogo;
      }
      if (h2) h2.textContent = corpOperNr;
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/corporation_data?select=corporation,corp_oper_nr,logo_url&corp_oper_nr=eq.${corpOperNr}`, {
            headers: getSupabaseHeaders()
          }
        );
        const data = await response.json();
        if (data && data.length > 0) {
          const corp = data[0];
          if (corp.logo_url && corp.logo_url !== cachedLogo) {
            localStorage.setItem("cached_logo_url", corp.logo_url.trim());
            if (logoEl) logoEl.src = corp.logo_url.trim();
          }
        }
      } catch (err) {
        console.error('Erro silencioso:', err);
      }
    }
    /* ========================== LOADING THEME ========================== */
    function loadTheme() {
      if (localStorage.getItem('sgo-theme') === 'dark') document.body.classList.add('dark-mode');
    }
    /* ======================== LOADING CONTACTS ========================= */
    let blockedSetCache = new Set();
    let mutedSetCache = new Set();
    let muteGeralCache = false;
    async function loadContacts() {
      const corpOperNr = localStorage.getItem("currentCorpOperNr");
      const colors = {'A': '#f44336','B': '#e91e63','C': '#9c27b0','D': '#673ab7','E': '#3f51b5','F': '#2196f3','G': '#03a9f4',
                      'H': '#00bcd4','I': '#009688','J': '#4caf50','K': '#8bc34a','L': '#cddc39','M': '#ffeb3b','N': '#ffc107',
                      'O': '#ff9800','P': '#ff5722','Q': '#795548','R': '#9e9e9e','S': '#60727b','T': '#333333','U': '#ff4081',
                      'V': '#7c4dff','W': '#536dfe','X': '#448aff','Y': '#00e676','Z': '#cfd8dc'};    
      const {data: users, error} = await supabaseClient.from('reg_elems')
        .select('n_int, abv_name, photo_url, elem_state')
        .eq('corp_oper_nr', corpOperNr)
        .eq('elem_state', true)
        .order('n_int', {ascending: true});    
      if (error) return console.error(error);      
      totalTeam = users.length + 1;
      const listEl = document.getElementById("contact-list");
      listEl.innerHTML = '';
      const geral = document.createElement("div");
      geral.className = "contact";
      geral.dataset.nint = 'geral';
      geral.onclick = () => openChat('geral', 'Chat Geral');
      let pressTimerGeral;
      geral.addEventListener('touchstart', (e) => {
        pressTimerGeral = setTimeout(() => {
          if (navigator.vibrate) navigator.vibrate(50);
          openContactMenu('geral', 'Chat Geral');
        }, 500);
      }, {passive: true});
      geral.addEventListener('touchend', () => clearTimeout(pressTimerGeral));
      geral.addEventListener('touchmove', () => clearTimeout(pressTimerGeral));
      geral.addEventListener('contextmenu', (e) => {
        e.preventDefault();
        openContactMenu('geral', 'Chat Geral');
      });
      const draftGeral = localStorage.getItem("draft_geral");
      const subTextGeral = draftGeral ? `<div class="draft-preview">Rascunho: ${draftGeral}</div>` : `<div class="nint">Broadcast</div>`;    
      geral.innerHTML = `
        <div class="contact-avatar" style="background-color: #333;">G</div>
        <div class="contact-info">
          <div class="name">Chat Geral</div>
          ${subTextGeral}
        </div>
        <div class="contact-right">
          <div class="unread-slot"></div>
          <div class="contact-status" id="status-geral"></div>
        </div>`;
      listEl.appendChild(geral);
      users.forEach(user => {
        if (String(user.n_int) === currentUserNint) return;        
        const contactId = String(user.n_int);
        const firstLetter = user.abv_name.charAt(0).toUpperCase();
        const avatarColor = colors[firstLetter] || '#d32f2f';
        const savedDraft = localStorage.getItem(`draft_${contactId}`);
        const subText = savedDraft 
          ? `<div class="draft-preview">Rascunho: ${savedDraft}</div>` 
          : `<div class="nint">ID: ${user.n_int}</div>`;    
        const div = document.createElement("div");
        div.className = "contact";
        div.setAttribute('data-nint', contactId);
        div.onclick = () => openChat(user.n_int, user.abv_name);
        let pressTimer;
        div.addEventListener('touchstart', (e) => {
          pressTimer = setTimeout(() => {
            if (navigator.vibrate) navigator.vibrate(50);
            openContactMenu(user.n_int, user.abv_name);
          }, 500);
        }, {passive: true});        
        div.addEventListener('touchend', () => {
          clearTimeout(pressTimer);
        });        
        div.addEventListener('touchmove', () => {
          clearTimeout(pressTimer);
        });
        div.addEventListener('contextmenu', (e) => {
          e.preventDefault();
          openContactMenu(user.n_int, user.abv_name);
        });        
        const avatarContent = user.photo_url ? `<img src="${user.photo_url}">` : firstLetter;        
        div.innerHTML = `
          <div class="contact-avatar" style="background-color: ${user.photo_url ? 'transparent' : avatarColor};">
            ${avatarContent}
            <div class="status-dot"></div>
          </div>
          <div class="contact-info">
            <div class="name">${user.abv_name}</div>
            ${subText}
          </div>
          <div class="contact-right">
            <div class="contact-status" id="status-${contactId}"></div>
            <div class="unread-slot"></div>
          </div>`;      
        listEl.appendChild(div);
        });
      const contactNints = users
      .filter(u => String(u.n_int) !== currentUserNint)
      .map(u => (u.n_int));
      const {blockedSet, mutedSet} = await loadBlockMuteSets(contactNints, corpOperNr);
      const muteGeral = await isGeralMuted(corpOperNr);
      renderContactStatus('geral', {
        blocked: false,
        muted: muteGeral
      });
      contactNints.forEach(nint => {
        renderContactStatus(nint, {
          blocked: blockedSet.has(nint),
          muted: mutedSet.has(nint)
        });
      });
      blockedSetCache = blockedSet;
      mutedSetCache   = mutedSet;
      muteGeralCache  = muteGeral;
    }
    function renderContactStatus(nint, {blocked, muted}) {
      const el = document.getElementById(`status-${nint}`);
      if (!el) return;
      el.innerHTML = '';
      if (blocked) {
        const s = document.createElement('span');
        s.className = 'material-icons';
        s.title = 'Bloqueado';
        s.textContent = 'block';
        s.style.color = '#ccc';
        s.style.fontSize = '18px';
        el.appendChild(s);
      }
      if (muted) {
        const s = document.createElement('span');
        s.className = 'material-icons';
        s.title = 'Silenciado';
        s.textContent = 'notifications_off';
        s.style.color = '#ccc';
        s.style.fontSize = '18px';
        el.appendChild(s);
      }
    }
    async function loadBlockMuteSets(contactNints, corpOperNr) {
      const {data: blocks, error: e1} = await supabaseClient
      .from('user_blocks')
      .select('blocked_nint')
      .eq('blocker_nint', currentUserNint)
      .eq('corp_oper_nr', corpOperNr)
      .in('blocked_nint', contactNints);
      if (e1) console.error('blocks error', e1);
      const {data: mutes, error: e2} = await supabaseClient
      .from('user_mutes')
      .select('muted_nint')
      .eq('muter_nint', currentUserNint)
      .eq('corp_oper_nr', corpOperNr)
      .in('muted_nint', contactNints);
      if (e2) console.error('mutes error', e2);
      const blockedSet = new Set((blocks || []).map(r => String(r.blocked_nint)));
      const mutedSet   = new Set((mutes  || []).map(r => String(r.muted_nint)));
      return {blockedSet, mutedSet};
    }
    async function isGeralMuted(corpOperNr) {
      const {data, error} = await supabaseClient
      .from('user_mutes')
      .select('id')
      .eq('muter_nint', currentUserNint)
      .eq('muted_nint', 'geral')
      .eq('corp_oper_nr', corpOperNr)
      .maybeSingle();  
      if (error) console.error('mute geral error', error);
      return !!data;
    }
    /* ========================== UPDATE BADGES ========================== */
    async function updateUnreadBadges() {
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const {count: totalGeral} = await supabaseClient
      .from('chat_messages')
      .select('*', {count: 'exact', head: true})
      .eq('recipient_nint', 'geral')
      .eq('corp_oper_nr', currentCorp)
      .neq('n_int', currentUserNint);
      const {count: lidasGeral} = await supabaseClient
      .from('chat_message_reads')
      .select('*', {count: 'exact', head: true})
      .eq('n_int', currentUserNint)
      .eq('corp_oper_nr', currentCorp);
      const unreadGeral = Math.max(0, (totalGeral || 0) - (lidasGeral || 0));
      const {data: privData} = await supabaseClient
      .from('chat_messages')
      .select('n_int')
      .eq('recipient_nint', currentUserNint)
      .eq('corp_oper_nr', currentCorp)
      .is('read_at', null);
      const privCounts = {};
      if (privData) {
        privData.forEach(msg => {
          privCounts[msg.n_int] = (privCounts[msg.n_int] || 0) + 1;
        });
      }
      document.querySelectorAll('.contact').forEach(contactEl => {
        const nint = contactEl.getAttribute('data-nint');
        let finalCount = (nint === 'geral') ? unreadGeral : (privCounts[nint] || 0);
        let badge = contactEl.querySelector('.unread-badge');
        const slot = contactEl.querySelector('.unread-slot');
        if (finalCount > 0) {
          if (!badge) {
            badge = document.createElement('div');
            badge.className = 'unread-badge';
            (slot || contactEl).appendChild(badge);
          }
          badge.textContent = finalCount > 99 ? '99+' : finalCount;
        } else {
          if (badge) badge.remove();
        }
      });
    }
    /* ====================== BACK TO CONTACT LIST ======================= */
    function goBackToMain() {
      const text = inputMensage.value.trim();
      if (text !== "" && currentChat !== 'null') {
        localStorage.setItem(`draft_${currentChat}`, text);
      } else if (currentChat !== 'null') {
        localStorage.removeItem(`draft_${currentChat}`);
      }
      resetLayout();
      inputMensage.value = "";
      inputMensage.dispatchEvent(new Event('input'));
      document.getElementById("pinned-message").style.display = 'none';
      document.getElementById("messages").style.display = 'none';
      document.getElementById("back-header").style.display = 'none';
      document.getElementById("chat-id-info").style.display = 'none';
      document.getElementById("typing-status").style.display = 'none';
      document.getElementById("reply-bar").style.display = 'none';
      const inputBar = document.querySelector(".chat-input-bar");
      if (inputBar) inputBar.style.display = 'none';
      document.getElementById("contact-list").style.display = 'flex';
      document.getElementById("contact-title").style.display = 'block';
      currentChat = 'null';
      history.pushState(null, '', `InterChat.html`);
      loadContacts();
    }
    /* ======================== SCROLL TO BOTTOM ========================= */
    function scrollToBottom(forceImmediate = false) {
      const messagesEl = document.getElementById("messages");
      if (!messagesEl || messagesEl.style.display === 'none') return;      
      const doScroll = () => {
        messagesEl.scrollTo({
          top: messagesEl.scrollHeight,
          behavior: forceImmediate ? 'auto' : 'smooth'
        });
      };
      doScroll();
      setTimeout(doScroll, 100);
      setTimeout(doScroll, 300);
    }
    /* ========================= FETCH USER NAME ========================= */
    async function fetchUserName() {
      try {
        const {data} = await supabaseClient.from('reg_elems').select('abv_name').eq('n_int', currentUserNint).maybeSingle();
        return (data && data.abv_name) ? data.abv_name : "Utilizador";
      } catch {return "Utilizador";}
    }
    /* ======================= RENDER REACTIONS ========================== */
    function renderReactions(reactions, messageId) {
      if (!reactions || Object.keys(reactions).length === 0) return '';
      const grouped = {};
      for (const [nint, emoji] of Object.entries(reactions)) {
        if (!grouped[emoji]) grouped[emoji] = [];
        grouped[emoji].push(nint);
      }
      let html = '<div class="message-reactions">';
      for (const [emoji, users] of Object.entries(grouped)) {
        const count = users.length;
        const isMyReaction = users.includes(currentUserNint);
        const myClass = isMyReaction ? 'my-reaction' : '';
        const isThumb = emoji === 'üëç' || emoji === 'üëé';
        const thumbClass = isThumb ? 'thumb-emoji' : '';
        const countHTML = count > 1 ? `<span class="reaction-count">${count}</span>` : '';
        html += `
          <div class="reaction-badge ${myClass}" onclick="event.stopPropagation(); toggleReaction('${messageId}', '${emoji}')">
            <span class="reaction-emoji ${thumbClass}">${emoji}</span>
            ${countHTML}
          </div>
        `;
      }
      html += '</div>';
      return html;
    }
    /* ======================= TOGGLE REACTIONS ========================== */
    async function toggleReaction(messageId, emoji) {
      const {data: msg, error: fetchError} = await supabaseClient
      .from('chat_messages')
      .select('reactions')
      .eq('id', messageId)
      .single();
      if (fetchError) {
        console.error("Erro ao ler rea√ß√µes:", fetchError);
        return;
      }
      let currentReactions = msg.reactions || {};
      if (!currentReactions[emoji]) {
        currentReactions[emoji] = [];
      }
      const userIndex = currentReactions[emoji].indexOf(currentUserNint);
      if (userIndex === -1) {
        currentReactions[emoji].push(currentUserNint);
      } else {
        currentReactions[emoji].splice(userIndex, 1);
        if (currentReactions[emoji].length === 0) {
          delete currentReactions[emoji];
        }
      }
      const {error: updateError} = await supabaseClient
      .from('chat_messages')
      .update({reactions: currentReactions})
      .eq('id', messageId);
      if (updateError) {
        console.error("Erro ao atualizar rea√ß√£o:", updateError);
      }
    }
    /* ======================= ADD MESSAGE TO DOM ======================== */
    function addMessageToDOM(msg, chatRef) {
      if (msg.hidden_for && Array.isArray(msg.hidden_for)) {
        if (msg.hidden_for.includes(currentUserNint)) {
          return; 
        }
      }
      registerBatchMessage(msg, chatRef);
      if (!currentChat || currentChat !== String(chatRef)) return;
      const messagesEl = document.getElementById("messages");
      if (!messagesEl) return;
      const msgDate = new Date(msg.created_at);
      const dateLabel = getDateLabel(msgDate);
      if (dateLabel !== lastDateLabel) {
        const divider = document.createElement("div");
        divider.className = "date-divider";
        divider.innerHTML = `<span>${dateLabel}</span>`;
        messagesEl.appendChild(divider);
        lastDateLabel = dateLabel;
      }
      const emptyMsg = messagesEl.querySelector(".empty-chat-placeholder");
      if (emptyMsg) emptyMsg.remove();
      let time = "";
      if (msg.edited_at) {
        time = new Date(msg.edited_at).toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"});
      } else if (msg.created_at) {
        time = new Date(msg.created_at).toLocaleTimeString([], {hour: "2-digit", minute: "2-digit"});
      }
      if (msg.batch_id) {
        addOrUpdateBatchBubble(msg, chatRef, {time});
        if (messagesEl.style.display !== "none") scrollToBottom();
        return;
      }
      const isMe = String(msg.n_int) === currentUserNint;
      let checkHTML = "";
      if (isMe) {
        let icon = "done";
        let checkClass = "sent";
        if (chatRef === "geral") {
          const numLeituras = (msg.chat_message_reads && msg.chat_message_reads[0]) ? msg.chat_message_reads[0].count : 0;
          icon = "done_all";
          checkClass = (numLeituras >= (totalTeam - 1) && totalTeam > 1) ? "read" : "delivered";
          const contador = numLeituras > 0 ? `<span style="font-size:9px; margin-left:2px; opacity:0.8;">${numLeituras}</span>` : "";
          const msgId = msg.id || "temp-" + Date.now();
          checkHTML = `<span id="check-${msgId}" class="material-icons status-checks ${checkClass}">${icon}</span>${contador}`;
        } else {
          const recipientDot = document.querySelector(`.contact[data-nint="${chatRef}"] .status-dot`);
          const isOnline = recipientDot && recipientDot.classList.contains("online");
          if (msg.read_at) {
            icon = "done_all"; checkClass = "read";
          } else if (isOnline) {
            icon = "done_all"; checkClass = "delivered";
          }
          const msgId = msg.id || "temp-" + Date.now();
          checkHTML = `<span id="check-${msgId}" class="material-icons status-checks ${checkClass}">${icon}</span>`;
        }
      }
      const div = document.createElement("div");
      div.className = "message " + (isMe ? "self" : "other");
      div.dataset.messageId = msg.id;
      div.dataset.messageText = msg.message;
      div.dataset.senderName = msg.abv_name;
      div.dataset.senderNint = msg.n_int;
      const isDeleted = msg.deleted_at !== null && msg.deleted_at !== undefined;
      if (isDeleted) div.classList.add("deleted");
      const nameHTML = (chatRef === "geral" && !isMe) ? `<div class="msg-sender-name">${msg.abv_name}</div>` : "";
      let replyPreviewHTML = "";
      if (msg.reply_to_message_id && msg.reply_to_message) {
        const replyMsg = msg.reply_to_message;
        replyPreviewHTML = `
          <div class="reply-preview" onclick="scrollToMessage('${msg.reply_to_message_id}')">
            <div class="reply-preview-name">${replyMsg.abv_name || "Utilizador"}</div>
            <div class="reply-preview-text">${replyMsg.message || ""}</div>
          </div>
        `;
      }
      const reactionsHTML = renderReactions(msg.reactions, msg.id);
      const isStarred = msg.starred_by && msg.starred_by.includes(currentUserNint);
      const starIcon = isStarred ? '<span class="star-icon" style="color: #ffd700; margin-left: 5px; font-size: 14px;">‚≠ê</span>' : "";
      let finalContentHTML = "";
      if (isDeleted) {
        finalContentHTML = '<span class="material-icons" style="font-size: 15px;">block</span> Mensagem apagada';
        
      } else {
        switch (msg.message_type) {
          case "image": {
            const batchKey = msg.batch_id || `single-${msg.id}`;
            finalContentHTML = `
              <img src="${msg.file_url}" class="chat-img" style="max-width:230px; border-radius:10px; display:block; 
                        margin-bottom:5px; cursor:pointer;" onclick="event.preventDefault(); event.stopPropagation(); 
                        openChatBatchViewer('${chatRef}','${batchKey}',0); return false;">`;
            if (msg.message) finalContentHTML += `<div class="img-caption">${escapeHTML(msg.message)}</div>`;
            break;
          }
          case "audio": {
            const audioID = `audio-${msg.id || Date.now()}`;
            finalContentHTML = `
              <div class="audio-bubble">
                <div class="audio-play-btn" onclick="toggleAudio('${audioID}', this)">
                  <span class="material-icons">play_arrow</span>
                </div>
                <div class="audio-progress-container">
                  <div class="audio-progress-bar">
                    <div id="fill-${audioID}" class="audio-progress-fill"></div>
                  </div>
                  <div class="audio-time" id="time-${audioID}">0:00</div>
                </div>
                <audio id="${audioID}" src="${msg.file_url}" ontimeupdate="updateProgress('${audioID}')" onended="resetAudioIcon('${audioID}')"></audio>
              </div>`;
            break;
          }
          case "file": {
            const fileName = msg.file_name || "";
            const isPdf = fileName.toLowerCase().endsWith(".pdf");
            const batchKey = msg.batch_id || `single-${msg.id}`;
            finalContentHTML = `${msg.preview_url ? `<img src="${msg.preview_url}" class="chat-img" style="max-width:230px; max-height:140px; 
                               border-radius:10px; display:block; margin-bottom:6px; object-fit:contain; cursor:pointer;"
                               onclick="openChatBatchViewer('${chatRef}','${batchKey}',0)">` : ""}
                               <div class="file-msg" style="display:flex; align-items:center; gap:10px; background: rgba(0,0,0,0.05); padding: 8px; 
                                           border-radius: 8px; cursor:pointer;" onclick="openChatBatchViewer('${chatRef}','${batchKey}',0)">
                                 <span class="material-icons">${isPdf ? "picture_as_pdf" : "insert_drive_file"}</span>
                                 <div style="font-size:13px; overflow:hidden; text-overflow:ellipsis;">${escapeHTML(fileName || "Documento")}</div>
                               </div>
                               ${(msg.message && !msg.message.startsWith("Ficheiro:")) ? `<div class="img-caption">${escapeHTML(msg.message)}</div>` : ""}`;
            break;
          }    
          default:
            finalContentHTML = escapeHTML(msg.message || "");
            break;
        }
      }
      div.innerHTML = `
        ${nameHTML}
        ${replyPreviewHTML}
        <span class="msg-text-content">${finalContentHTML}</span>${starIcon}
        ${reactionsHTML}
        <div class="msg-meta">${time} ${checkHTML}</div>
      `;
      if (!isDeleted && msg.edited_at) {
        const metaDiv = div.querySelector(".msg-meta");
        if (metaDiv) {
          const editTag = document.createElement("span");
          editTag.className = "message-edited-tag";
          editTag.textContent = "editada";
          metaDiv.insertBefore(editTag, metaDiv.firstChild);
        }
      }
      if (msg.is_forwarded) div.classList.add("is-forwarded");
      setupMessageInteraction(div, msg);
      messagesEl.appendChild(div);
      if (messagesEl.style.display !== "none") scrollToBottom();
    }
    /* ============================= HELPERS ============================= */
    function escapeHTML(str) {
      const s = document.createElement("span");
      s.textContent = String(str ?? "");
      return s.innerHTML;
    }
    /* ========================== BATCH BUBBLE =========================== */
    window.batchRenderTimers = window.batchRenderTimers || {};    
    function addOrUpdateBatchBubble(msg, chatRef, {time}) {
      const messagesEl = document.getElementById("messages");
      if (!messagesEl) return;
      const batchId = msg.batch_id;
      const isMe = String(msg.n_int) === currentUserNint;
      let bubble = messagesEl.querySelector(`.message.batch-bubble[data-batch-id="${batchId}"]`);
      const isNewBubble = !bubble;
      if (!bubble) {
        bubble = document.createElement("div");
        bubble.className = `message ${isMe ? "self" : "other"} batch-bubble`;
        bubble.dataset.batchId = batchId;
        bubble.dataset.chatRef = chatRef;
        bubble.dataset.senderNint = msg.n_int;
        bubble.dataset.senderName = msg.abv_name;
        bubble.dataset.messageId = msg.id;
        bubble.dataset.messageText = msg.message || "";
        if (msg.is_forwarded) {
          bubble.classList.add('is-forwarded');
        }        
        bubble.innerHTML = `
          ${(chatRef === "geral" && !isMe) ? `<div class="msg-sender-name">${escapeHTML(msg.abv_name)}</div>` : ""}
          <div class="msg-text-content">
            <div class="batch-grid" data-batch-grid="1"></div>
            <div class="batch-caption" style="display:none;"></div>
          </div>
          <div class="msg-meta">${time || ""}</div>
        `;
        bubble._batchItems = [];
        messagesEl.appendChild(bubble);
        setupMessageInteraction(bubble, msg);
      }
      const item = {id: msg.id, type: msg.message_type, url: msg.file_url, preview: msg.preview_url || null, name: msg.file_name || "", 
                    caption: (msg.message || "").trim() || ""};
      bubble._batchItems = bubble._batchItems || [];
      if (bubble._batchItems.some(x => String(x.id) === String(item.id))) return;
      bubble._batchItems.push(item);
      if (window.batchRenderTimers[batchId]) {
        clearTimeout(window.batchRenderTimers[batchId]);
      }
      window.batchRenderTimers[batchId] = setTimeout(() => {
        renderBatchBubble(bubble);
        delete window.batchRenderTimers[batchId];
        if (document.getElementById("messages").style.display !== 'none') {
          scrollToBottom();
        }
      }, 300);      
      const meta = bubble.querySelector(".msg-meta");
      if (meta) meta.textContent = time || meta.textContent || "";
    }
    function renderBatchBubble(bubble) {
      const items = bubble._batchItems || [];
      const grid = bubble.querySelector(".batch-grid");
      const captionEl = bubble.querySelector(".batch-caption");
      if (!grid) return;
      const previews = items.slice(0, 4);
      grid.innerHTML = `
        <div class="batch-grid-2x2">
          ${previews.map((it, idx) => {
            const src = it.preview || it.url;
            const isImg = (it.type === "image") || (src && /\.(png|jpg|jpeg|webp|gif)$/i.test(src));
            return `
              <div class="batch-cell" data-idx="${idx}" style="position:relative; overflow:hidden; border-radius:10px; cursor:pointer;">
                ${isImg
                  ? `<img src="${src}" style="width:100%; height:100%; object-fit:cover; display:block;">`
                  : `<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.06);">
                       <span class="material-icons">insert_drive_file</span>
                     </div>`
                }
              </div>
            `;
          }).join("")}
        </div>
        ${items.length > 4 ? `<div class="batch-more" style="position:absolute; right:8px; bottom:8px; background:rgba(0,0,0,0.55); color:white; 
                                                             font-size:12px; padding:6px 8px; border-radius:999px;">+${items.length - 4} </div>` : ""}`;
      const grid2 = grid.querySelector(".batch-grid-2x2");
      if (grid2) {
        grid2.style.display = "grid";
        grid2.style.gridTemplateColumns = "1fr 1fr";
        grid2.style.gap = "4px";
        grid2.style.width = "230px";
        grid2.style.height = "230px";
        grid2.style.position = "relative";
      }
      grid.style.position = "relative";
      grid.style.marginBottom = "6px";
      const lastCaption = [...items].reverse().find(it => it.caption && it.caption.length);
      if (captionEl) {
        if (lastCaption && lastCaption.caption) {
          captionEl.style.display = "block";
          captionEl.className = "batch-caption img-caption";
          captionEl.innerHTML = escapeHTML(lastCaption.caption);
        } else {
          captionEl.style.display = "none";
          captionEl.innerHTML = "";
        }
      }
      grid.querySelectorAll(".batch-cell").forEach(cell => {
        cell.onclick = () => {
          const idx = parseInt(cell.getAttribute("data-idx") || "0", 10);
          const chatRef = bubble.dataset.chatRef || currentChat;
          const batchId = bubble.dataset.batchId;
          if (batchId) {
            openChatBatchViewer(chatRef, batchId, idx);
          } else {
            const it = items[idx];
            if (it?.url) window.open(it.url, "_blank");
          }
        };
      });
    }
    window.batchStore = window.batchStore || new Map();
    function registerBatchMessage(msg, chatRef) {
      if (!msg?.batch_id) {
        if (msg.message_type === 'image' || msg.message_type === 'file') {
          const singleKey = `single-${msg.id}`;
          const key = `${String(chatRef)}::${singleKey}`;
          window.batchStore.set(key, [msg]);
        }
        return;
      }
      const key = `${String(chatRef)}::${String(msg.batch_id)}`;
      const arr = window.batchStore.get(key) || [];
      if (!arr.some(m => String(m.id) === String(msg.id))) arr.push(msg);
      arr.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
      window.batchStore.set(key, arr);
    }
    function getBatchItems(chatRef, batchId) {
      const key = `${String(chatRef)}::${String(batchId)}`;
      return window.batchStore.get(key) || [];
    }
    window.chatBatchViewerIndex = 0;
    window.chatBatchViewerUrl = null;
    function openChatBatchViewer(chatRef, batchId, startIndex = 0) {
      const viewer = document.getElementById("chat-batch-viewer");
      const imgEl  = document.getElementById("chat-batch-viewer-img");
      const fileCard = document.getElementById("chat-batch-viewer-file");
      const countEl = document.getElementById("chat-batch-viewer-count");
      const prevBtn = document.getElementById("chat-batch-viewer-prev");
      const nextBtn = document.getElementById("chat-batch-viewer-next");
      if (!viewer || !countEl || !prevBtn || !nextBtn) return;
      const items = getBatchItems(chatRef, batchId);
      if (!items.length) return;
      window.chatBatchViewerIndex = Math.max(0, Math.min(startIndex, items.length - 1));
      if (window.chatBatchViewerUrl) {
        try {URL.revokeObjectURL(window.chatBatchViewerUrl);} catch(e) {}
      }
      window.chatBatchViewerUrl = null;
      const item = items[window.chatBatchViewerIndex];
      const isImage = item.message_type === "image" || (item.file_url && (item.file_name || "").match(/\.(png|jpe?g|gif|webp)$/i));
      if (isImage) {
        if (fileCard) fileCard.style.display = "none";
        if (imgEl) {
          imgEl.style.display = "block";
          imgEl.src = item.file_url;
        }
      } else {
        if (imgEl) imgEl.style.display = "none";
        if (fileCard) {
          const nameEl = document.getElementById("chat-batch-file-name");
          const typeEl = document.getElementById("chat-batch-file-type");
          const iconEl = document.getElementById("chat-batch-file-icon");
          const openEl = document.getElementById("chat-batch-file-open");
          const name = item.file_name || "Ficheiro";
          const ext = (name.split(".").pop() || "").toUpperCase();
          const extLow = ext.toLowerCase();
          if (nameEl) nameEl.textContent = name;
          if (typeEl) typeEl.textContent = ext ? ext : "FICHEIRO";
          if (openEl) openEl.href = item.file_url || "#";
          if (iconEl) {
            iconEl.textContent =
              extLow === "pdf" ? "picture_as_pdf" :
              (["doc","docx","odt","rtf"].includes(extLow) ? "description" :
              (["xls","xlsx","csv","ods"].includes(extLow) ? "table_chart" :
              (["ppt","pptx","odp"].includes(extLow) ? "slideshow" :
              (["zip","rar","7z","tar","gz"].includes(extLow) ? "folder_zip" :
              "insert_drive_file"))));
          }
          fileCard.style.display = "flex";
        }
      }
      countEl.textContent = `${window.chatBatchViewerIndex + 1} / ${items.length}`;
      prevBtn.style.display = items.length > 1 ? "block" : "none";
      nextBtn.style.display = items.length > 1 ? "block" : "none";
      viewer.style.display = "flex";
      viewer.dataset.chatRef = String(chatRef);
      viewer.dataset.batchId = String(batchId);
    }
    function closeChatBatchViewer() {
      const viewer = document.getElementById("chat-batch-viewer");
      if (viewer) viewer.style.display = "none";
      const imgEl = document.getElementById("chat-batch-viewer-img");
      if (imgEl) imgEl.src = "";
    }
    function chatBatchViewerGo(delta) {
      const viewer = document.getElementById("chat-batch-viewer");
      if (!viewer) return;
      const chatRef = viewer.dataset.chatRef;
      const batchId = viewer.dataset.batchId;
      const items = getBatchItems(chatRef, batchId);
      if (!items.length) return;
      let idx = (window.chatBatchViewerIndex ?? 0) + delta;
      if (idx < 0) idx = items.length - 1;
      if (idx >= items.length) idx = 0;
      openChatBatchViewer(chatRef, batchId, idx);
    }
    function initChatBatchViewerHandlers() {
      const viewer = document.getElementById("chat-batch-viewer");
      const closeBtn = document.getElementById("chat-batch-viewer-close");
      const prevBtn = document.getElementById("chat-batch-viewer-prev");
      const nextBtn = document.getElementById("chat-batch-viewer-next");
      const imgEl = document.getElementById("chat-batch-viewer-img");
      closeBtn?.addEventListener("click", closeChatBatchViewer);
      prevBtn?.addEventListener("click", () => chatBatchViewerGo(-1));
      nextBtn?.addEventListener("click", () => chatBatchViewerGo(+1));
      viewer?.addEventListener("click", (e) => {
        if (e.target === viewer) closeChatBatchViewer();
      });
      let startX = 0;
      let isDown = false;
      const onDown = (x) => {startX = x; isDown = true;};
      const onUp = (x) => {
        if (!isDown) return;
        isDown = false;
        const dx = x - startX;
        if (Math.abs(dx) > 40) {
          if (dx < 0) chatBatchViewerGo(+1);
          else chatBatchViewerGo(-1);
        }
      };
      imgEl?.addEventListener("touchstart", (e) => onDown(e.touches[0].clientX), {passive:true});
      imgEl?.addEventListener("touchend", (e) => onUp(e.changedTouches[0].clientX), {passive:true});
      imgEl?.addEventListener("mousedown", (e) => onDown(e.clientX));
      window.addEventListener("mouseup", (e) => onUp(e.clientX));
    }
    /* ======================== GET MESSAGE DATE  ======================== */
    function getDateLabel(date) {
      const today = new Date();
      const yesterday = new Date();
      yesterday.setDate(today.getDate() - 1);
      if (date.toDateString() === today.toDateString()) return "Hoje";
      if (date.toDateString() === yesterday.toDateString()) return "Ontem";
      return date.toLocaleDateString('pt-PT', {day: '2-digit', month: '2-digit', year: 'numeric'});
    }    
    function toggleAudio(id, btn) {
      const audio = document.getElementById(id);
      const icon = btn.querySelector('.material-icons');
      if (audio.paused) {
        document.querySelectorAll('audio').forEach(a => {
          if (a.id !== id) {
            a.pause();
            const otherBtn = document.querySelector(`[onclick*="${a.id}"] .material-icons`);
            if (otherBtn) otherBtn.textContent = 'play_arrow';
          }
        });
        audio.play();
        icon.textContent = 'pause';
      } else {
        audio.pause();
        icon.textContent = 'play_arrow';
      }
    }
    function updateProgress(id) {
      const audio = document.getElementById(id);
      const fill = document.getElementById(`fill-${id}`);
      const timeDisplay = document.getElementById(`time-${id}`);
      if (!audio.duration) return;
      const percent = (audio.currentTime / audio.duration) * 100;
      fill.style.width = percent + "%";
      const mins = Math.floor(audio.currentTime / 60);
      const secs = Math.floor(audio.currentTime % 60);
      timeDisplay.textContent = `${mins}:${secs < 10 ? '0' : ''}${secs}`;
    }
    function resetAudioIcon(id) {
      const icon = document.querySelector(`[onclick*="${id}"] .material-icons`);
      if (icon) icon.textContent = 'play_arrow';
      const fill = document.getElementById(`fill-${id}`);
      if (fill) fill.style.width = "0%";
    }    
    /* ============================ OPEN CHAT ============================ */
    async function openChat(n_int, name) {
      const messagesEl = document.getElementById("messages");
      const contactListEl = document.getElementById("contact-list");
      const contactTitle = document.getElementById("contact-title");
      const chatIdInfo = document.getElementById("chat-id-info");
      const backBtn = document.getElementById("back-header");
      const pinnedEl = document.getElementById("pinned-message");
      const inputBar = document.querySelector(".chat-input-bar");    
      const typingStatusEl = document.getElementById("typing-status");
      messagesEl.innerHTML = '';
      if (typeof messagesToForward !== 'undefined' && messagesToForward.length > 0) {
        const currentCorp = localStorage.getItem("currentCorpOperNr");
        const senderName = await fetchUserName();
        const hasMultipleMedia = messagesToForward.filter(m => 
          m.message_type === 'image' || m.message_type === 'file'
        ).length > 1;        
        const forwardBatchId = hasMultipleMedia ? crypto.randomUUID() : null;        
        for (const msg of messagesToForward) {
          const payload = {n_int: currentUserNint, recipient_nint: String(n_int), corp_oper_nr: currentCorp, abv_name: senderName, message: msg.message, is_forwarded: true,
                           message_type: msg.message_type || 'text'};
          if (msg.message_type === 'image' || msg.message_type === 'file') {
            payload.file_url = msg.file_url;
            payload.file_name = msg.file_name;
            if (msg.preview_url) payload.preview_url = msg.preview_url;
            if (forwardBatchId) {
              payload.batch_id = forwardBatchId;
            }
          }          
          const {error} = await supabaseClient.from('chat_messages').insert([payload]);
          if (error) console.error("Erro ao encaminhar mensagem:", error);
        }
        messagesToForward = [];
        await new Promise(resolve => setTimeout(resolve, 150));        
        setTimeout(() => scrollToBottom(), 200);
      }
      currentChat = String(n_int);
      currentChatName = name;
      history.pushState(null, '', `?chatId=${currentChat}`);
      if (currentChat === 'geral') {
        await markGeralAsRead();
        updateUnreadBadges();
      } else {
        const badge = document.querySelector(`.contact[data-nint="${n_int}"] .unread-badge`);
        if (badge) badge.remove();
        sendReadReceipt(currentChat);
      }
      contactListEl.style.display = 'none';
      contactTitle.style.display = 'none';
      messagesEl.style.display = 'flex';
      backBtn.style.display = 'flex';
      chatIdInfo.style.display = 'block';
      typingStatusEl.style.display = 'none';
      inputBar.style.display = 'flex';
      chatIdInfo.textContent = `A conversar com: ${name}`;
      if (currentChat === 'geral') {
        pinnedEl.style.display = 'flex';
        document.getElementById("pinned-text-content").textContent = "ATEN√á√ÉO! Este chat √© supervisionado por IA. Qualquer mensagem que viole normas √©ticas ser√° imediatamente bloqueada.";
      } else {
        pinnedEl.style.display = 'none';
      }
      const savedDraft = localStorage.getItem(`draft_${currentChat}`);
      if (savedDraft) {
        inputMensage.value = savedDraft;
        inputMensage.dispatchEvent(new Event('input'));
      } else {
        inputMensage.value = "";
        inputMensage.dispatchEvent(new Event('input'));
      }
      await loadMessages(currentChat);
    }
    /* ======================== LOADING MESSAGES (FIXED) ========================= */
    async function loadMessages(chat = currentChat) {
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const messagesEl = document.getElementById("messages");
      const chatRef = chat || 'geral';
      messagesEl.innerHTML = '';
      lastDateLabel = "";
      let query = supabaseClient
        .from('chat_messages')
        .select('*, chat_message_reads(count), reply_to_message:reply_to_message_id(id, message, abv_name)')
        .eq('corp_oper_nr', currentCorp);
      if (chatRef === 'geral') {
        query = query.eq('recipient_nint', 'geral');
      } else {
        query = query.or(`and(n_int.eq.${currentUserNint},recipient_nint.eq.${chatRef}),and(n_int.eq.${chatRef},recipient_nint.eq.${currentUserNint})`);
      }
      try {
        const {data: msgs, error} = await query.order('created_at', {ascending: true});
        if (currentChat !== chatRef) return;
        if (error) return console.error(error);
        let filteredMsgs = msgs || [];    
        if (filteredMsgs.length > 0 && chatRef !== 'geral') {
          const {data: myBlocks} = await supabaseClient
            .from('user_blocks')
            .select('blocked_nint')
            .eq('blocker_nint', currentUserNint)
            .eq('corp_oper_nr', currentCorp);    
          if (myBlocks && myBlocks.length > 0) {
            const blockedList = myBlocks.map(b => b.blocked_nint);
            filteredMsgs = filteredMsgs.filter(m => !blockedList.includes(String(m.n_int)));
          }
        }
        filteredMsgs = filteredMsgs.filter(m => {
          const hiddenList = m.hidden_for || [];
          return !hiddenList.includes(currentUserNint);
        });
        if (!filteredMsgs || filteredMsgs.length === 0) {
          const emptyMsg = document.createElement("div");
          emptyMsg.className = "empty-chat-placeholder";
          emptyMsg.innerHTML = `
            <div style="text-align: center; width: 100%; padding: 20px;">
              <span class="material-icons" style="font-size: 48px; display: block; margin: 0 auto 10px auto; opacity: 0.3;">chat_bubble_outline</span>
              <span style="opacity: 0.3;">Ainda n√£o iniciou nenhuma conversa com<br><strong>${currentChatName || 'este contacto'}</strong></span>
            </div>
          `;
          messagesEl.appendChild(emptyMsg);
        } else {
          filteredMsgs.forEach(msg => addMessageToDOM(msg, chatRef));
          setTimeout(() => scrollToBottom(), 100);
          setTimeout(() => scrollToBottom(), 500);
        }
      } catch (err) {
        console.error(err);
      }
    }
    /* ====================== MARK MESSAGE AS READ ======================= */    
    async function markGeralAsRead() {
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const {data: messages} = await supabaseClient
      .from('chat_messages')
      .select('id')
      .eq('recipient_nint', 'geral')
      .eq('corp_oper_nr', currentCorp)
      .neq('n_int', currentUserNint);
      if (!messages || messages.length === 0) return;
      const {data: alreadyRead} = await supabaseClient
      .from('chat_message_reads')
      .select('message_id')
      .eq('n_int', currentUserNint);
      const readIds = new Set(alreadyRead?.map(r => r.message_id) || []);
      const toInsert = messages
      .filter(m => !readIds.has(m.id))
      .map(m => ({message_id: m.id, n_int: currentUserNint, read_at: new Date().toISOString(), corp_oper_nr: currentCorp}));
      if (toInsert.length === 0) return;
      const {error} = await supabaseClient
      .from('chat_message_reads')
      .insert(toInsert);
      if (error) {
        console.error("Erro na 2¬™ leitura:", error);
      } else {
        updateUnreadBadges();
      }
    }
    /* ========================== SEND MESSAGE (UPDATED) =========================== */
    async function sendMessage(audioText = null, audioUrl = null) {
      const inputEl = document.getElementById("chat-input");
      const sendBtn = document.getElementById("chat-send-btn");
      const text = audioText || inputEl.value.trim();
      if (!text && !audioUrl) return;
      sendBtn.disabled = true;
      if (!audioUrl) {
        inputEl.value = "";
        resetLayout();
        inputEl.dispatchEvent(new Event('input'));
      }
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      if (currentEditingMessage && !audioUrl) {
        sendBtn.disabled = false;
        return;
      }
      if (currentChat !== 'geral') {
        const {data: amIBlocked} = await supabaseClient
          .from('user_blocks')
          .select('id')
          .eq('blocker_nint', currentChat)
          .eq('blocked_nint', currentUserNint)
          .eq('corp_oper_nr', currentCorp)
          .maybeSingle();        
        if (amIBlocked) {
          sendBtn.disabled = false;
          if (!audioUrl) {
            inputEl.value = text;
            inputEl.dispatchEvent(new Event('input'));
          }
          showSystemWarning('contacto_bloqueado', 'Mensagem N√£o Enviada', 'N√£o podes enviar mensagens a este utilizador. Este utilizador bloqueou-te.');
          return;
        }
      }      
      const senderName = await fetchUserName();
      const messageData = {n_int: currentUserNint, recipient_nint: currentChat, corp_oper_nr: currentCorp, abv_name: senderName, message: text, file_url: audioUrl, message_type: audioUrl ? 'audio' : 'text'};
      if (currentReplyToMessage) {
        messageData.reply_to_message_id = currentReplyToMessage.id;
      }
      const {error} = await supabaseClient.from('chat_messages').insert([messageData]);
      sendBtn.disabled = false;
      if (error) {
        console.error(error);
        if (!audioUrl) {
          inputEl.value = text;
          inputEl.dispatchEvent(new Event('input'));
        }
      } else {
        const {data: isMuted} = await supabaseClient
          .from('user_mutes')
          .select('id')
          .eq('muter_nint', currentChat)
          .eq('muted_nint', currentUserNint)
          .eq('corp_oper_nr', currentCorp)
          .maybeSingle();
        if (!isMuted) {
          const pushText = audioUrl ? "üé§ Enviou um √Åudio." : text;
          fetch('/api/sendPush', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({recipient_nint: String(currentChat), corp_nr: currentCorp, sender_name: senderName, message_text: pushText, sender_nint: currentUserNint})
          }).catch(err => console.error("Erro no push:", err));
        }        
        cancelReply();
        clearSelection();
        scrollToBottom(true);
      }
    }
    /* ==================== TOOGLE MESSAGE SELECTION ===================== */
    function toggleMessageSelection(messageElement, messageData) {
      const isBatchBubble = messageElement.classList.contains('batch-bubble');      
      if (isBatchBubble) {
        const batchId = messageElement.dataset.batchId;
        const chatRef = messageElement.dataset.chatRef || currentChat;
        const batchItems = getBatchItems(chatRef, batchId);
        const firstItemId = batchItems[0]?.id;
        const index = selectedMessages.findIndex(m => m.id === firstItemId);        
        if (index > -1) {
          selectedMessages = selectedMessages.filter(m => 
            !batchItems.some(bi => bi.id === m.id)
          );
          messageElement.classList.remove('selected');
        } else {
          batchItems.forEach(item => {
            if (!selectedMessages.some(m => m.id === item.id)) {
              selectedMessages.push(item);
            }
          });
          messageElement.classList.add('selected');
        }
      } else {
        const messageId = messageData.id;
        const index = selectedMessages.findIndex(m => m.id === messageId);
        if (index > -1) {
          selectedMessages.splice(index, 1);
          messageElement.classList.remove('selected');
        } else {
          selectedMessages.push(messageData);
          messageElement.classList.add('selected');
        }
      }      
      const menu = document.getElementById('reaction-menu');
      if (menu) {
        if (selectedMessages.length === 1) {
        } else {
          menu.style.display = 'none';
        }
      }
      updateActionBar();
    }
    /* ======================== UPDATE ACTION BAR ======================== */
    function updateActionBar() {
      const actionBar = document.getElementById('action-bar');
      const counter = document.getElementById('action-counter');
      const replyBtn = document.getElementById('action-reply');
      const copyBtn = document.getElementById('action-copy');
      const editBtn = document.getElementById('action-edit');
      const deleteBtn = document.getElementById('action-delete');
      const starBtn = document.getElementById('action-star');
      const menu = document.getElementById('reaction-menu');      
      const count = selectedMessages.length;
      if (count === 0) {
        actionBar.classList.remove('show');
        if (menu) menu.style.display = 'none';
        return;
      }      
      actionBar.classList.add('show');
      if (count > 1 && menu) {
        menu.style.display = 'none';
      }      
      counter.textContent = count === 1 ? '1' : `${count}`;
      const isOne = count === 1;
      const firstMsg = selectedMessages[0];
      const allMine = selectedMessages.every(m => String(m.n_int) === currentUserNint);      
      if (isOne) {
        replyBtn.classList.remove('disabled');
      } else {
        replyBtn.classList.add('disabled');
      }      
      if (isOne) {
        copyBtn.classList.remove('disabled');
      } else {
        copyBtn.classList.add('disabled');
      }      
      if (isOne && String(firstMsg.n_int) === currentUserNint) {
        editBtn.classList.remove('disabled');
      } else {
        editBtn.classList.add('disabled');
      }      
      if (allMine) {
        deleteBtn.classList.remove('disabled');
      } else {
        deleteBtn.classList.add('disabled');
      }
      if (starBtn && count > 0) {
        const allStarred = selectedMessages.every(m => 
          m.starred_by && m.starred_by.includes(currentUserNint)
        );        
        const starIcon = starBtn.querySelector('.material-icons');
        if (starIcon) {
          starIcon.textContent = allStarred ? 'star' : 'star_border';
        }
      }
    }
    /* =================================================================== */
    /* ======================== ACTION FUNCTIONS ========================= */
    /* =================================================================== */
    /* ========================== ACTION REPLAY ========================== */
    function actionReply() {
      if (selectedMessages.length !== 1) return;
      const msg = selectedMessages[0];
      replyToMessage(msg.id, msg.abv_name, msg.message);
      clearSelection();
    }
    /* =========================== ACTION STAR =========================== */
    async function actionStar() {
      if (selectedMessages.length === 0) return;      
      const currentCorp = localStorage.getItem("currentCorpOperNr");      
      try {
        for (const msg of selectedMessages) {
          const {data: msgData, error: fetchError} = await supabaseClient
            .from('chat_messages')
            .select('starred_by')
            .eq('id', msg.id)
            .single();          
          if (fetchError) {
            console.error("Erro ao buscar favoritos:", fetchError);
            continue;
          }          
          let starredBy = msgData?.starred_by || [];
          const index = starredBy.indexOf(currentUserNint);          
          if (index > -1) {
            starredBy.splice(index, 1);
          } else {
            starredBy.push(currentUserNint);
          }          
          const {error: updateError} = await supabaseClient
            .from('chat_messages')
            .update({starred_by: starredBy})
            .eq('id', msg.id)
            .eq('corp_oper_nr', currentCorp);          
          if (updateError) {
            console.error("Erro ao atualizar favorito:", updateError);
          }          
          const msgIndex = selectedMessages.findIndex(m => m.id === msg.id);
          if (msgIndex > -1) {
            selectedMessages[msgIndex].starred_by = starredBy;
          }
        }        
        updateActionBar();
        setTimeout(() => {
          clearSelection();
        }, 300);        
      } catch (error) {
        console.error("Erro inesperado em actionStar:", error);
      }
    }
    /* =========================== ACTION COPY =========================== */
    function actionCopy() {
      if (selectedMessages.length !== 1) return;
      const msg = selectedMessages[0];
      copyMessageText(msg.message);
      clearSelection();
    }
    /* ========================= ACTION FORWARD ========================== */
    function actionForward() {
      if (selectedMessages.length === 0) return;
      messagesToForward = selectedMessages.map(msg => ({
        message: msg.message,
        message_type: msg.message_type || 'text',
        file_url: msg.file_url || null,
        file_name: msg.file_name || null,
        preview_url: msg.preview_url || null
      }));
      clearSelection();
      const messagesEl = document.getElementById("messages");
      const contactListEl = document.getElementById("contact-list");
      const contactTitle = document.getElementById("contact-title");
      const backBtn = document.getElementById("back-header");
      const inputBar = document.querySelector(".chat-input-bar");
      const chatIdInfo = document.getElementById("chat-id-info");
      if (window.innerWidth <= 768) {
        messagesEl.style.display = 'none';
        contactListEl.style.display = 'block';
        contactTitle.style.display = 'block';
        backBtn.style.display = 'none';
        inputBar.style.display = 'none';
        chatIdInfo.style.display = 'none';
      }
    }
    /* ========================== ACTION DELETE ========================== */
    let confirmResolver = null;
    async function actionDelete() {
      if (!selectedMessages || selectedMessages.length === 0) return;
      const allMine = selectedMessages.every(m => String(m.n_int) === currentUserNint);
      const choice = await askConfirm(selectedMessages.length, allMine);
      if (choice === 'cancel') return;
      const myNint = currentUserNint;
      for (const msg of selectedMessages) {
        if (choice === 'todos') {
          if (String(msg.n_int) === currentUserNint) {
            await supabaseClient
              .from('chat_messages')
              .update({
              deleted_at: new Date().toISOString(),
              message: 'Mensagem apagada'
            })
              .eq('id', msg.id);
          }
        } 
        else if (choice === 'mim') {
          const currentHidden = msg.hidden_for || [];
          if (!currentHidden.includes(myNint)) {
            const newHidden = [...currentHidden, myNint];
            await supabaseClient
              .from('chat_messages')
              .update({hidden_for: newHidden})
              .eq('id', msg.id);
          }
          const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
          if (msgElement) msgElement.remove();
        }
      }
      const messagesEl = document.getElementById("messages");
      if (messagesEl && messagesEl.querySelectorAll('.message').length === 0) {
        loadMessages(currentChat);
      }
      clearSelection();
    }
    function askConfirm(count, allMine) {
      const modal = document.getElementById('modal-confirm');
      if (modal) {
        const textElement = modal.querySelector('.confirm-text');
        if (textElement) {
          textElement.innerText = count === 1 ? 'Elimininar mensagem?' : `Elimininar ${count} mensagens?`;
        }
        const btnTodos = modal.querySelector('.btn-confirm-action');
        if (btnTodos) {
          btnTodos.style.display = allMine ? 'block' : 'none';
        }
        modal.style.display = 'flex';
      }
      return new Promise(resolve => {
        confirmResolver = resolve;
      });
    }
    function resConfirm(choice) {
      const modal = document.getElementById('modal-confirm');
      if (modal) modal.style.display = 'none'; 
      if (confirmResolver) {
        confirmResolver(choice);
        confirmResolver = null;
      }
    }
    /* =========================== ACTION EDIT =========================== */
    function actionEdit() {
      if (selectedMessages.length !== 1) return;
      const msg = selectedMessages[0];
      if (String(msg.n_int) !== currentUserNint) return;
      if (msg.deleted_at) return;
      currentEditingMessage = {
        id: msg.id,
        originalText: msg.message
      };
      document.getElementById('edit-text-preview').textContent = msg.message;
      document.getElementById('edit-bar').style.display = 'block';
      const inputEl = document.getElementById('chat-input');
      inputEl.value = msg.message;
      inputEl.focus();
      clearSelection();
    }
    function cancelEdit() {
      currentEditingMessage = null;
      document.getElementById('edit-bar').style.display = 'none';
      document.getElementById('chat-input').value = '';
    }
    /* ==================== KEYBOARD HANDLER (PWA FIX) ==================== */
    (function () {
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
      const THRESH_OPEN  = isIOS ? 80  : 120;
      const THRESH_CLOSE = isIOS ? 40  : 60;
      let keyboardOpen = false;
      let baseInnerHeight = window.innerHeight;
      const body = document.body;
      const mainContent = document.querySelector(".main-content");
      const messages = document.querySelector(".message-container");
      const inputBar = document.querySelector(".chat-input-bar");
      const inputEl = document.getElementById("chat-input");
      const emojiContainer = document.getElementById("full-emoji-picker-container");
      function setKb(px) {
        document.documentElement.style.setProperty("--kb", Math.max(0, Math.round(px)) + "px");
      }
      function isChatVisible() {
        const el = document.getElementById("messages");
        return el && el.style.display !== "none";
      }
      function getKeyboardHeight() {
        if (!window.visualViewport) return 0;
        const vv = window.visualViewport;
        const a = window.innerHeight - vv.height;
        const b = window.innerHeight - vv.height - vv.offsetTop;
        const c = window.innerHeight - vv.height + vv.offsetTop;
        return Math.max(0, a, b, c);
      }
      function onKeyboardOpen(kbHeight) {
        if (!isChatVisible()) return;
        keyboardOpen = true;
        body.classList.add("keyboard-open");
        messages?.classList.add("keyboard-active");
        inputBar?.classList.add("keyboard-active");
        mainContent?.classList.add("keyboard-active");
        setKb(kbHeight);
        if (emojiContainer && emojiContainer.style.display === "block") {
          emojiContainer.style.display = "none";
        }
        scrollToBottom();
        setTimeout(scrollToBottom, 120);
      }
      function onKeyboardClose() {
        keyboardOpen = false;
        body.classList.remove("keyboard-open");
        messages?.classList.remove("keyboard-active");
        inputBar?.classList.remove("keyboard-active");
        mainContent?.classList.remove("keyboard-active");
        setKb(0);
      }
      function detectKeyboard() {
        if (!keyboardOpen) baseInnerHeight = window.innerHeight;
        const kb = getKeyboardHeight();
        if (!keyboardOpen && kb > THRESH_OPEN) {
          onKeyboardOpen(kb);
        } else if (keyboardOpen && kb < THRESH_CLOSE) {
          onKeyboardClose();
        } else if (keyboardOpen) {
          setKb(kb);
          scrollToBottom();
          setTimeout(scrollToBottom, 120);
        }
      }
      if (window.visualViewport) {
        window.visualViewport.addEventListener("resize", detectKeyboard);
        window.visualViewport.addEventListener("scroll", detectKeyboard);
      } else {
        window.addEventListener("resize", detectKeyboard);
      }
      inputEl?.addEventListener("focus", () => {
        scrollToBottom();
        setTimeout(scrollToBottom, 120);
      });
      inputEl?.addEventListener("blur", () => setTimeout(detectKeyboard, 150));
      window.addEventListener("orientationchange", () => {
        setTimeout(() => {
          baseInnerHeight = window.innerHeight;
          detectKeyboard();
        }, 300);
      });
      const messagesEl = document.getElementById("messages");
      if (messagesEl) {
        const obs = new MutationObserver(() => {
          if (!isChatVisible()) onKeyboardClose();
        });
        obs.observe(messagesEl, {attributes: true, attributeFilter: ["style"]});
      }
      window.forceRestoreKeyboard = onKeyboardClose;
    })();
    /* =================== INITIALIZATION AND REALTIME =================== */
    document.addEventListener('DOMContentLoaded', async () => {
      loadCorpInfo();
      loadTheme();
      await loadContacts();
      updateUnreadBadges();
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      supabaseClient.channel('chat_realtime')
        .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'chat_messages',
        filter: `corp_oper_nr=eq.${currentCorp}`
      }, async (payload) => {
        let msg = payload.new;
        if (msg.reply_to_message_id) {
          const {data: replyData} = await supabaseClient
          .from('chat_messages')
          .select('id, message, abv_name')
          .eq('id', msg.reply_to_message_id)
          .single();
          if (replyData) {
            msg.reply_to_message = replyData;
          }
        }   
        const involved = [msg.n_int, msg.recipient_nint].map(String);
        if (currentChat === 'geral' && msg.recipient_nint === 'geral') {
          addMessageToDOM(msg, 'geral');
          if (String(msg.n_int) !== currentUserNint && document.getElementById("messages")?.style.display !== 'none') {
            const currentCorp = localStorage.getItem("currentCorpOperNr");
            const geralContact = document.querySelector('.contact[data-nint="geral"]');
            const currentBadge = geralContact?.querySelector('.unread-badge');
            const badgeValue = currentBadge ? currentBadge.textContent : null;
            supabaseClient.from('chat_message_reads').insert({message_id: msg.id, n_int: currentUserNint, read_at: new Date().toISOString(), corp_oper_nr: currentCorp}).then(() => {
              if (badgeValue && geralContact) {
                setTimeout(() => {
                  let badge = geralContact.querySelector('.unread-badge');
                  if (!badge) {
                    badge = document.createElement('div');
                    badge.className = 'unread-badge';
                    geralContact.appendChild(badge);
                  }
                  badge.textContent = badgeValue;
                }, 100);
              }
            });
          }
        } else if (currentChat !== 'geral' && involved.includes(currentUserNint) && involved.includes(currentChat)) {
          addMessageToDOM(msg, currentChat);
          if (String(msg.recipient_nint) === currentUserNint) {
            setTimeout(() => sendReadReceipt(currentChat), 100);
          }
        }
        if (String(msg.n_int) !== currentUserNint) {
          updateUnreadBadges();
        }
      })
        .on('postgres_changes', {
        event: 'UPDATE',
        schema: 'public',
        table: 'chat_messages',
        filter: `corp_oper_nr=eq.${currentCorp}`
      }, payload => {
        const msg = payload.new;
        if (msg.deleted_at) {
          const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
          if (msgElement) {
            msgElement.classList.add('deleted');
            const textContent = msgElement.querySelector('.msg-text-content');
            if (textContent) {
              textContent.innerHTML = '<span class="material-icons" style="font-size: 15px;">block</span> Mensagem apagada';
            }
          }
        }
        if (msg.reactions !== undefined) {
          const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
          if (msgElement) {
            const oldReactions = msgElement.querySelector('.message-reactions');
            if (oldReactions) oldReactions.remove();
            const newReactionsHTML = renderReactions(msg.reactions, msg.id);            
            if (newReactionsHTML) {
              const textContent = msgElement.querySelector('.msg-text-content');
              if (textContent) {
                textContent.insertAdjacentHTML('afterend', newReactionsHTML);
              }
            }
          }
        }        
        if (msg.starred_by !== undefined) {
        const msgElement = document.querySelector(`[data-message-id="${msg.id}"]`);
        if (msgElement) {
          const oldStar = msgElement.querySelector('.star-icon');
          if (oldStar) oldStar.remove();
          const isStarred = msg.starred_by && msg.starred_by.includes(currentUserNint);
          if (isStarred) {
            const textContent = msgElement.querySelector('.msg-text-content');
            if (textContent) {
              textContent.insertAdjacentHTML('afterend', 
                '<span class="star-icon" style="color: #ffd700; margin-left: 5px; font-size: 14px;">‚≠ê</span>'
              );
            }
          }
        }
      }
        if (msg.read_at && String(msg.n_int) === currentUserNint) {
          const checkEl = document.getElementById(`check-${msg.id}`);
          if (checkEl) {
            checkEl.classList.remove('sent', 'delivered');
            checkEl.classList.add('read');
            checkEl.textContent = 'done_all';
          }
        }
      }).subscribe();
      supabaseClient.channel('reads_realtime')
        .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'chat_message_reads',
        filter: `corp_oper_nr=eq.${currentCorp}`
      }, () => {
        updateUnreadBadges();
      }).subscribe();    
      const readReceiptChannel = supabaseClient.channel('read-receipts');
      readReceiptChannel.on('broadcast', {event: 'read'}, (payload) => {
        if (String(payload.payload.readerNint) === currentChat) {
          document.querySelectorAll('.status-checks').forEach(check => {
            if (!check.classList.contains('read')) {
              check.classList.remove('sent', 'delivered');
              check.classList.add('read');
              check.textContent = 'done_all';
            }
          });
        }
      }).subscribe();
      const typingChannel = supabaseClient.channel('typing-status', {config: {broadcast: {ack: true, self: false}}});
      typingChannel.on('broadcast', {event: 'typing'}, (payload) => {
        const data = payload.payload;
        if (currentChat !== 'geral' && String(data.nint) === currentChat) {
          const statusEl = document.getElementById("typing-status");
          statusEl.textContent = `${currentChatName} est√° a escrever...`;
          statusEl.style.display = data.isTyping ? 'block' : 'none';
          if (data.isTyping) scrollToBottom();
        }
      }).subscribe();
      window.readReceiptChannel = readReceiptChannel;
      const presenceChannel = supabaseClient.channel('presence-cb360', {
        config: {presence: {key: String(currentUserNint)}},
      });
      presenceChannel.on('presence', {event: 'sync'}, () => {
        const state = presenceChannel.presenceState();
        document.querySelectorAll('.status-dot').forEach(dot => dot.classList.remove('online'));
        Object.keys(state).forEach((nint) => {
          const dot = document.querySelector(`.contact[data-nint="${nint}"] .status-dot`);
          if (dot) dot.classList.add('online');
        if (currentChat !== 'geral' && String(nint) === currentChat) {
          document.querySelectorAll('.status-checks.sent').forEach(check => {
            check.classList.remove('sent');
            check.classList.add('delivered');
            check.textContent = 'done_all';
          });
        }
        });
      }).subscribe(async (status) => {
        if (status === 'SUBSCRIBED') {
          await presenceChannel.track({
            online_at: new Date().toISOString(),
            nint: String(currentUserNint)
          });
        }
      });
      let typingTimer;
      const inputEl = document.getElementById("chat-input");
      inputEl.addEventListener('input', () => {
        if (currentChat === 'geral') return;
        typingChannel.send({type: 'broadcast', event: 'typing', payload: {nint: String(currentUserNint), isTyping: true}});
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
          typingChannel.send({type: 'broadcast', event: 'typing', payload: {nint: String(currentUserNint), isTyping: false}});
        }, 2000);
      });    
      document.getElementById("chat-send-btn").onclick = () => sendMessage();
      inputEl.onkeydown = e => {
        if (e.key === 'Enter') {
          e.preventDefault();
          sendMessage();
        }
      };
      inputEl.addEventListener('focus', () => {
        if (currentChat !== 'geral') sendReadReceipt(currentChat);
      });
      const attachmentBtn = document.getElementById('attachment-btn');
      const docInput = document.getElementById('doc-file-input');
      if (attachmentBtn && docInput) {
        attachmentBtn.onclick = (e) => {
          e.preventDefault();
          docInput.click();
        };
        docInput.onchange = (e) => {
          const files = Array.from(e.target.files || []);
          if (!files.length) return;
          const allImages = files.every(f => f.type?.startsWith("image/"));
          window.attachMode =
            (files.length >= 2 && allImages) ? "files" :
            (files.length >= 2) ? "multi" : "file";
          window.pendingAttachFiles = files;
          window.pendingAttachFile = (window.attachMode === "file") ? files[0] : null;
          const file = files[0];
          const attachModal = document.getElementById("attach-modal");
          const attachImg = document.getElementById("attach-preview-img");
          const attachCaption = document.getElementById("attach-caption");
          const attachFileCard = document.getElementById("attach-file-card");
          const attachFileName = document.getElementById("attach-file-name");
          const attachFileType = document.getElementById("attach-file-type");
          const attachFileIcon = document.getElementById("attach-file-icon");
          const attachGrid = document.getElementById("attach-grid");
          if (window.previewUrl) URL.revokeObjectURL(window.previewUrl);
          window.previewUrl = null;
          if (window.attachMode === "files") {
            if (attachImg) {attachImg.src = ""; attachImg.style.display = "none";}
            if (attachFileCard) attachFileCard.style.display = "none";
            renderAttachGrid(files);
            if (attachGrid) {
              attachGrid.querySelectorAll(".attach-grid-cell").forEach(cell => {
                cell.onclick = () => {
                  const idx = parseInt(cell.getAttribute("data-idx") || "0", 10);
                  if (idx < files.length) openAttachViewer(idx);
                };
              });
            }
            if (attachCaption) attachCaption.value = "";
            if (attachModal) attachModal.style.display = "flex";
            setTimeout(() => attachCaption?.focus(), 150);
            e.target.value = "";
            return;
          }
          if (attachGrid) attachGrid.style.display = "none";
          const isImage = file.type?.startsWith("image/");
          if (isImage && files.length === 1) {
            window.previewUrl = URL.createObjectURL(file);
            attachImg.src = window.previewUrl;
            attachImg.style.display = "block";
            if (attachFileCard) attachFileCard.style.display = "none";
          } else {
            if (attachImg) attachImg.style.display = "none";
            if (attachFileCard && attachFileName && attachFileType && attachFileIcon) {
              if (files.length > 1) {
                attachFileIcon.textContent = "attach_file";
                attachFileName.textContent = `${files.length} ficheiro(s) selecionado(s)`;
                attachFileType.textContent = "MULTI";
              } else {
                const name = file.name || "Ficheiro";
                const ext = (name.split(".").pop() || "").toUpperCase();
                const extLow = ext.toLowerCase();
                attachFileName.textContent = name;
                attachFileType.textContent = ext ? ext : "FICHEIRO";
                attachFileIcon.textContent =
                  extLow === "pdf" ? "picture_as_pdf" :
                    (["doc","docx","odt","rtf"].includes(extLow) ? "description" :
                    (["xls","xlsx","csv","ods"].includes(extLow) ? "table_chart" :
                    (["ppt","pptx","odp"].includes(extLow) ? "slideshow" :
                    (["zip","rar","7z","tar","gz"].includes(extLow) ? "folder_zip" :
                     "insert_drive_file"))));
              }
              attachFileCard.style.display = "flex";
            }
          }
          if (attachCaption) attachCaption.value = "";
          if (attachModal) attachModal.style.display = "flex";
          setTimeout(() => attachCaption?.focus(), 150);
          e.target.value = "";
        };
      }
      initAttachViewerHandlers();
      initChatBatchViewerHandlers();
      document.addEventListener('contextmenu', (e) => {
        if (e.target.classList.contains('chat-img') || 
            e.target.closest('.batch-cell') || 
            e.target.closest('.batch-grid')) {
          e.preventDefault();
          e.stopPropagation();
          return false;
        }
      });
      document.addEventListener('touchstart', (e) => {
        if (e.target.classList.contains('chat-img') || 
            e.target.closest('.batch-cell')) {
          e.target.style.webkitTouchCallout = 'none';
        }
      }, {passive: true});
    });
    /* ======================= MESSAGE INTERACTION ======================= */
    function setupMessageInteraction(messageElement, messageData) {
      let pressTimer;
      let isLongPress = false;
      messageElement.addEventListener('touchstart', (e) => {
        isLongPress = false;
        pressTimer = setTimeout(() => {
          isLongPress = true;
          if (navigator.vibrate) navigator.vibrate(50);
          const menu = document.getElementById('reaction-menu');
          if (menu) menu.style.display = 'none';
          toggleMessageSelection(messageElement, messageData);
          if (selectedMessages.length === 1 && menu) {
            reactionTargetId = messageData.id;
            const scrollContainer = menu.querySelector('.emoji-scroll-container');
            if (scrollContainer) scrollContainer.scrollLeft = 0;
            menu.style.display = 'flex';
            const menuWidth = 215; 
            const menuHeight = 45;
            const rect = messageElement.getBoundingClientRect();
            let posX = rect.left + (rect.width / 2) - (menuWidth / 2);
            if (posX < 10) posX = 10;
            if (posX + menuWidth > window.innerWidth) {
              posX = window.innerWidth - menuWidth - 10;
            }
            let posY = rect.bottom + 10;
            if (posY + menuHeight > window.innerHeight - 60) {
              posY = rect.top - menuHeight - 10;
            }
            menu.style.left = posX + 'px';
            menu.style.top = posY + 'px';
          }
        }, 500);
      }, {passive: true});
      messageElement.addEventListener('touchend', () => clearTimeout(pressTimer));
      messageElement.addEventListener('touchmove', () => clearTimeout(pressTimer));
      messageElement.addEventListener('click', (e) => {
        const menu = document.getElementById('reaction-menu');
        if (selectedMessages.length > 0) {
          e.preventDefault();
          toggleMessageSelection(messageElement, messageData);
          if (menu) menu.style.display = 'none';
        }
      });
    }
    document.addEventListener('touchstart', (e) => {
      const menu = document.getElementById('reaction-menu');
      if (menu && menu.style.display === 'flex') {
        const clicouNoMenu = menu.contains(e.target);
        const clicouNaMensagem = e.target.closest('.message');
        const clicouNaBarra = e.target.closest('#action-bar');
        if (clicouNaBarra) {
          menu.style.display = 'none';
          return; 
        }
        if (!clicouNoMenu && !clicouNaMensagem) {
          menu.style.display = 'none';
      clearSelection();
        }
      }
    }, {passive: true});
    function clearSelection() {
      selectedMessages = [];
      document.querySelectorAll('.message.selected').forEach(el => {
        el.classList.remove('selected');
      });      
      const actionBar = document.getElementById('action-bar');
      if (actionBar) actionBar.classList.remove('show');      
      const menu = document.getElementById('reaction-menu');
      if (menu) menu.style.display = 'none';
      const starBtn = document.getElementById('action-star');
      if (starBtn) {
        const starIcon = starBtn.querySelector('.material-icons');
        if (starIcon) {
          starIcon.textContent = 'star_border';
        }
      }      
      reactionTargetId = null;
    }
    /* ======================== HANDLE REACTION CLICK ======================== */
    async function handleReactionClick(emoji) {
      if (!reactionTargetId) {
        console.warn("Nenhuma mensagem selecionada para reagir.");
        return;
      }
      const targetId = reactionTargetId;
      const menu = document.getElementById('reaction-menu');
      if (menu) menu.style.display = 'none';
      clearSelection();
      try {
        const {data: msg, error: fetchError} = await supabaseClient
        .from('chat_messages')
        .select('reactions')
        .eq('id', targetId)
        .single();
        if (fetchError) {
          console.error("Erro ao ler do Supabase:", fetchError);
          return;
        }
        let currentReactions = msg.reactions || {};
        if (currentReactions[currentUserNint] === emoji) {
          delete currentReactions[currentUserNint];
        } else {
          currentReactions[currentUserNint] = emoji;
        }
        const {error: updateError} = await supabaseClient
        .from('chat_messages')
        .update({reactions: currentReactions})
        .eq('id', targetId);
        if (updateError) {
          console.error("Erro ao gravar rea√ß√£o:", updateError);
        } else {
          
        }
      } catch (err) {
        console.error("Erro inesperado:", err);
      }
    }
    function openFullEmojiPicker() {
      const menu = document.getElementById('reaction-menu');
      const pickerContainer = document.getElementById('full-emoji-picker-container');
      const picker = pickerContainer.querySelector('emoji-picker');    
      if (menu) menu.style.display = 'none';
      pickerContainer.style.display = 'block';
      if (!picker.dataset.listenerSet) {
        picker.addEventListener('emoji-click', event => {
          handleReactionClick(event.detail.unicode);
          pickerContainer.style.display = 'none';
        });
        picker.dataset.listenerSet = "true";
      }
    }
    document.addEventListener('touchstart', (e) => {
      const menu = document.getElementById('reaction-menu');
      const picker = document.getElementById('full-emoji-picker-container');
      if (menu && menu.style.display === 'flex') {
        if (!menu.contains(e.target) && !picker.contains(e.target)) {
          setTimeout(() => {
            if (selectedMessages.length !== 1) {
              menu.style.display = 'none';
              picker.style.display = 'none';
            }
          }, 50);
        }
      }
    }, {passive: true});    
    document.addEventListener('click', (e) => {
      const menu = document.getElementById('reaction-menu');
      const picker = document.getElementById('full-emoji-picker-container');      
      if (menu && !menu.contains(e.target) && !picker.contains(e.target) && selectedMessages.length === 0) {
        menu.style.display = 'none';
        picker.style.display = 'none';
      }
    });
    /* ======================== REPLY TO MESSAGE ========================= */
    function replyToMessage(messageId, senderName, messageText) {
      currentReplyToMessage = {
        id: messageId,
        name: senderName,
        text: messageText
      };
      document.getElementById('reply-to-name').textContent = senderName;
      document.getElementById('reply-to-text').textContent = messageText;
      document.getElementById('reply-bar').style.display = 'block';
      document.getElementById('chat-input').focus();      
    }
    /* ========================== CANCEL REPLY =========================== */
    function cancelReply() {
      currentReplyToMessage = null;
      document.getElementById('reply-bar').style.display = 'none';
    }
    /* ======================== COPY MESSAGE TEXT ======================== */
    function copyMessageText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).then(() => {
          showSystemWarning('sucesso_copiar', 'Copiado!', 'O texto j√° est√° na tua √°rea de transfer√™ncia.');
        }).catch(() => {
          fallbackCopy(text);
        });
      } else {
        fallbackCopy(text);
      }
    }
    function fallbackCopy(text) {
      const textArea = document.createElement('textarea');
      textArea.value = text;
      textArea.style.position = 'fixed';
      textArea.style.left = '-9999px';
      document.body.appendChild(textArea);
      textArea.select();
      try {
        document.execCommand('copy');
        showSystemWarning('sucesso_copiar', 'Copiado!', 'O texto j√° est√° na tua √°rea de transfer√™ncia.');
      } catch (err) {
        showSystemWarning('erro_copiar', 'Erro ao Copiar', 'Ocorreu um problema ao tentar copiar o texto automaticamente.');
      }
      document.body.removeChild(textArea);
    }
    /* ========================= DELETE MESSAGE ========================== */
    async function deleteMessage(messageId) {
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const {error} = await supabaseClient
      .from('chat_messages')
      .update({
        deleted_at: new Date().toISOString(),
        message: 'Mensagem apagada'
      })
      .eq('id', messageId)
      .eq('n_int', currentUserNint)
      .eq('corp_oper_nr', currentCorp);
      if (error) {
        console.error('Erro ao apagar:', error);
      } else {
        const msgElement = document.querySelector(`[data-message-id="${messageId}"]`);
        if (msgElement) {
          msgElement.classList.add('deleted');
          const textContent = msgElement.querySelector('.msg-text-content');
          if (textContent) {
            textContent.innerHTML = '<span class="material-icons" style="font-size: 15px;">block</span> Mensagem apagada';
          }
        }
      }
    }
    /* ======================== SCROLL TO MESSAGE ======================== */
    function scrollToMessage(messageId) {
      const msgElement = document.querySelector(`[data-message-id="${messageId}"]`);
      if (msgElement) {
        msgElement.scrollIntoView({behavior: 'smooth', block: 'center'});
        msgElement.style.background = 'rgba(188, 217, 255, 0.5)';
        setTimeout(() => {
          msgElement.style.background = '';
        }, 1500);
      }
    }
    /* ======================= SEND READ RECIPIENT ======================= */
    async function sendReadReceipt(toNint) {
      if (toNint === 'geral' || !toNint) return;    
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const {error} = await supabaseClient
        .from('chat_messages')
        .update({read_at: new Date().toISOString()})
        .eq('n_int', toNint)
        .eq('recipient_nint', currentUserNint)
        .eq('corp_oper_nr', currentCorp)
        .is('read_at', null);
      if (!error && window.readReceiptChannel) {
        window.readReceiptChannel.send({
          type: 'broadcast',
          event: 'read',
          payload: {readerNint: String(currentUserNint)}
        });
      }
    }    
    /* ==================== CONTACT MENU FUNCTIONS ======================= */
    let currentContactMenuTarget = null;
    async function openContactMenu(contactNint, contactName) {
      currentContactMenuTarget = {nint: contactNint, name: contactName};
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const {data: blockData} = await supabaseClient
      .from('user_blocks')
      .select('id')
      .eq('blocker_nint', currentUserNint)
      .eq('blocked_nint', contactNint)
      .eq('corp_oper_nr', currentCorp) 
      .maybeSingle();
      const {data: muteData} = await supabaseClient
      .from('user_mutes') .select('id')
      .eq('muter_nint', currentUserNint)
      .eq('muted_nint', contactNint)
      .eq('corp_oper_nr', currentCorp)
      .maybeSingle(); 
      document.getElementById('contact-menu-title').textContent = contactName;
      const blockBtn = document.getElementById('contact-menu-block');
      const muteBtn = document.getElementById('contact-menu-mute');
      const clearBtn = document.getElementById('contact-menu-clear');
      if (blockData) {
        blockBtn.innerHTML = '<span class="material-icons" style="vertical-align: middle; margin-bottom: 4px; margin-right: 8px;">lock_open</span>Desbloquear';
        blockBtn.style.color = '#ccc'; 
      } else {
        blockBtn.innerHTML = '<span class="material-icons" style="vertical-align: middle; margin-bottom: 4px; margin-right: 8px;">block</span>Bloquear';
        blockBtn.style.color = '#ccc'; 
      } 
      if (muteData) {
        muteBtn.innerHTML = '<span class="material-icons" style="vertical-align: middle; margin-bottom: 4px; margin-right: 8px;">notifications_active</span>Ativar notifica√ß√µes'; 
        muteBtn.style.color = '#ccc';
      } else {
        muteBtn.innerHTML = '<span class="material-icons" style="vertical-align: middle; margin-bottom: 4px; margin-right: 8px;">notifications_off</span>Silenciar'; 
        muteBtn.style.color = '#ccc'; 
      }
      if (String(contactNint) === 'geral') {
        document.getElementById('contact-menu-overlay').style.display = 'flex';
        blockBtn.style.display = 'none';
        clearBtn.style.display = 'none';
        muteBtn.onclick = () => toggleMuteUser();
        return;
      }
      blockBtn.style.display = 'block';
      muteBtn.style.display = 'block';
      clearBtn.style.display = 'block';
      blockBtn.onclick = () => toggleBlockUser();
      muteBtn.onclick = () => toggleMuteUser();
      document.getElementById('contact-menu-clear').onclick = () => clearConversation();
      document.getElementById('contact-menu-overlay').style.display = 'flex';
    } 
    function closeContactMenu() {
      document.getElementById('contact-menu-overlay').style.display = 'none';
      currentContactMenuTarget = null;
    }
    /* ======================== TOGGLE BLOCK USER ======================== */
  
    async function toggleBlockUser() {
      if (!currentContactMenuTarget) return;      
      const targetNint = currentContactMenuTarget.nint;
      const targetName = currentContactMenuTarget.name;
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const {data: existing} = await supabaseClient
        .from('user_blocks')
        .select('id')
        .eq('blocker_nint', currentUserNint)
        .eq('blocked_nint', targetNint)
        .eq('corp_oper_nr', currentCorp)
        .maybeSingle();      
      if (existing) {
        const {error} = await supabaseClient
          .from('user_blocks')
          .delete()
          .eq('id', existing.id);        
        if (!error) {
          closeContactMenu();
          showSystemWarning('sucesso_desbloqueio', 'Contacto Dispon√≠vel', `${targetName} foi desbloqueado com sucesso!`);
          if (currentChat === targetNint) {
            await loadMessages(currentChat);
          }
        } else {
          showSystemWarning('erro_desbloqueio', 'A√ß√£o Falhou', 'Ocorreu um erro t√©cnico ao tentar desbloquear o contacto. Tenta novamente.');
        }
      } else {
        const {error} = await supabaseClient
          .from('user_blocks')
          .insert([{blocker_nint: currentUserNint, blocked_nint: targetNint, corp_oper_nr: currentCorp}]);        
        if (!error) {
          closeContactMenu();
          showSystemWarning('sucesso_bloqueio', 'Contacto Bloqueado', `${targetName} foi bloqueado com sucesso. N√£o ver√°s mais mensagens deste utilizador.`);
          if (currentChat === targetNint) {
            await loadMessages(currentChat);
          }
        } else {
          showSystemWarning('erro_bloqueio_tecnico', 'Erro de Seguran√ßa', 'Ocorreu um problema ao tentar processar o bloqueio. O contacto ainda est√° ativo.');
        }
      }
      const id = String(targetNint);
      if (existing) blockedSetCache.delete(id);
      else blockedSetCache.add(id);
      renderContactStatus(id, {
        blocked: blockedSetCache.has(id),
        muted: mutedSetCache.has(id)
      });
    }    
    /* ========================= TOGGLE MUTE USER ======================== */
    async function toggleMuteUser() {
      if (!currentContactMenuTarget) return;      
      const targetNint = currentContactMenuTarget.nint;
      const targetName = currentContactMenuTarget.name;
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const {data: existing} = await supabaseClient
        .from('user_mutes')
        .select('id')
        .eq('muter_nint', currentUserNint)
        .eq('muted_nint', targetNint)
        .eq('corp_oper_nr', currentCorp)
        .maybeSingle();      
      if (existing) {
        const {error} = await supabaseClient
          .from('user_mutes')
          .delete()
          .eq('id', existing.id);        
        if (!error) {
          closeContactMenu();
          showSystemWarning('sucesso_notificacoes', 'Notifica√ß√µes Ativas', `Voltaste a ativar os alertas para ${targetName}.`);
        } else {
          showSystemWarning('erro_ativar_som', 'Falha na Configura√ß√£o', 'Ocorreu um erro ao tentar ligar o som das notifica√ß√µes.');
        }
      } else {
        const {error} = await supabaseClient
          .from('user_mutes')
          .insert([{muter_nint: currentUserNint, muted_nint: targetNint, corp_oper_nr: currentCorp}]);        
        if (!error) {
          closeContactMenu();
          showSystemWarning('sucesso_silenciamento', 'Contacto Silenciado', `${targetName} foi silenciado. N√£o receber√°s notifica√ß√µes desta conversa.`);
        } else {
          showSystemWarning('erro_silenciar_tecnico', 'A√ß√£o Falhou', 'Ocorreu um problema ao tentar silenciar as notifica√ß√µes deste contacto.');
        }
      }
      const id = String(targetNint);
      if (id === 'geral') {
        muteGeralCache = !existing;
        renderContactStatus('geral', {blocked: false, muted: muteGeralCache});
      } else {
        if (existing) mutedSetCache.delete(id);
        else mutedSetCache.add(id);
        renderContactStatus(id, {
          blocked: blockedSetCache.has(id),
          muted: mutedSetCache.has(id)
        });
      }
    }
    /* ======================= CLEAR CONVERSATION (L√ìGICA HIDDEN) ======================== */
    async function clearConversation() {
      if (!currentContactMenuTarget) return;
      const targetNint = currentContactMenuTarget.nint;
      const targetName = currentContactMenuTarget.name;
      const currentCorp = localStorage.getItem("currentCorpOperNr");
      const myNint = localStorage.getItem("currentUserNint") || currentUserNint; 
      const confirmed = await confirmCriticalAction(targetName);
      if (!confirmed) return;
      try {
        const {error} = await supabaseClient
        .from('chat_messages')
        .update({hidden_for: [myNint]})
        .eq('corp_oper_nr', currentCorp) 
        .or(`and(n_int.eq.${myNint},recipient_nint.eq.${targetNint}),and(n_int.eq.${targetNint},recipient_nint.eq.${myNint})`);
        if (error) throw error;
        closeContactMenu();
        showSystemWarning('sucesso_limpeza', 'Conversa Eliminada.', `A conversa foi eliminada do teu hist√≥rico.`);
        if (currentChat === targetNint) {
          const messagesEl = document.getElementById("messages");
          if (messagesEl) messagesEl.innerHTML = '';
        }
      } catch (error) {
        console.error('Erro no update/hidden:', error);        
        showSystemWarning('erro_eliminar_tecnico', 'Erro', 'N√£o foi poss√≠vel ocultar a conversa.');
      }
    }
    /* ======================== ADVISORS MANAGER ========================= */  
    function showSystemWarning(tipo, tituloCustom = '', mensagemCustom = '') {
      const modal = document.getElementById('modal-alert-system');
      const mIcon = document.getElementById('alerta-icon');
      const mTitle = document.getElementById('alerta-titulo');
      const mMessage = document.getElementById('alerta-mensagem');
      if (!modal || !mIcon || !mTitle || !mMessage) return;
      let iconName = 'info';
      let iconColor = '#64748b';
      let titulo = tituloCustom || 'Aviso';
      let mensagem = mensagemCustom || 'Ocorreu uma atualiza√ß√£o no sistema.';
      switch (tipo) {
        case 'mic_bloqueado':
          iconName = 'mic_off'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Microfone Bloqueado';
          break;
        case 'mic_nao_encontrado':
          iconName = 'settings_voice'; iconColor = '#ffb300';
          titulo = tituloCustom || 'Hardware n√£o detetado';
          break;
        case 'limite_tamanho':
          iconName = 'error_outline'; iconColor = '#ffb300';
          titulo = tituloCustom || 'Ficheiro muito grande';
          break;
        case 'upload_falha_tecnica':
          iconName = 'cloud_off'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Erro de Transfer√™ncia';
          break;
        case 'contacto_bloqueado':
          iconName = 'person_off'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Mensagem N√£o Enviada';
          break;
        case 'sucesso_bloqueio':
          iconName = 'block'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Contacto Bloqueado';
          break;
        case 'erro_bloqueio_tecnico':
          iconName = 'gpp_bad'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Erro de Seguran√ßa';
          break;
        case 'sucesso_desbloqueio':
          iconName = 'lock_open'; iconColor = '#22c55e';
          titulo = tituloCustom || 'Contacto Dispon√≠vel';
          break;
        case 'erro_desbloqueio':
          iconName = 'lock'; iconColor = '#ef4444';
          titulo = tituloCustom || 'A√ß√£o Falhou';
          break;
        case 'sucesso_notificacoes':
          iconName = 'notifications_active'; iconColor = '#22c55e';
          titulo = tituloCustom || 'Notifica√ß√µes Ativas';
          break;
        case 'erro_ativar_som':
          iconName = 'notification_important'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Erro nas Notifica√ß√µes';
          break;
        case 'sucesso_silenciamento':
          iconName = 'notifications_off'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Contacto Silenciado';
          break;
        case 'erro_silenciar_tecnico':
          iconName = 'notifications_active'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Erro ao Silenciar';
          break;
        case 'sucesso_copiar':
          iconName = 'check_circle'; iconColor = '#22c55e';
          titulo = tituloCustom || 'Copiado!';
          break;
        case 'erro_copiar':
          iconName = 'content_paste_off'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Erro ao Copiar';
          break;
        case 'sucesso_limpeza':
          iconName = 'delete_sweep'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Limpeza Conclu√≠da';
          break;
        case 'permissao_negada_limpeza':
          iconName = 'admin_panel_settings'; iconColor = '#ffb300';
          titulo = tituloCustom || 'A√ß√£o Restrita';
          break;
        case 'erro_eliminar_tecnico':
          iconName = 'dangerous'; iconColor = '#ef4444';
          titulo = tituloCustom || 'Erro de Sistema';
          break;
      }
      mIcon.innerText = iconName;
      mIcon.style.color = iconColor;
      mTitle.innerText = titulo;
      mMessage.innerText = mensagem;
      modal.style.display = 'flex';
    }
    function closeAlertSystem() {
      document.getElementById('modal-alert-system').style.display = 'none';
    }
    function confirmCriticalAction(userName) {
      return new Promise((resolve) => {
        const modalSistema = document.getElementById('contact-menu-overlay');
        const criticalModal = document.getElementById('modal-confirm-critical');
        const mensagem = document.getElementById('critical-message');
        const btnEliminar = document.getElementById('btn-confirm-delete');
        if (modalSistema) {
          modalSistema.style.display = 'none';
        }
        mensagem.innerHTML = `Isto ir√° eliminar <b>TODA</b> a conversa com <strong>${userName}</strong>.<br><br><span style="color: #ef4444;">
                              Esta a√ß√£o N√ÉO PODE ser desfeita!</span>`;
        criticalModal.style.display = 'flex';
        btnEliminar.onclick = () => {
          criticalModal.style.display = 'none';
          resolve(true);
        };
        window.closeConfirmCritical = () => {
          criticalModal.style.display = 'none';
          resolve(false);
        };
        criticalModal.onclick = (e) => {
          if (e.target === criticalModal) closeConfirmCritical();
        };
      });
    }
    async function handleEliminarConversa() {
      const confirmed = await confirmCriticalAction(targetName);
      if (confirmed) {
        console.log("A iniciar limpeza pesada na base de dados...");
      } else {
        console.log("Elimina√ß√£o cancelada pelo utilizador.");
      }
    }
  </script>
</body>
</html>

