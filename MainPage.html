<!DOCTYPE html>
<html lang="pt-PT">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CB360 Mobile">
  <title>CB360 Mobile 1681</title>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">  
  <style>
    /* ==================== BODY ==================== */
    * {margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent !important; -webkit-touch-callout: none !important;}
    body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%); min-height: 100vh; user-select: none;
          transition: all 0.3s ease; display: flex; flex-direction: column; height: 100vh; height: 100dvh; overflow: hidden;}
    /* ============= DARK MODE OPTIONS ============== */
    .dark-mode {background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #fff;}
    .dark-mode .main-content {background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);}
    .dark-mode .msg-sender-name {color: #ffffff !important;}
    .dark-mode #contact-list::-webkit-scrollbar-thumb, .dark-mode #chat-messages::-webkit-scrollbar-thumb {background: rgba(255, 255, 255, 0.15);}
    .dark-mode #contact-list::-webkit-scrollbar-thumb:hover, .dark-mode #chat-messages::-webkit-scrollbar-thumb:hover {background: rgba(255,255, 255, 0.3);}
    .dark-mode .contact-id-info {color: #ddd;}
    .dark-mode .contact {background: rgba(255, 255, 255, 0.08); color: #fff; border: 1px solid rgba(255, 255, 255, 0.15); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);}
    .dark-mode .contact:hover {background: rgba(255, 255, 255, 0.12);}
    .dark-mode .unread-badge {background-color: #f44336; box-shadow: 0 0 8px rgba(244, 67, 54, 0.4);}
    .dark-mode .chat-input-bar .input-wrapper {background: rgba(255, 255, 255, 0.15); transition: bottom 0.2s ease-in-out;}    
    .dark-mode .chat-input-bar {background: transparent;}
    .dark-mode .chat-input-bar button {color: #ddd;}
    .dark-mode .chat-input-bar input {background: transparent; border: none; color: #fff;}
    .dark-mode .chat-id-info {color: #f9a825; background: rgba(255, 255, 255, 0.10); border-left: 4px solid #f9a825;}
    .dark-mode #back-header {color: #ddd;}
    .dark-mode .pinned-banner {background: rgba(68, 68, 68, 0.95); border-bottom: 1px solid #555; color: #f9a825;}
    .dark-mode #messages div[style*="color: #888"] {color: #aaa !important;}
    .dark-mode .date-divider span {background: rgba(255, 255, 255, 0.10); color: #ddd;}
    .dark-mode .message.self {background: #005c4b; color: #e9edef;}
    .dark-mode .message.self::after {border-left-color: #005c4b;}    
    .dark-mode .message.other {background: #386580; color: #e9edef;}
    .dark-mode .message.other::after {border-right-color: #386580;}
    .dark-mode .message.other .msg-meta {color: rgba(255, 255, 255, 0.5) !important;}
    .dark-mode .typing-indicator {background: rgba(40, 40, 40, 0.50); color: #bbb !important; border: 1px solid rgba(255,255,255,0.1);}
    .dark-mode .action-bar-counter {color: #fff;}
    .dark-mode .action-bar {background: #2d2d2d; border-bottom-color: #f9a825;}
    .dark-mode .action-bar-close {color: #f9a825;}
    .dark-mode .action-btn {color: #f9a825;}
    .dark-mode .action-btn:active {background: rgba(249, 168, 37, 0.1);}
    .dark-mode {--selection-color: #2b5278; }
    .dark-mode .message.selected {color: #fff !important;}
    .dark-mode .message.selected .status-checks {color: rgba(255,255,255,0.7) !important;}
    .dark-mode .reply-bar {background: rgba(45, 45, 45, 0.95); border-top: 1px solid #555;}
    .dark-mode .reply-icon {color: #f9a825;}
    .dark-mode .reply-to-name {color: #f9a825;}
    .dark-mode .reply-to-text {color: #aaa;}
    .dark-mode .reply-preview {background: rgba(255, 255, 255, 0.1); border-left-color: #f9a825;}
    .dark-mode .reply-preview-name {color: #f9a825;}
    .dark-mode .reply-preview-text {color: #aaa;}
    .dark-mode .message.deleted .msg-text-content {color: #aaa !important;}
    .dark-mode .edit-bar {background: rgba(249, 168, 37, 0.2);border-top-color: #f9a825;}
    .dark-mode .edit-icon {color: #ffa726;}
    .dark-mode .edit-label {color: #ffb74d;}
    .dark-mode .edit-text-preview {color: #ffa726;}
    .dark-mode .edit-cancel {color: #ffb74d;}
    .dark-mode .reaction-menu {background: #232d36; box-shadow: 0 4px 20px rgba(0,0,0,0.4);}
    .dark-mode .plus-button {background-color: #3b4a54; box-shadow: -8px 0 12px #232d36;}
    .dark-mode .plus-button .material-icons {color: #aebac1;}
    .dark-mode .reaction-badge {background: #333; border: 1px solid #555;}
    .dark-mode .reaction-badge.my-reaction {background: #f9a825; border-color: #fbc02d; color: #fff;}
    .dark-mode .reaction-count {color: #ddd;} 
    .dark-mode .reaction-badge:hover {box-shadow: 0 2px 5px rgba(0, 0, 0, 0.6);}
    .dark-mode .custom-confirm-card {background: #2b2b2b; color: white;}
    .dark-mode .confirm-text {color: #eee;}
    .dark-mode .btn-confirm-action:active {background-color: rgba(255, 255, 255, 0.05);}
    .dark-mode .draft-preview {color: #aaa !important;}
    /* ==================== PWA KEYBOARD FIX ==================== */
    :root {--kb: 0px; --footer-h: 60px; --gap: 10px; --safe: env(safe-area-inset-bottom, 0px);}
    .message-container{overflow-y:auto; -webkit-overflow-scrolling: touch; padding-bottom: calc(var(--footer-h) + 80px + var(--kb) + var(--safe));}
    .message-container.keyboard-active{scroll-behavior: auto;}
    .chat-input-bar{position: fixed; left:0; right:0; bottom: calc(var(--footer-h) + var(--kb) + var(--gap) + var(--safe)); z-index: 10001; transition: bottom 0.12s ease;}
    .chat-input-bar.keyboard-active{box-shadow: 0 -4px 12px rgba(0,0,0,0.12); background: rgba(255,255,255,0.98);}
    .dark-mode .chat-input-bar.keyboard-active{background: rgba(0,0,0,0.15);}
    body.keyboard-open{overflow:hidden; touch-action:none;}
    @supports (-webkit-touch-callout: none) {body.keyboard-open {position: fixed; width: 100%;}}
    body.keyboard-open #full-emoji-picker-container{display:none !important;}
    /* ============= LIGHT MODE OPTIONS ============= */
    .header {background: linear-gradient(45deg, #d32f2f, #b71c1c); color: white; padding: 20px 15px; text-align: center; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3); border-bottom: 2px solid #c62828; position: fixed;
             top: 0; left: 0; right: 0; z-index: 1000;}
    .header h1 {margin: 0; font-size: 1.5em; font-weight: bold;}
    .header-subtitle {margin-top: 5px; font-size: 12px; opacity: 0.9;}
    .header-logo {position: absolute; left: 10px; top: 50%; transform: translateY(-50%); height: 80px; width: auto; border-radius: 8px; z-index: 1001;}
    .footer {background: linear-gradient(45deg, #d32f2f, #b71c1c); color: white; padding: 8px 15px; text-align: center; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3); border-top: 2px solid #c62828; position: fixed;
             bottom: 0; left: 0; right: 0; z-index: 1000;}
    .footer-content {max-width: 400px; margin: 0 auto;}
    .powered-by {font-size: 13px; font-weight: bold; margin-bottom: 3px;}
    .footer-year {font-size: 10px; opacity: 0.8; color: #ffcdd2;}
    .footer strong {color: #ffebee;}
    .main-content {flex: 1 1 auto; max-height: calc(100dvh - 0px - 0px); display: flex; flex-direction: column; overflow-y: auto; padding-top: 100px; padding-bottom: 0px;}
    .contact-id-info {padding: 10px 20px 10px 20px; font-size: 20px; font-weight: bold; color: #444;}
    #contact-list {display: flex; flex-direction: column; padding: 0 20px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 20px;}
    .contact {display: flex; align-items: center; gap: 5px; padding: 5px 12px; border-radius: 12px; background: rgba(0, 0, 0, 0.15); color: #444; box-shadow: 0 2px 6px rgba(0,0,0,0.1); cursor: pointer;
              transition: background 0.2s, transform 0.2s; margin-bottom: 5px;}
    .contact:hover {background: #ddd;}
    .contact-avatar {width: 40px; height: 40px; border-radius: 50%; border: 2px solid #666; background: #d32f2f; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold;
                     font-size: 18px; text-transform: uppercase; overflow: visible; position: relative;}
    .contact-avatar img {width: 100%; height: 100%; object-fit: cover; border-radius: 50%;}
    .status-dot {width: 13px; height: 13px; background-color: #bbb; border-radius: 50%; border: 2.5px solid white; position: absolute; bottom: -1px; right: -1px; transition: all 0.3s ease; z-index: 2;}
    .status-dot.online {background-color: #00ff00; box-shadow: 0 0 8px #00ff00, 0 0 12px rgba(0, 255, 0, 0.5); animation: pulse-green 2s infinite;}    
    .contact-info {display: flex; flex-direction: column; justify-content: center;}
    .contact-info .nint {font-size: 14px; opacity: 0.6;}
    .contact-info .name {font-size: 14px; font-weight: bold;}
    .unread-badge {background-color: #d32f2f;color: white; font-size: 13px; font-weight: bold; padding: 0 6px; min-width: 30px; height: 20px; line-height: 20px; border-radius: 10px; display: flex;
                   align-items: center; justify-content: center; margin-left: auto; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
    .back-header {font-size: 20px; color: #444; text-align: left; display: flex; align-items: center; height: 40px; margin: 2px 0 0 0;}
    #back-header {position: relative; padding: 0 5px; z-index: 1001; color: #444;}
    .back-text {font-weight: bold !important;}
    .back-header.show {opacity: 1; pointer-events: auto;}   
    .back-arrow {font-size: 25px !important; margin: 4px 0 0 0px; font-weight: bold !important;} 
    .back-header:hover {opacity: 0.75;}
    .chat-id-info {padding: 5px 20px; font-size: 15px; font-weight: bold; color: #d32f2f; background: rgba(0, 0, 0, 0.10); border-left: 4px solid #d32f2f;}    
    .message-container {display: none; flex-direction: column; gap: 0; padding: 15px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 80px; max-height: calc(100dvh - 220px);
                        transition: margin-bottom 0.3s cubic-bezier(0.25, 1, 0.5, 1); transition: max-height 0.3s ease, margin-bottom 0.3s ease;}
    .pinned-banner {background: rgba(255, 248, 225, 0.95); border-bottom: 1px solid #ffe082; padding: 10px 15px; display: flex; align-items: flex-start; gap: 10px; font-size: 12px; color: #856404;
                    position: sticky; top: 0; z-index: 10; backdrop-filter: blur(5px); max-height: 100px; overflow-y: auto;}
    .pinned-text {white-space: normal; word-wrap: break-word; flex: 1; font-weight: 500; line-height: 1.4;}
     #messages {display: none;}
    .message {max-width: 75%; padding: 10px; border-radius: 7.5px; margin-bottom: 4px; position: relative; font-size: 14.5px; line-height: 1.5; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); 
              word-wrap: break-word;}
    .msg-sender-name {font-size: 12px; font-weight: bold; color: #d32f2f; margin-bottom: 2px;}
    .message.self {align-self: flex-end; background: #6b9e59; color: #fff; margin-right: 10px; border-top-right-radius: 0;}
    .message.self::after {content: ""; position: absolute; right: -10px; top: 0; width: 0; height: 0; border-left: 10px solid #6b9e59; border-bottom: 10px solid transparent;}
    .message.other {align-self: flex-start; background: #ddd; color: #000; margin-left: 10px; border-top-left-radius: 0;}
    .message.other::after {content: ""; position: absolute; left: -10px; top: 0; width: 0; height: 0; border-right: 10px solid #ddd; border-bottom: 10px solid transparent;}
    .msg-meta {float: right; margin: 10px 0px 0px 25px; font-size: 11px; color: rgba(255, 255, 255, 0.6); white-space: nowrap; display: flex; align-items: center;}
    .message.other .msg-meta {color: rgba(0, 0, 0, 0.45);}
    .status-checks {font-size: 16px !important; margin-left: 5px; line-height: 1; vertical-align: middle; display: inline-flex;}
    .status-checks.sent, .status-checks.delivered {color: rgba(255, 255, 255, 0.5) !important;}
    .status-checks.read {color: #07e5f5 !important;}
    .date-divider {text-align: center; margin: 20px 0 10px 0; clear: both; width: 100%; display: flex; justify-content: center;}
    .date-divider span {background: rgba(0, 0, 0, 0.05); color: #555; padding: 5px 15px; border-radius: 12px; font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px;}
    .message.other .status-checks {display: none;}
    .status-checks.read {color: #07e5f5 !important;}
    .chat-input-bar {position: fixed; align-items: flex-end; background: transparent; display: none; padding: 8px 10px; bottom: 40px; gap: 8px;  z-index: 1001; transition: bottom 0.3s cubic-bezier(0.25, 1, 0.5, 1);
                     box-sizing: border-box;  width: 100%; max-width: 100%;}    
    .input-wrapper {display: flex; flex: 1; min-width: 0; align-items: flex-end; flex; align-items: center; background: #ccc; border-radius: 25px; padding: 5px 12px; gap: 2px;  min-height: 40px;
                    transition: all 0.3s ease;}
    #chat-input {color: #fff; flex: 1; min-width: 0; border: none; background: transparent; outline: none; resize: none; padding: 10px 5px; font-size: 15px; max-height: 100px; overflow-y: auto;
                 font-family: inherit; &::-webkit-scrollbar {width: 0px; background: transparent;} scrollbar-width: none; -ms-overflow-style: none;}
    .chat-input-bar button {height: 40px; width: 40px; padding: 4px; border: none; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; background: transparent;
                            color: #54656f; transition: transform 0.1s ease, background 0.2s; flex-shrink: 0;}  
    #chat-send-btn {background: #00a884; color: white; border-radius: 50%; width: 50px; height: 50px; flex-shrink: 0;}
    #send-icon {display: inline-block;transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275), opacity 0.2s;}
    .icon-spin {transform: rotate(360deg) scale(0.5); opacity: 0;}
    #camera-btn {display: flex; width: 30px; opacity: 1; overflow: hidden; transition: width 0.3s ease, opacity 0.2s ease, margin 0.3s ease;}
    .chat-input-bar.typing #camera-btn {width: 0; opacity: 0; margin: 0; padding: 0; pointer-events: none;}
    #contact-list::-webkit-scrollbar, #messages::-webkit-scrollbar {width: 6px;}
    #contact-list::-webkit-scrollbar-track, #messages::-webkit-scrollbar-track {background: transparent;}
    #contact-list::-webkit-scrollbar-thumb, #chat-messages::-webkit-scrollbar-thumb {background: rgba(0, 0, 0, 0.15); border-radius: 10px; transition: background 0.3s ease;}
    #contact-list::-webkit-scrollbar-thumb:hover, #chat-messages::-webkit-scrollbar-thumb:hover {background: rgba(0, 0, 0, 0.3);}
    .typing-indicator {position: fixed; bottom: 110px; left: 50%; transform: translateX(-50%); font-size: 12px; color: #888; font-style: italic; background: rgba(255, 255, 255, 0.95); padding: 6px 16px;
                       border-radius: 20px; z-index: 1100; display: none; pointer-events: none; border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 4px 12px rgba(0,0,0,0.1); transition: opacity 0.2s ease;
                       white-space: nowrap; max-width: 80%;}
    .action-bar {position: fixed; top: 100px; left: 0; right: 0; background: #f0f0f0; border-bottom: 2px solid #d32f2f; padding: 8px 15px; display: none; align-items: center; gap: 15px; z-index: 2000;
             box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15); transform: translateY(-100%); transition: transform 0.3s ease;}
    .action-bar.show {display: flex; transform: translateY(0); animation: slideDown 0.3s ease;}    
    .action-bar-close {background: none; border: none; color: #d32f2f; font-size: 24px; cursor: pointer; padding: 5px; display: flex; align-items: center; justify-content: center; transition: transform 0.2s;}
    .action-bar-close:active {transform: scale(0.9);}
    .action-bar-counter {flex: 1; font-size: 15px; font-weight: 500; color: #333;}
    .action-bar-actions {display: flex; gap: 8px; align-items: center;}
    .action-btn {background: none; border: none; color: #d32f2f; font-size: 22px; cursor: pointer; padding: 0px; display: flex; align-items: center; justify-content: center; border-radius: 50%; 
                 transition: all 0.2s; min-width: 35px; min-height: 35px;}
    .action-btn:active {transform: scale(0.9); background: rgba(211, 47, 47, 0.1);}
    .action-btn.disabled {opacity: 0.3; pointer-events: none;}
    :root {--selection-color: #bcd9ff;}
    .message.selected {background-color: var(--selection-color) !important; position: relative; box-shadow: none !important;}
    .message.self.selected::after {border-left-color: var(--selection-color) !important; filter: none !important; border-right-color: transparent !important;}
    .message.other.selected::after {border-right-color: var(--selection-color) !important; filter: none !important; border-left-color: transparent !important;}
    .message.selected {color: #000 !important;}.message.selected .status-checks {color: rgba(0,0,0,0.5) !important;}    
    .messages-with-action-bar {margin-top: 60px;}
    .message.selecting {animation: pulse-select 0.5s;}
    .message.highlighted {animation: highlight-fade 1.5s ease-out;}
    .message.deleted {opacity: 0.6; font-style: italic;}
    .message.deleted .msg-text-content {color: #888 !important; display: flex; align-items: center; gap: 6px;}
    .deleted-icon {font-size: 16px; opacity: 0.7;}
    .message.deleted .msg-meta {opacity: 0.5;}
    .message.is-forwarded::before{content: "forward"; font-family: "Material Symbols Outlined"; font-size: 16px; opacity: 0.6; position: absolute; left: -22px; top: 50%; pointer-events: none;
                                  transform: translateY(-50%); user-select: none; line-height: 1; direction: ltr;}
    .edit-bar {position: fixed; bottom: 100px; left: 0; right: 0; background: rgba(255, 235, 59, 0.95); border-top: 2px solid #f9a825; padding: 10px 15px; z-index: 1002; display: none;
               box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.2); backdrop-filter: blur(10px);}
    .edit-bar-content {display: flex; align-items: center; gap: 10px;}
    .edit-icon {font-size: 20px; color: #f57c00;}
    .edit-info {flex: 1; min-width: 0;}
    .edit-label {font-size: 12px; font-weight: bold; color: #e65100; margin-bottom: 2px;}
    .edit-text-preview {font-size: 13px; color: #f57c00; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}    
    .edit-cancel {background: none; border: none; color: #e65100; font-size: 20px; cursor: pointer; padding: 5px; line-height: 1;}    
    .edit-cancel:active {transform: scale(0.9);}   
    .message-edited-tag {font-size: 10px; color: rgba(255, 255, 255, 0.5); font-style: italic; margin-left: 5px;}
    .message.other .message-edited-tag {color: rgba(0, 0, 0, 0.4);}
    .chat-img{max-width: 230px; width: 100%; height: auto; border-radius: 10px; display: block; cursor: pointer;}
    .img-caption{line-height: 1.35; opacity: 0.95; word-wrap: break-word;}
    .reply-bar {position: fixed; bottom: 100px; left: 0; right: 0; background: rgba(255, 255, 255, 0.95); border-top: 1px solid #ddd; padding: 10px 15px; z-index: 5000; display: none;
                box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1); backdrop-filter: blur(10px);}
    .reply-bar-content {display: flex; align-items: center; gap: 10px;}
    .reply-icon {font-size: 20px; color: #d32f2f;}
    .reply-info {flex: 1; min-width: 0;}
    .reply-to-name {font-size: 12px; font-weight: bold; color: #d32f2f; margin-bottom: 2px;}
    .reply-to-text {font-size: 13px; color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
    .reply-cancel {background: none; border: none; color: #888; font-size: 20px; cursor: pointer; padding: 5px; line-height: 1;}
    .reply-cancel:active {transform: scale(0.9);}
    .reply-preview {background: rgba(0, 0, 0, 0.08); border-left: 3px solid #d32f2f; padding: 6px 10px; margin-bottom: 6px; border-radius: 4px; font-size: 12px; cursor: pointer;}
    .reply-preview:active {opacity: 0.7;}
    .reply-preview-name {font-weight: bold; color: #d32f2f; margin-bottom: 2px;}
    .reply-preview-text {color: #666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;}
    .reaction-menu {display: none; position: fixed; z-index: 10000; background: #fff; border-radius: 30px; padding: 3px 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.15); align-items: center;
                    justify-content: space-between; animation: popScale 0.1s ease-out; width: 215px;}
    .emoji-scroll-container {display: flex; gap: 5px; overflow-x: auto; padding-right: 8px; scrollbar-width: none; -ms-overflow-style: none; flex: 1;}
    .emoji-scroll-container::-webkit-scrollbar {display: none;}
    .reaction-emoji-container {font-size: 25px; cursor: pointer; margin: 0 0 5px 0; flex-shrink: 0; transition: transform 0.1s cubic-bezier(0.175, 0.885, 0.32, 1.275);}
    .plus-button {display: flex !important; align-items: center; justify-content: center; width: 28px; height: 28px; background-color: #f0f2f5; border-radius: 50%; cursor: pointer; flex-shrink: 0;
                  margin-left: 5px; box-shadow: -8px 0 12px #fff;}
    .plus-button .material-icons {font-size: 20px; color: #667781;}
    .message-reactions {position: absolute; bottom: -12px; right: 10px; display: flex; flex-wrap: wrap; gap: 4px; z-index: 5; pointer-events: all;}
    .reaction-badge {display: inline-flex; align-items: center; justify-content: center; background: #f0f0f0; border: 1px solid #ccc; border-radius: 20px; height: 21px; width: 21px; padding: 0 5px; 
                     box-shadow: 0 1px 2px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer; flex-shrink: 0;}
    .reaction-badge.my-reaction  {background: #ffd54f; border-color: #ffb300;}
    .reaction-badge.my-reaction .reaction-count {color: #d32f2f; font-weight: 700;}
    .reaction-emoji {font-size: 12px; line-height: 1; display: flex; align-items: center; justify-content: center;}
    .reaction-count {font-size: 11px; font-weight: 700; margin-left: 2px; color: #444;}    
    .reaction-badge:hover {transform: scale(1.1); box-shadow: 0 2px 5px rgba(0, 0, 0, 0.18);}
    .reaction-badge:active {transform: scale(0.95);}
    .thumb-emoji {margin-bottom: 5px;}
    .msg-meta {position: relative; z-index: 1;}
    .message:has(.reaction-badge) {padding-bottom: 8px; position: relative;}
    .reaction-badge:has(.reaction-count) {min-width: 35px; padding: 0 8px;}
    .message.self:has(.reaction-badge) {margin-bottom:15px;}
    .custom-confirm-overlay {position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 10000; display: flex; align-items: center; justify-content: center;}
    .custom-confirm-card {background: white; padding: 24px; border-radius: 15px; width: 85%; max-width: 450px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);}
    .confirm-text {margin-bottom: 30px; font-size: 14px; color: #333;}
    .confirm-buttons-stack {display: flex; flex-direction: column; gap: 8px; width: 100%;}
    .btn-confirm-action {background: none; border: none; padding: 12px 0; text-align: right; color: #55cf29; font-size: 16px; font-weight: 500; cursor: pointer; width: 100%; display: block;}
    .btn-confirm-cancel {background: none; border: none; padding: 12px 0; text-align: right; color: #55cf29; font-size: 16px; font-weight: 500; cursor: pointer  width: 100%; margin-top: 10px;}
    .btn-confirm-action:active, .btn-confirm-cancel:active {background-color: rgba(0, 0, 0, 0.05);}
    #full-emoji-picker-container {display: none; position: fixed; bottom: 0; width: 100%; height: 300px; z-index: 10001; box-shadow: 0 -5px 25px rgba(0,0,0,0.2); overflow: hidden; 
                                  animation: slideUp 0.3s ease-out; transition: opacity 0.2s ease-in-out;}    
    emoji-picker {width: 100%; height: 100%;}
    .draft-preview {color: #444 !important; font-size: 0.85em; font-style: italic; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 180px;}    
    .audio-bubble {display: flex; align-items: center; gap: 12px; padding: 6px 10px; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(16px) saturate(180%); border: 1px solid rgba(255, 255, 255, 0.2);
                   border-radius: 10px; width: 200px; box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3), 0 4px 16px rgba(0, 0, 0, 0.15), 0 2px 4px rgba(0, 0, 0, 0.1); position: relative; top: 5px;
                   transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);}
    .audio-play-btn {width: 35px; height: 35px; background: linear-gradient(135deg, #34b7f1 0%, #2196F3 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white;
                     cursor: pointer; flex-shrink: 0; box-shadow: 0 4px 12px rgba(52, 183, 241, 0.5), 0 2px 6px rgba(52, 183, 241, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.25); position: relative;
                     transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);}
    .audio-play-btn::after {content: ''; position: absolute; inset: -3px; border-radius: 50%; background: radial-gradient(circle, rgba(52, 183, 241, 0.4), transparent 70%); opacity: 0;
                            transition: opacity 0.25s ease;}
    .audio-play-btn:hover {transform: scale(1.12); box-shadow: 0 6px 18px rgba(52, 183, 241, 0.6), 0 3px 10px rgba(52, 183, 241, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.3);}
    .audio-play-btn:hover::after {opacity: 1;}
    .audio-play-btn:active {transform: scale(0.95);}
    .audio-play-btn .material-icons {font-size: 24px; filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));}
    .audio-bubble.playing .audio-play-btn {animation: gentle-pulse 2s ease-in-out infinite;}
    .audio-progress-container {flex-grow: 1; display: flex; flex-direction: column; gap: 7px;}
    .audio-progress-bar {width: 100%; height: 5px; background: rgba(0, 0, 0, 0.15); border-radius: 999px; overflow: hidden; position: relative; cursor: pointer; box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
                         transition: all 0.2s ease;}
    .audio-progress-bar:hover {height: 6px; background: rgba(0, 0, 0, 0.18);}
    .audio-progress-fill {height: 100%; width: 0%; background: linear-gradient(90deg, #34b7f1 0%, #2196F3 100%); border-radius: 999px; transition: width 0.1s linear; position: relative;
                          box-shadow: 0 0 8px rgba(52, 183, 241, 0.8), 0 0 4px rgba(52, 183, 241, 0.6);}
    .audio-progress-fill::after {content: ''; position: absolute; right: -1px; top: 50%; transform: translateY(-50%); width: 10px; height: 10px; background: white; border-radius: 50%; opacity: 0;
                                 box-shadow: 0 2px 6px rgba(52, 183, 241, 0.5), 0 0 0 2px #34b7f1; transition: opacity 0.2s ease;}
    .audio-progress-bar:hover .audio-progress-fill::after {opacity: 1;}
    .audio-info {display: flex; justify-content: space-between; align-items: center;}
    .audio-time {font-size: 11px; font-weight: 600; opacity: 0.8; color: #fff; letter-spacing: 0.4px; font-variant-numeric: tabular-nums; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);}
    .audio-bubble.loading .audio-progress-fill {background: linear-gradient(90deg, rgba(52, 183, 241, 0.3) 0%, rgba(52, 183, 241, 0.7) 50%, rgba(52, 183, 241, 0.3) 100%); background-size: 200% 100%;
                                                animation: shimmer 1.5s ease-in-out infinite;}
    .audio-bubble.dark {background: rgba(20, 20, 25, 0.85); border-color: rgba(255, 255, 255, 0.08); box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.08), 0 4px 16px rgba(0, 0, 0, 0.4), 0 2px 4px rgba(0, 0, 0, 0.3);}
    .audio-bubble.dark:hover {background: rgba(25, 25, 30, 0.9);}
    .audio-bubble.dark .audio-progress-bar {background: rgba(255, 255, 255, 0.08);}
    .audio-bubble.dark .audio-time {color: rgba(255, 255, 255, 0.9);}
    .attach-modal{position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 999999; display: none; align-items: center; justify-content: center;}
    .attach-card{background:#fff; width:min(500px,95vw); border-radius:16px; overflow:hidden;}
    .attach-header{display:flex;justify-content:space-between;align-items:center; padding:10px 12px;font-weight:700;}
    .attach-x{border:none;background:transparent;font-size:18px;padding:8px 10px;}
    .attach-preview{position:relative;background:#000;min-height:240px;display:flex;align-items:center;justify-content:center;}
    .attach-preview img{max-width:100%;max-height:65vh;object-fit:contain;}
    .attach-footer{display:flex;gap:8px;padding:12px;}
    #attach-caption{flex:1;padding:10px;border:1px solid #ddd;border-radius:8px;}
    #attach-send{background:#00a884;color:#fff;border:none;border-radius:8px;padding:0 15px;font-weight:700;}
    .attach-loading{position:absolute;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.55);color:#fff;font-weight:700;}
    @keyframes slideUp {from {transform: translateY(100%); opacity: 0;} to {transform: translateY(0); opacity: 1;}}
    @keyframes popScale {0% {transform: scale(0.85); opacity: 0;} 100% {transform: scale(1); opacity: 1;}}    
    @keyframes pulse-green {0% {transform: scale(1); box-shadow: 0 0 5px #00ff00;} 50% {transform: scale(1.15); box-shadow: 0 0 12px #00ff00;} 100% {transform: scale(1); box-shadow: 0 0 5px #00ff00;}}
    @keyframes slideDown {from {transform: translateY(-100%); opacity: 0;} to {transform: translateY(0); opacity: 1;}}
    @keyframes pulse-select {0% {background: inherit;} 50% {opacity: 0.7; transform: scale(1.02);} 100% {background: inherit;}}
    @keyframes highlight-fade {0% {background: rgba(211, 47, 47, 0.3);} 100% {background: inherit;}}
    @keyframes gentle-pulse {0%, 100% {box-shadow: 0 4px 12px rgba(52, 183, 241, 0.5), 0 2px 6px rgba(52, 183, 241, 0.3);} 50% {box-shadow: 0 6px 16px rgba(52, 183, 241, 0.7), 0 3px 8px rgba(52, 183, 241, 0.5);}}
    @keyframes shimmer {0% {background-position: -200% 0;} 100% {background-position: 200% 0;}}
    /* =================================================
    MEDIA QUERIES - FULL RESPONSIVENESS
    ================================================= */
    /* ============ RESPONSIVENESS 480px ============ */
    @media (max-width: 480px) {
      .header {padding: 8px 15px;}
      .header h1 {font-size: 1.2em !important; margin: 0 !important;}
      .header-logo {height: 50px; top: 32px; left: 10px;}
      .main-content {padding-top: 60px; padding-bottom: 30px;}
      .footer {padding: 5px 15px;}
      .powered-by {font-size: 11px;}
      .footer-year {font-size: 9px;}  
      .action-bar {top: 60px; padding: 2px 12px; gap: 10px;}
      .action-btn {font-size: 20px; min-width: 36px; min-height: 36px; padding: 6px;}
      .action-bar-counter {font-size: 14px;}}
    /* ============ RESPONSIVENESS 385px ============ */
    @media (max-width: 385px) {
      .powered-by {font-size: 10px !important; white-space: nowrap;}
      .footer-year {font-size: 8px !important;}
      .chat-input-bar {bottom: 38px;}}
  </style>
</head>
<body>
  <div class="theme-toggle" onclick="toggleTheme()">
    <span class="sun-icon">‚òÄÔ∏è</span>
    <span class="moon-icon">üåô</span>
  </div>
  <div class="menu-dots" onclick="toggleMenu()">‚ãÆ</div>
  <div class="menu-dropdown" id="menuDropdown">
    <div class="menu-item" onclick="showPolicies()">üìã Pol√≠ticas de Privacidade</div>
    <div class="menu-item" onclick="showTerms()">üìÑ Termos de Uso</div>
    <div class="menu-item" onclick="showAbout()">‚ÑπÔ∏è Sobre o Sistema</div>
    <div class="menu-item" onclick="showContact()">üìû Contacto</div>
  </div>
  <div class="header">
    <img id="corpLogo" class="header-logo" alt="Logo" src="">
    <h1>CB360</h1>
    <h2 id="corpInfo" style="display: none;"></h2>
    <div class="header-subtitle">MOBILE</div>
  </div>
  <div class="main-content">
    <div class="welcome-box">
      <div class="welcome-text">üëã Bem-Vindo(a),<br><span class="welcome-name">Utilizador</span></div>
      <div class="welcome-actions">
        <div class="welcome-bell" onclick="openNotifications()">
          <span class="material-icons">notifications</span>
          <span class="bell-badge" id="notifBadge">0</span>
        </div>
        <div class="welcome-avatar">
          <img id="userAvatar" src="https://www.gravatar.com/avatar/?d=mp" alt="Avatar do utilizador">
        </div>
      </div>
    </div>
    <div class="next-service-container">
      <span class="next-service-emoji">üìÖ</span>
      <span class="next-service-text">Pr√≥ximo Servi√ßo: </span>
    </div>
    <div class="menu-container">
      <div class="menu-header">
        <h1 class="menu-title">Title CB</h1>
        <p class="menu-subtitle">SISTEMA DE GEST√ÉO OPERACIONAL</p>
      </div>
      <div class="menu-buttons-container">
        <div class="menu-buttons">
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='ScalesView.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">calendar_month</span>
            <div>Escalas</div>
          </button>
          <button id="changes" class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='Swaps.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">multiple_stop</span>
            <div>Trocas de Servi√ßo</div>
            <span class="badge">0</span>
          </button>
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='MainPageEl.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">free_cancellation</span>
            <div>Disponibilidades</div>
          </button>
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='SolVacat.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">beach_access</span>
            <div>Pedido F√©rias</div>
          </button>
          <button class="menu-btn" onclick="showEmDesenvolvimento()">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">checkroom</span>
            <div>Pedido Fardamento</div>
          </button>
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='Attendance.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">fingerprint</span>
            <div>Ass√≠duidade</div>
          </button>
          <button id="ongoingBtn" class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='OnGoingOcr.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">crisis_alert</span>
            <div>Ocorr√™ncias em Curso</div>
            <span class="badge">0</span>
          </button>
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='FomioPage.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">diversity_3</span>
            <div>Equipa de Servi√ßo</div>
          </button>
          <button id="events" class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='Events.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">today</span>
            <div>Eventos</div>
            <span class="badge">0</span>
          </button>
          <button id="reports" class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='MissReport.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">insert_chart</span>
            <div>Relat√≥rios de Ocorr√™ncia</div>
            <span class="badge">0</span>
          </button>
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='Documents.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">description</span>
            <div>Documentos</div>
          </button>
          <button id="comunicates" class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='Comunic.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">assignment_add</span>
            <div>Comunicados</div>
            <span class="badge">0</span>
          </button>
          <button id="meteoadv" class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='MeteoAdv.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">storm</span>
            <div>Avisos METEO</div>
            <span class="badge">0</span>
          </button>
          <button id="hospadv" class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='NoHospital.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">local_hospital</span>
            <div>Constrangimentos Hospitalares</div>
            <span class="badge">0</span>
          </button>
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='MainPageVe.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">fire_truck</span>
            <div>Ve√≠culos</div>
          </button>
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='Tools.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">construction</span>
            <div>Ferramentas √öteis</div>
          </button>
          <button class="menu-btn" onclick="toggleButton(this); setTimeout(() => window.location.href='InterChat.html', 300);">
            <span class="material-icons" style="font-size: 24px; margin-bottom: 8px;">chat</span>
            <div>Chat Interno</div>
          </button>
        </div>
      </div>
    </div>
    <div id="toast" class="toast"></div>
    <div class="switch-wrapper">
      <div class="bottom-switch">
        <div class="switch-track">
          <div class="switch-indicator"></div>
          <button class="switch-btn active" onclick="switchTab('inicio')">
            <span class="material-icons" style="font-size:25px; vertical-align: middle; margin-right:5px;">local_fire_department</span>
            IN√çCIO
          </button>
          <button class="switch-btn" onclick="switchTab('config')">
            <span class="material-icons" style="font-size:25px; vertical-align: middle; margin-right:5px;">settings</span>
            CONFIGURA√á√ïES
          </button>
        </div>
      </div>
    </div>
  </div>
  <footer class="footer">
    <div class="footer-content">
      <div class="powered-by"><strong>Powered by:</strong> F√°bio Martins | Sistemas de Informa√ß√£o - Grupo CB360</div>
      <div class="footer-year">¬© 2023-2025 - Sistema CB360 Mobile</div>
    </div>
  </footer>
  <div id="policiesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üìã Pol√≠ticas de Privacidade</div>
      <div class="modal-body">
        <h3>Pol√≠tica de Privacidade - CB360</h3>
        <p><strong>√öltima atualiza√ß√£o:</strong> Dezembro 2025</p>
        <h4>1. Informa√ß√µes que Coletamos</h4>
        <p>‚Ä¢ Dados de localiza√ß√£o para funcionalidades de GPS<br>‚Ä¢ Informa√ß√µes de uso do sistema<br>‚Ä¢ Dados operacionais dos bombeiros</p>
        <h4>2. Como Usamos as Informa√ß√µes</h4>
        <p>‚Ä¢ Melhorar a efici√™ncia operacional<br>‚Ä¢ Garantir a seguran√ßa das equipas<br>‚Ä¢ An√°lise estat√≠stica de ocorr√™ncias</p>
        <h4>3. Prote√ß√£o de Dados</h4>
        <p>Todos os dados s√£o criptografados e armazenados de forma segura, seguindo as melhores pr√°ticas de seguran√ßa.</p>
        <h4>4. Contacto</h4>
        <p>Para quest√µes sobre privacidade, contacte: privacy@cb360.pt</p>
      </div>
      <div class="modal-footer">
        <button class="modal-close" onclick="closeModal('policiesModal')">Fechar</button>
      </div>
    </div>
  </div>
  <div id="termsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üìÑ Termos de Uso</div>
      <div class="modal-body">
        <h3>Termos de Uso - CB360</h3>
        <p><strong>Vig√™ncia:</strong> Dezembro 2025</p>
        <h4>1. Aceita√ß√£o dos Termos</h4>
        <p>Ao usar o sistema CB360, voc√™ concorda com estes termos de uso.</p>
        <h4>2. Uso Autorizado</h4>
        <p>‚Ä¢ Sistema destinado exclusivamente a bombeiros autorizados<br>‚Ä¢ Uso apenas para fins operacionais<br>‚Ä¢ Proibido compartilhar credenciais de acesso</p>
        <h4>3. Responsabilidades</h4>
        <p>‚Ä¢ Manter informa√ß√µes atualizadas<br>‚Ä¢ Usar o sistema de forma respons√°vel<br>‚Ä¢ Reportar problemas t√©cnicos</p>
        <h4>4. Limita√ß√µes</h4>
        <p>O sistema √© fornecido "como est√°" e pode ter interrup√ß√µes para manuten√ß√£o.</p>
        <h4>5. Modifica√ß√µes</h4>
        <p>Estes termos podem ser atualizados sem aviso pr√©vio.</p>
      </div>
      <div class="modal-footer">
        <button class="modal-close" onclick="closeModal('termsModal')">Fechar</button>
      </div>
    </div>
  </div>
  <div id="aboutModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">‚ÑπÔ∏è Sobre o Sistema</div>
      <div class="modal-body">
        <h3>CB360 - Sistema de Gest√£o Operacional</h3>
        <p><strong>Vers√£o:</strong> 2.1.0</p>
        <p><strong>Build:</strong> 2025.01.15</p>
        <h4>üìã Funcionalidades</h4>
        <p>‚Ä¢ Gest√£o de Status Operacional<br>‚Ä¢ Controlo de Ve√≠culos<br>‚Ä¢ Sistema FOMIO<br>‚Ä¢ Relat√≥rios e Estat√≠sticas<br>‚Ä¢ Gest√£o de Ocorr√™ncias</p>
        <h4>üõ†Ô∏è Tecnologias</h4>
        <p>‚Ä¢ Interface Web Responsiva<br>‚Ä¢ Integra√ß√£o GPS<br>‚Ä¢ Base de Dados em Tempo Real<br>‚Ä¢ Sincroniza√ß√£o Multi-dispositivo</p>
        <h4>üè¢ Desenvolvido para</h4>
        <p><strong>CB's Algarve</strong><br>Corpo de Bombeiros Volunt√°rios</p>
        <h4>üë®‚Äçüíª Desenvolvimento</h4>
        <p><strong>F√°bio Martins</strong><br>Grupo CB360<br>Email: dev@cb360.pt</p>
        <h4>üìÖ Hist√≥rico de Vers√µes</h4>
        <p>‚Ä¢ v2.1.0 - Interface mobile otimizada<br>‚Ä¢ v2.0.0 - Novo design e funcionalidades<br>‚Ä¢ v1.5.0 - Sistema FOMIO integrado<br>‚Ä¢ v1.0.0 - Vers√£o inicial</p>
      </div>
      <div class="modal-footer">
        <button class="modal-close" onclick="closeModal('aboutModal')">Fechar</button>
      </div>
    </div>
  </div>
  <div id="contactModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üìû Contacto</div>
      <div class="modal-body">
        <h3>Informa√ß√µes de Contacto</h3>
        <h4>üè¢ CB Faro Cruz Lusa</h4>
        <p><strong>Morada:</strong><br>Rua dos Bombeiros, n¬∫ 123<br>8000-000 Faro</p>
        <p><strong>Telefone:</strong> +351 289 123 456<br><strong>Email:</strong> geral@cbfarocruzlusa.pt<br><strong>Website:</strong> www.cbfarocruzlusa.pt</p>
        <h4>üíª Suporte T√©cnico</h4>
        <p><strong>Desenvolvedor:</strong> F√°bio Martins<br><strong>Email:</strong> suporte@cb360.pt<br><strong>Telefone:</strong> +351 912 345 678</p>
        <h4>üö® Emerg√™ncias</h4>
        <p><strong>N√∫mero Nacional de Emerg√™ncia:</strong><br><span style="font-size: 24px; color: #d32f2f; font-weight: bold;">112</span></p>
        <h4>‚è∞ Hor√°rios</h4>
        <p><strong>Quartel:</strong> 24h/dia, 7 dias/semana<br><strong>Suporte T√©cnico:</strong> Segunda a Sexta, 9h-18h</p>
        <h4>üåê Redes Sociais</h4>
        <p>Facebook: @CBFaroCruzLusa<br>Instagram: @cb_faro_cruzlusa<br>Twitter: @CBFaroCruzLusa</p>
      </div>
      <div class="modal-footer">
        <button class="modal-close" onclick="closeModal('contactModal')">Fechar</button>
      </div>
    </div>
  </div>
  <div id="notificationsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üîî Notifica√ß√µes</h3>
      </div>
      <div id="notificationsList" class="modal-body">
        <p style="text-align:center; color: #888;">A carregar mensagens...</p>
      </div>
      <div class="modal-footer">
        <button class="menu-btn selected" style="width: 100%;" onclick="markAllAsRead()">Limpar Tudo</button>
      </div>
    </div>
  </div>
  <div id="emDesenvolvimentoModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">üöß Em Desenvolvimento</div>
      <div class="modal-body" style="text-align:center; font-size:16px;">
        Esta funcionalidade ainda est√° em desenvolvimento.<br>
        Por favor, verifique mais tarde.
      </div>
      <div class="modal-footer">
        <button class="modal-close" onclick="closeModal('emDesenvolvimentoModal')">Fechar</button>
      </div>
    </div>
  </div>
  <div id="configModal" class="modal">
    <div class="modal-content" style="max-width:400px; text-align:center;">
      <div class="modal-header">‚öôÔ∏è Configura√ß√µes</div>
      <div class="modal-body">
        <div style="margin-bottom:10px;">
          <img id="configUserAvatar" src="https://www.gravatar.com/avatar/?d=mp" alt="Avatar" style="width:80px;height:80px;border-radius:50%;margin:auto;display:block;object-fit:cover;">
        </div>
        <h3 id="configUserName">A Carregar...</h3>
        <p id="configUserRank"></p>
        <button id="changePasswordBtn" class="menu-btn" style="margin-top:5px;" onclick="showPasswordChange()">Alterar Password</button>
        <div id="passwordChangeContainer" style="display:none; margin-top: 5px; width:100%; flex-direction:column; align-items:center; gap:10px;">
          <div style="width:100%; max-width:300px;">
            <label for="currentPassword" style="display:block; text-align:left; margin-bottom:5px; font-weight:500;">Password Atual:</label>
            <div style="position:relative; margin-bottom:15px;">
              <input type="password" id="currentPassword" style="width:100%; padding:8px; padding-right:40px; border-radius:5px; border:1px solid #ccc;">
              <span class="material-icons" onclick="togglePasswordVisibility('currentPassword')" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#666; font-size:20px; user-select:none;">visibility_off</span>
            </div>
            <label for="newPassword" style="display:block; text-align:left; margin-bottom:5px; font-weight:500;">Nova Password:</label>
            <div style="position:relative; margin-bottom:15px;">
              <input type="password" id="newPassword" style="width:100%; padding:8px; padding-right:40px; border-radius:5px; border:1px solid #ccc;">
              <span class="material-icons" onclick="togglePasswordVisibility('newPassword')" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#666; font-size:20px; user-select:none;">visibility_off</span>
            </div>
            <label for="repeatPassword" style="display:block; text-align:left; font-weight:500;">Repita a Password:</label>
            <div style="position:relative; margin-bottom:10px;">
              <input type="password" id="repeatPassword" style="width:100%; padding:8px; padding-right:40px; border-radius:5px; border:1px solid #ccc;">
              <span class="material-icons" onclick="togglePasswordVisibility('repeatPassword')" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer; color:#666; font-size:20px; user-select:none;">visibility_off</span>
            </div>
          </div>
          <button id="saveNewPass" class="menu-btn" style="width:100%; margin-top: 0; max-width:170px;" onclick="changePassword()">Guardar</button>
        </div>
      </div>
      <div class="modal-footer">
        <button class="modal-close" onclick="closeConfigModal('configModal')">Fechar</button>
      </div>
    </div>
  </div>
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('App pronta: ', reg.scope))
          .catch(err => console.log('Erro no motor da App: ', err));
      });
    }
  </script>
  <script>
    /* ===================== SUPABASE CONFIGURATION ====================== */
    const SUPABASE_URL = 'https://rjkbodfqsvckvnhjwmhg.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJqa2JvZGZxc3Zja3ZuaGp3bWhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDgxNjM3NjQsImV4cCI6MjA2MzczOTc2NH0.jX5OPZkz1JSSwrahCoFzqGYw8tYkgE8isbn12uP43-0';
    function getSupabaseHeaders(options = {}) {
      const corp = localStorage.getItem("currentCorpOperNr") || "0805" || sessionStorage.getItem("currentCorpOperNr")  || "0805"; 
      const nint = localStorage.getItem("currentCorpNint") || "205" || sessionStorage.getItem("currentNInt")  || "205";
      const headers = {
        'apikey': SUPABASE_ANON_KEY,
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'Content-Type': 'application/json',
        'x-my-corpo': corp, 
        'x-my-nint': nint
      };
      if (options.returnRepresentation) {
        headers['Prefer'] = 'return=representation';
      }
      return headers;
    }
    /* ======================= FUNCTION FIX LAYOUT ======================= */
    function ajustarMainContent() {
      const main = document.querySelector('.main-content');
      const header = document.querySelector('.header');
      const footer = document.querySelector('.footer');
      if (!main) return;
      const alturaViewport = window.innerHeight;
      const headerHeight = header?.offsetHeight || 0;
      const footerHeight = footer?.offsetHeight || 0;
      const extra = 100;
      const alturaMain = alturaViewport - headerHeight - footerHeight + extra;
      main.style.height = alturaMain + 'px';
      main.style.maxHeight = alturaMain + 'px';
    }    
    window.addEventListener('load', ajustarMainContent);
    window.addEventListener('resize', ajustarMainContent);
    window.addEventListener('pageshow', ajustarMainContent);
    /* ============================== TOAST ============================== */
    let toastTimeout;
    function showToast(message) {
      const toast = document.getElementById('toast');
      if (!toast) return;
      toast.textContent = message;
      toast.classList.add('show');
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => {
        toast.classList.remove('show');
      }, 2500);
    }
    /* =========================== SWITCH TAB ============================ */
    function switchTab(tab) {
      const indicator = document.querySelector('.switch-indicator');
      const buttons = document.querySelectorAll('.switch-btn');
      const contents = document.querySelectorAll('.tab-content');
      buttons.forEach(btn => btn.classList.remove('active'));
      contents.forEach(c => c.classList.remove('active'));
      let targetBtn;
      if (tab === 'config') {
        targetBtn = buttons[1];
        showConfigModal();
      } else {
        targetBtn = buttons[0];
        const inicioContent = document.getElementById('inicio');
        if (inicioContent) inicioContent.classList.add('active');
      }
      if (targetBtn && indicator) {
        targetBtn.classList.add('active');
        setTimeout(() => {
          if (tab === 'config') {
            indicator.style.transform = 'translateX(100%)';
          } else {
            indicator.style.transform = 'translateX(0)';
          }
        }, 10);
      }
    }
    async function showConfigModal() {
      const nInt = localStorage.getItem('currentCorpNint')  || "205";
      if (!nInt) {
        console.error("nInt n√£o encontrado no localStorage");
        return;
      }
      showModal('configModal');
      try {
        const url = `${SUPABASE_URL}/rest/v1/reg_elems?select=full_name,photo_url,patent&n_int=eq.${nInt}`;
        const response = await fetch(url, { headers: getSupabaseHeaders() });
        if (!response.ok) {
          throw new Error(`Erro na resposta: ${response.statusText}`);
        }
        const data = await response.json();
        const user = data[0];
        if (user) {
          document.getElementById('configUserAvatar').src = user.photo_url || "https://www.gravatar.com/avatar/?d=mp";
          document.getElementById('configUserName').textContent = user.full_name || "Utilizador";
          document.getElementById('configUserRank').textContent = user.patent || "-";
        } else {
          console.warn("Nenhum utilizador encontrado com nInt:", nInt);
          document.getElementById('configUserName').textContent = "Utilizador n√£o encontrado";
          document.getElementById('configUserRank').textContent = "-";
        }
      } catch (err) {
        console.error("Erro ao carregar dados do utilizador:", err);
        document.getElementById('configUserName').textContent = "Erro de liga√ß√£o";
        document.getElementById('configUserRank').textContent = "-";
      }
    }
    function togglePasswordVisibility(inputId) {
      const input = document.getElementById(inputId);
      const icon = input.nextElementSibling;
      if (input.type === 'password') {
        input.type = 'text';
        icon.textContent = 'visibility';
      } else {
        input.type = 'password';
        icon.textContent = 'visibility_off';
      }
      if (navigator.vibrate) navigator.vibrate(30);
    }
    function closeConfigModal(modalId) {
      const container = document.getElementById('passwordChangeContainer');
      const btn = document.getElementById('changePasswordBtn');
      const modal = document.getElementById(modalId);
      if (container) container.style.display = 'none';
      if (btn) btn.style.display = 'flex';
      if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('repeatPassword').value = '';
      const indicator = document.querySelector('.switch-indicator');
      const buttons = document.querySelectorAll('.switch-btn');
      buttons.forEach(btn => btn.classList.remove('active'));
      if (buttons[0]) buttons[0].classList.add('active');
      if (indicator) indicator.style.transform = 'translateX(0)';
    }
    function showPasswordChange() {
      const container = document.getElementById('passwordChangeContainer');
      const btn = document.getElementById('changePasswordBtn');
      if (container) container.style.display = 'flex';
      if (btn) btn.style.display = 'none';
    }
    async function changePassword() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const repeatPassword = document.getElementById('repeatPassword').value;
      const corpOperNr = localStorage.getItem('currentCorpOperNr');
      const nIntCorp = localStorage.getItem('currentCorpNint');
      if (!currentPassword || !newPassword || !repeatPassword) {
        showToast('‚ùå Preencha todos os campos');
        return;
      }
      if (newPassword !== repeatPassword) {
        showToast('‚ùå As passwords n√£o coincidem');
        return;
      }
      if (newPassword.length < 6) {
        showToast('‚ùå A nova password deve ter pelo menos 6 caracteres');
        return;
      }
      if (!corpOperNr || !nIntCorp) {
        showToast('‚ùå Erro: dados de sess√£o n√£o encontrados');
        return;
      }
      try {
        const url = `${SUPABASE_URL}/rest/v1/users_mobile?select=password&corp_oper_nr=eq.${corpOperNr}&nint_corp=eq.${nIntCorp}`;
        const response = await fetch(url, {
          headers: getSupabaseHeaders()
        });
        if (!response.ok) {
          throw new Error(`Erro na resposta: ${response.statusText}`);
        }
        const data = await response.json();
        if (data.length === 0) {
          showToast('‚ùå Utilizador n√£o encontrado');
          return;
        }
        const user = data[0];
        if (user.password !== currentPassword) {
          showToast('‚ùå Password atual incorreta');
          return;
        }
        const updateUrl = `${SUPABASE_URL}/rest/v1/users_mobile?corp_oper_nr=eq.${corpOperNr}&nint_corp=eq.${nIntCorp}`;
        const updateResponse = await fetch(updateUrl, {
          method: 'PATCH',
          headers: getSupabaseHeaders({ returnRepresentation: true }),
          body: JSON.stringify({password: newPassword})
        });
        if (!updateResponse.ok) {
          throw new Error(`Erro ao atualizar: ${updateResponse.statusText}`);
        }
        showToast('‚úÖ Password alterada com sucesso!');
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('repeatPassword').value = '';
        document.getElementById('passwordChangeContainer').style.display = 'none';
        document.getElementById('changePasswordBtn').style.display = 'flex';
      } catch (error) {
        console.error('‚ùå Erro ao alterar password:', error);
        showToast('‚ùå Erro ao alterar password. Tente novamente.');
      }
    }
    /* ======================== DEVELOPMENT MODAL ======================== */    
    function showEmDesenvolvimento() {
      showModal('emDesenvolvimentoModal');
    }
    /* ======================= NOTIFICATIONS LOGIC ======================= */
    async function openNotifications() {
      if (navigator.vibrate) navigator.vibrate(30);      
      showModal('notificationsModal');      
      const nInt = localStorage.getItem('currentCorpNint');
      const listContainer = document.getElementById('notificationsList');      
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/user_notifications?n_int=eq.${nInt}&is_read=eq.false&order=created_at.desc`, {
            headers: getSupabaseHeaders()
          }
        );
        const data = await response.json();    
        if (data.length === 0) {
          listContainer.innerHTML = '<p style="text-align:center; padding: 20px; color: #888;">N√£o tens notifica√ß√µes novas.</p>';
          return;
        }    
        listContainer.innerHTML = data.map(notif => `
          <div class="notif-item" style="padding: 12px; border-bottom: 1px solid #eee; margin-bottom: 8px;">
            <strong style="display:block; color: var(--primary-color);">${notif.title}</strong>
            <span style="font-size: 0.9em; color: #555;">${notif.message}</span>
            <small style="display:block; font-size: 0.7em; color: #aaa; margin-top: 5px;">
              ${new Date(notif.created_at).toLocaleString('pt-PT')}
            </small>
          </div>
        `).join('');    
      } catch (err) {
        listContainer.innerHTML = '<p style="color: red;">Erro ao carregar notifica√ß√µes.</p>';
      }
    }
    function closeNotificationsModal() {
      closeModal('notificationsModal');
    }
    async function markAllAsRead() {
      const nInt = localStorage.getItem('currentCorpNint');  
      try {
        const res = await fetch(`${SUPABASE_URL}/rest/v1/user_notifications?n_int=eq.${nInt}&is_read=eq.false`, {
          method: 'PATCH',
          headers: getSupabaseHeaders(),
          body: JSON.stringify({ is_read: true })
        });
        if (res.ok) {
          updateNotifBadge(0);
          closeNotificationsModal();
          showToast('Notifica√ß√µes limpas');
        }
      } catch (err) {
        console.error('Erro ao limpar notifica√ß√µes:', err);
      }
    }
    function updateNotifBadge(count) {
      const badge = document.getElementById('notifBadge');
      if (!badge) return;
      badge.textContent = count;
      badge.style.display = 'flex';
      if (count === 0) {
        badge.style.opacity = '1'; 
        badge.style.background = 'red';
      } else {
        badge.style.opacity = '1';
        badge.style.background = 'red';
      }
    }
    /* =================== FORMATTING CORPORATION NAME =================== */
    function formatCorpName(rawName) {
      if (!rawName) return "";
      let name = rawName.trim();
      if (name.startsWith("Associa√ß√£o Humanit√°ria dos Bombeiros")) {
        name = name.replace("Associa√ß√£o Humanit√°ria dos Bombeiros", "")
          .replace("Volunt√°rios", "")
          .trim()
          .replace(/^\s*de\s*/i, "");
        return `C.B. de ${name}`;
      }
      if (name.startsWith("Companhia Sapadores")) {
        return name.replace("Companhia", "CB");
      }
      if (name.startsWith("Centro Municipal de Opera√ß√µes de Socorro")) {
        let zona = name.replace("Centro Municipal de Opera√ß√µes de Socorro", "").trim()
          .replace(/^de\s*/i, "");
        return `CMOS ${zona}`;
      }
      return name;
    }
    /* ======================= CORPORATION LOADING ======================= */
    async function loadCorpInfo() {
      const corpOperNr = localStorage.getItem("currentCorpOperNr");
      const h2 = document.getElementById("corpInfo");
      const titleEl = document.querySelector(".menu-title");
      const logoEl = document.getElementById("corpLogo");
      if (!corpOperNr) {
        if (h2) {h2.textContent = "N√£o definido";}
        return;
      }
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/corporation_data?select=corporation,corp_oper_nr,logo_url&corp_oper_nr=eq.${corpOperNr}`, {
            headers: getSupabaseHeaders()
          }
        );
        const data = await response.json();
        if (data && data.length > 0) {
          const corp = data[0];
          if (h2) {h2.textContent = corp.corp_oper_nr || "N/D";}
          if (logoEl && corp.logo_url) {logoEl.src = corp.logo_url.trim();}
          if (titleEl && corp.corporation) {titleEl.textContent = formatCorpName(corp.corporation);}
        } else {
          if (h2) {h2.textContent = "N√£o encontrado";}
        }
      } catch (err) {
        console.error('Erro no loadCorpInfo:', err);
        if (h2) {h2.textContent = corpOperNr;}
      }
    }
    /* ======================== USERNAME LOADING ========================= */
    async function loadUserName() {
      const nInt = localStorage.getItem('currentCorpNint');
      const welcomeNameEl = document.querySelector('.welcome-name');
      const avatarEl = document.getElementById('userAvatar');
      try {
        const url = `${SUPABASE_URL}/rest/v1/reg_elems?select=abv_name,photo_url&n_int=eq.${nInt}`;
        const response = await fetch(url, {
          headers: getSupabaseHeaders()
        });
        const data = await response.json();
        welcomeNameEl.textContent = data[0]?.abv_name || 'Utilizador';
        if (data[0]?.photo_url) {
          avatarEl.src = data[0].photo_url;
        } else {
          avatarEl.src = "https://www.gravatar.com/avatar/?d=mp";
        }
      } catch (error) {
        welcomeNameEl.textContent = 'Utilizador';
        avatarEl.src = "https://www.gravatar.com/avatar/?d=mp";
      }
    }
    /* ====================== NEXT SERVICE LOADING ====================== */
    async function loadNextService() {
      const nintCorpStr = localStorage.getItem("currentCorpNint");
      if (!nintCorpStr) return;
      const nintCorp = parseInt(nintCorpStr, 10);
      const container = document.querySelector(".next-service-container");
      const textSpan = container.querySelector(".next-service-text");
      textSpan.textContent = "A carregar...";
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/reg_serv?select=day,month,year,value&n_int=eq.${nintCorp}`, {
            headers: getSupabaseHeaders()
          }
        );
        if (!response.ok) {
          textSpan.textContent = "Erro ao carregar dados";
          return;
        }
        const data = await response.json();
        const servicesByDate = {};
        data.forEach(d => {
          if (d.day && d.month && d.year && d.value) {
            const key = `${d.year}-${String(d.month).padStart(2,'0')}-${String(d.day).padStart(2,'0')}`;
            if (!servicesByDate[key]) servicesByDate[key] = [];
            servicesByDate[key].push(d.value);
          }
        });
        const today = new Date();
        today.setHours(0,0,0,0);
        const futureDates = Object.keys(servicesByDate)
        .map(dateStr => ({ dateObj: new Date(dateStr), values: servicesByDate[dateStr] }))
        .filter(d => d.dateObj >= today)
        .sort((a, b) => a.dateObj - b.dateObj);
        if (futureDates.length === 0) {
          textSpan.textContent = "Pr√≥ximo Servi√ßo: N√£o existem registos";
          return;
        }
        const nextService = futureDates[0];
        const day = String(nextService.dateObj.getDate()).padStart(2,'0');
        const month = String(nextService.dateObj.getMonth() + 1).padStart(2,'0');
        const year = nextService.dateObj.getFullYear();
        const values = nextService.values;
        let serviceType = '';
        const hasPN = values.includes('PN');
        const hasECIN = values.some(v => ['ED','EN','ET'].includes(v));
        if (hasPN && hasECIN) serviceType = 'ECIN/PIQUETE';
        else if (hasPN) serviceType = 'PIQUETE';
        else if (hasECIN) serviceType = 'ECIN';
        textSpan.textContent = `Pr√≥ximo Servi√ßo: ${day}/${month}/${year} - ${serviceType}`;
      } catch (err) {
        console.error("Erro ao carregar pr√≥ximo servi√ßo:", err);
        textSpan.textContent = "Erro de liga√ß√£o ao servidor";
      }
    }
    /* ======================= FETCH NOTIFICATIONS ======================= */
    async function checkRealNotifications() {
      const nInt = localStorage.getItem('currentCorpNint');
      const corpOperNr = localStorage.getItem('currentCorpOperNr');      
      if (!nInt || !corpOperNr) return;    
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/user_notifications?n_int=eq.${nInt}&corp_oper_nr=eq.${corpOperNr}&is_read=eq.false&select=*`, {
            headers: getSupabaseHeaders()
          }
        );
        const data = await response.json();
        updateNotifBadge(data.length);
      } catch (err) {
        console.error('Erro ao verificar notifica√ß√µes:', err);
      }
    }
    /* ================= TOOGLE THEME AND MENU DROP DAWN ================= */
    function toggleTheme() {
      const body = document.body;
      const isDark = body.classList.contains('dark-mode');
      if (isDark) {
        body.classList.remove('dark-mode');
        localStorage.setItem('sgo-theme', 'light');
      } else {
        body.classList.add('dark-mode');
        localStorage.setItem('sgo-theme', 'dark');
      }
      const toggle = document.querySelector('.theme-toggle');
      if (toggle) {
        toggle.style.transform = 'scale(0.9)';
        setTimeout(() => toggle.style.transform = 'scale(1)', 150);
      }
      if (navigator.vibrate) navigator.vibrate(30);
    }

    function loadTheme() {
      if (localStorage.getItem('sgo-theme') === 'dark') {
        document.body.classList.add('dark-mode');
      }
    }

    function toggleMenu() {
      const dropdown = document.getElementById('menuDropdown');
      if (!dropdown) return;
      dropdown.classList.toggle('show');
      if (navigator.vibrate) navigator.vibrate(30);
    }
    document.addEventListener('click', function(event) {
      const menuDots = document.querySelector('.menu-dots');
      const dropdown = document.getElementById('menuDropdown');
      if (menuDots && dropdown &&
        !menuDots.contains(event.target) &&
        !dropdown.contains(event.target)) {
        dropdown.classList.remove('show');
      }
    });
    /* ============================== MODALS ============================= */
    function showModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.add('show');
        document.body.style.overflow = 'hidden';
        if (navigator.vibrate) navigator.vibrate(50);
      }
    }
    function closeModal(modalId) {
      const modal = document.getElementById(modalId);
      if (modal) {
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
    }
    function showPolicies() {
      showModal('policiesModal');
      toggleMenu();
    }
    function showTerms() {
      showModal('termsModal');
      toggleMenu();
    }
    function showAbout() {
      showModal('aboutModal');
      toggleMenu();
    }
    function showContact() {
      showModal('contactModal');
      toggleMenu();
    }
    document.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.classList.remove('show');
        document.body.style.overflow = 'auto';
      }
    });
    /* ============================= BUTTONS ============================= */
    function toggleButton(button) {
      const allButtons = document.querySelectorAll('.menu-btn');
      allButtons.forEach(btn => {
        if (btn !== button) btn.classList.remove('selected');
      });
      button.classList.add('selected');
      if (navigator.vibrate) navigator.vibrate(100);
      setTimeout(() => button.classList.remove('selected'), 2000);
    }
    function clearAllSelections() {
      document.querySelectorAll('.menu-btn').forEach(btn => btn.classList.remove('selected'));
    }
    /* ========================== SWAPS LOADING ========================== */
    async function updateSwapsBadge() {
      const corpOperNr = localStorage.getItem('currentCorpOperNr');
      const myNInt = localStorage.getItem('currentCorpNint');
      const badge = document.querySelector('#changes .badge');
      if (!badge) return;
      if (!corpOperNr || !myNInt) {
        badge.textContent = '0';
        return;
      }
      try {
        const url = `${SUPABASE_URL}/rest/v1/reg_swaps?select=*&corp_oper_nr=eq.${corpOperNr}&n_int_end=eq.${myNInt}&element_approval=is.null`;
        const response = await fetch(url, { headers: getSupabaseHeaders() });
        const data = await response.json();
        badge.textContent = `${data.length}`;
      } catch (err) {
        console.error('Erro ao buscar trocas pendentes:', err);
        badge.textContent = '!';
      }
    }
    /* ======================= OCCURRENCE LOADING ======================== */
    async function updateOccurrencesBadge() {
      const corpOperNr = localStorage.getItem('currentCorpOperNr')
      const badge = document.querySelector('#ongoingBtn .badge');
      if (!badge) return;
      if (!corpOperNr) {
        badge.textContent = '0';
        return;
      }
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/occurrences_control?select=*&corp_oper_nr=eq.${corpOperNr}`, {
          headers: getSupabaseHeaders()
        });
        const data = await response.json();
        badge.textContent = `${data.length}`;
      } catch (err) {
        console.error('Erro ao buscar ocorr√™ncias:', err);
        badge.textContent = '!';
      }
    }
    /* ========================= EVENTS LOADING ========================== */
    async function updateEventsBadge() {
      const corpOperNr = localStorage.getItem('currentCorpOperNr')
      const badge = document.querySelector('#events .badge');
      if (!badge) return;
      if (!corpOperNr) {
        badge.textContent = '0';
        return;
      }
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/event_list?select=*&corp_oper_nr=eq.${corpOperNr}`, {
          headers: getSupabaseHeaders()
        });
        const data = await response.json();
        badge.textContent = `${data.length}`;
      } catch (err) {
        console.error('Erro ao buscar ocorr√™ncias:', err);
        badge.textContent = '!';
      }
    }
    /* ========================= REPORTS LOADING ========================= */
    async function updateOccurrenceReportsBadge() {
      const corpOperNr = localStorage.getItem('currentCorpOperNr');
      const nInt = localStorage.getItem('currentCorpNint');
      const badge = document.querySelector('#reports .badge'); 
      if (!badge) return;
      if (!corpOperNr || !nInt) {
        badge.textContent = '0';
        return;
      }
      try {
        const url = `${SUPABASE_URL}/rest/v1/reports_control?select=id&corp_oper_nr=eq.${corpOperNr}&n_int=eq.${nInt}&report_state=is.true`;
        const response = await fetch(url, {
          headers: getSupabaseHeaders()
        });
        if (!response.ok) throw new Error(`Erro API: ${response.status}`);
        const data = await response.json();
        const count = data.length;
        badge.textContent = count;
        badge.style.display = 'flex';
        if (count > 0) {
          badge.classList.add('has-reports'); 
        } else {
          badge.classList.remove('has-reports'); 
        }
      } catch (err) {
        console.error('Erro ao atualizar badge de relat√≥rios:', err);
        badge.textContent = '!';
      }
    }
    /* ======================= COMUNICATES LOADING ======================= */
    async function updateComunicatesBadge() {
      const corpOperNr = localStorage.getItem('currentCorpOperNr');
      const badge = document.querySelector('#comunicates .badge'); 
      if (!badge) return;
      if (!corpOperNr) {
        badge.textContent = '0';
        return;
      }
      try {
        const url = `${SUPABASE_URL}/rest/v1/serv_comun?select=comun_url&corp_oper_nr=eq.${corpOperNr}`;
        const response = await fetch(url, { headers: getSupabaseHeaders() });
        const comunicados = await response.json();
        const viewedDocs = JSON.parse(localStorage.getItem("viewed_communications") || "[]");
        let unreadCount = 0;
        comunicados.forEach(comun => {
          if (comun.comun_url) {
            const publicUrl = comun.comun_url.startsWith('http') ?
                  comun.comun_url :
            `${SUPABASE_URL}/storage/v1/object/public/comunicados/${comun.comun_url}`;
            if (!viewedDocs.includes(publicUrl)) {
              unreadCount++;
            }
          }
        });
        badge.textContent = `${unreadCount}`;
      } catch (err) {
        console.error('Erro ao buscar comunicados:', err);
        badge.textContent = '!';
      }
    }
    /* ====================== NO HOSPITAL LOADING ======================== */
    async function updateNohospitalBadge() {
      const corpOperNr = localStorage.getItem('currentCorpOperNr')
      const badge = document.querySelector('#hospadv .badge');
      if (!badge) return;
      if (!corpOperNr) {
        badge.textContent = '0';
        return;
      }
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/hospital_restrictions?select=*&corp_oper_nr=eq.${corpOperNr}`, {
          headers: getSupabaseHeaders()
        });
        const data = await response.json();
        badge.textContent = `${data.length}`;
      } catch (err) {
        console.error('Erro ao buscar ocorr√™ncias:', err);
        badge.textContent = '!';
      }
    }
    /* ====================== IPMA WARNINGS LOADING ====================== */
    function updateMeteoBadge(count) {
      const badge = document.querySelector("#meteoadv .badge");
      if (badge) {
        badge.style.display = "inline-block";
        badge.textContent = count;
      }
    }
    async function countIPMAWarningsFromSite() {
      try {
        const response = await fetch("https://api.ipma.pt/open-data/forecast/warnings/warnings_www.json");
        const data = await response.json();
        const warnings = data.filter(a => a.idAreaAviso === "FAR" && a.awarenessLevelID !== "green");
        updateMeteoBadge(warnings.length);
      } catch (err) {
        console.error("Erro ao buscar e contar avisos IPMA:", err);
      }
    }
    /* ============================= EVENTS ============================== */
    window.addEventListener('load', () => {
      if (localStorage.getItem('sgo-theme') === 'dark') {
        document.body.classList.add('dark-mode');
      }
    });
    document.addEventListener('DOMContentLoaded', () => {
      loadTheme();
      loadCorpInfo();
      loadUserName();
      loadNextService();
      updateSwapsBadge();
      updateOccurrencesBadge();
      updateEventsBadge();
      updateOccurrenceReportsBadge();
      updateComunicatesBadge();
      countIPMAWarningsFromSite();
      updateNohospitalBadge();
      checkRealNotifications();
      setInterval(updateSwapsBadge, 10000);
      setInterval(updateOccurrencesBadge, 10000);
      setInterval(updateEventsBadge, 10000);
      setInterval(updateOccurrenceReportsBadge, 10000);
      setInterval(updateComunicatesBadge, 10000);
      setInterval(countIPMAWarningsFromSite, 10 * 60 * 1000);
      setInterval(updateNohospitalBadge, 10000);
      setInterval(checkRealNotifications, 10000);
      const buttons = document.querySelectorAll('.menu-btn');
      buttons.forEach((button, index) => {
        button.style.opacity = '0';
        button.style.transform = 'translateY(20px)';
        setTimeout(() => {
          button.style.transition = 'all 0.5s ease';
          button.style.opacity = '1';
          button.style.transform = 'translateY(0)';
        }, index * 100);
      });
      document.addEventListener('touchstart', e => {
        if (e.touches.length > 1) e.preventDefault();
      });
      let lastTouchEnd = 0;
      document.addEventListener('touchend', e => {
        const now = Date.now();
        if (now - lastTouchEnd <= 300) e.preventDefault();
        lastTouchEnd = now;
      }, false);
    });
    window.addEventListener('click', event => {
      const isButtonClick = event.target.closest('.menu-btn');
      const isThemeToggle = event.target.closest('.theme-toggle');
      const isMenuClick = event.target.closest('.menu-dots');
      const isModalClick = event.target.closest('.modal-content');
      if (!isButtonClick && !isThemeToggle && !isMenuClick && !isModalClick) clearAllSelections();
    });
    document.addEventListener('selectstart', e => e.preventDefault());
    document.addEventListener('contextmenu', e => e.preventDefault());
  </script>
</body>
</html>


