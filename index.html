<!DOCTYPE html>
<html lang="pt-PT">
  
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WSMS Auto Creator</title>
  <link rel="stylesheet" href="css/main.css">
</head>

  <body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <img src="https://i.imgur.com/4Ho5HRV.png" alt="CB Faro Cruz Lusa" class="header-logo">
      </div>
      <div class="header-title-container">
        <h1 class="header-title">CORPO DE BOMBEIROS DE FARO - CRUZ LUSA</h1>
        <p class="header-subtitle">WSMS Auto Creator</p>
        <p class="header-authorization">Acesso Autorizado: <span id="authName"></span></p>
      </div>
      <div class="header-badge-360">Grupo CB360</div>
    </header>
    <div class="header-authorization">Acesso Autorizado: <span id="authName"></span></div>
    <!---- M√ìDULO SIDEBAR ---->
    <aside class="sidebar">
      <button class="sidebar-menu-button active" data-page="page-main">üè† Menu Principal</button>
      <button class="sidebar-menu-button" data-page="page-active_occurrences">üî• Ocorr√™ncias em Curso</button>
      <button class="sidebar-menu-button" data-page="page_insert_occurrence">‚úèÔ∏è Inserir/Alterar Ocorr√™ncia</button>
      <button class="sidebar-menu-button" data-page="page_close_occurrence">üîê Encerrar Ocorr√™ncia</button>
      <button class="sidebar-menu-button" data-page="page-solicitation">üìã Solicita√ß√£o Disponibilidades</button>
      <button class="sidebar-menu-button" data-page="page-indisp">‚ö†Ô∏è Indisponibilidade Ve√≠culos</button>
      <button class="sidebar-menu-button" data-page="page-municipality-grid">üóÇÔ∏è Info. Grelha Munic√≠pio</button>
      <button class="sidebar-menu-button" data-page="page-utilities">üì± Utilit√°rios</button>
      <button class="sidebar-menu-button" data-page="page-data">üíæ Data Center</button>
    </aside>
    <!---- M√ìDULO POPUPS ---->
    <div id="popup-modal" class="popup-modal">
      <div class="popup-content">
        <h3>Campos em falta</h3>
        <ul id="missing-fields-list"></ul>
        <button id="popup-ok-btn">OK</button>
      </div>
    </div>
    <div id="popup-warning-modal" class="popup-modal">
      <div class="popup-content">
        <h3>AVISO</h3>
        <p></p>
        <button id="popup-warning-ok-btn" class="btn btn-danger">OK</button>
      </div>
    </div>
    <div id="popup-success-modal" class="popup-modal">
      <div class="popup-content">
        <h3>SUCESSO</h3>
        <p>Mensagem criada com sucesso! Abra o WhatsApp e prima CTRL+V</p>
        <button id="popup-success-ok-btn" class="btn btn-success">OK</button>
      </div>
    </div>
     <div id="popup-success-modal" class="popup-modal">
      <div class="popup-content">
        <h3>SUCESSO</h3>
        <p>Mensagem criada com sucesso! Abra o WhatsApp e prima CTRL+V</p>
        <button id="popup-success-ok-btn" class="btn btn-success">OK</button>
      </div>
    </div>
    
    
    <!---- M√ìDULO COUNTE√öDO PRINCIPAL ---->
    <main class="main-content">
      <div id="page-main" class="page active">
        <div class="card last-card">
          <div class="card-header">BEM-VINDO AO SISTEMA CB360 ONLINE</div>
          <div class="card-body">
            <p style="margin-bottom: 15px;">Sistema automatizado para gest√£o operaional di√°ria do Corpo de Bombeiros de Faro - Cruz Lusa.</p>
            <p style="margin-bottom: 15px;"><strong>Funcionalidades dispon√≠veis:</strong></p>
            <p style="margin-bottom: 0px;"><strong>WSMS Auto Creator:</strong></p>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
              <li>Ocorr√™ncias em Curso</li>
              <li>Inserir/Alterar Ocorr√™ncias</li>
              <li>Encerrar Ocorr√™ncias</li>
              <li>Solicita√ß√£o de Disponibilidades</li>
              <li>Indisponibilidade de Ve√≠culos</li>
              <li>Info. Grelha do Munic√≠pio</li>
            </ul>
            <p style="margin-bottom: 0px;"><strong>Painel de Utilit√°rios:</strong></p>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
              <li>Visualiza√ß√£o de estados dos EPEs e PPIs</li>
              <li>Visualiza√ß√£o dos estados operacionais dos ve√≠culos</li>
            </ul>
            <p style="margin-bottom: 0px; margin-top: 15px;"><strong>Brevemente:</strong></p>
            <ul style="padding-left: 20px; margin-bottom: 15px;">
              <li><em>SALOC 360</em></li>
              <li><em>DECIR 360</em></li>
              <li><em>FOMIO 360</em></li>
            </ul>
            <p style="margin-top: 50px;"><em>Selecione uma op√ß√£o no menu lateral para come√ßar.</em></p>
          </div>
        </div>
      </div>
      <!---- M√ìDULO OCORR√äNCIAS EM CURSO ---->
      <div id="page-active_occurrences" class="page">
        <h2 class="section-title">Ocorr√™ncias em Curso</h2>
        <div class="card">
          <div class="card-header">LISTA DE OCORR√äNCIAS ATIVAS</div>
          <div class="card-body">
            <div style="overflow-x: auto;">
              <table id="active-occurrences-table" style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <thead>
                  <tr style="background-color: #F8F9FA; border-bottom: 2px solid #DEE2E6;">
                    <th style="width: 150px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Data/Hora Alerta</th>
                    <th style="width: 250px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Descri√ß√£o</th>
                    <th style="width: 350px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Local</th>
                    <th style="width: 300px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Localidade</th>
                    <th style="width: 75px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Ve√≠culos</th>
                    <th style="width: 125px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Estado</th>
                    <th style="width: 100px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="active-occurrences-tbody">
                </tbody>
              </table>
            </div>
            <div style="margin-top: 15px; text-align: right;">
              <button class="btn btn-success" onclick="loadActiveOccurrences()" style="font-size: 10px;">
                ATUALIZAR LISTA
              </button>
            </div>
          </div>
        </div>
        <!---- Popup Especial POSIT ---->
        <div id="popup-posit-modal" class="popup-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1000; ">
          <div class="popup-content" style="background-color: white; padding: 20px; border-radius: 12px; text-align: center; max-width: 400px; width: 90%; position: relative; box-shadow: 0 4px 12px rgba(0,0,0,0.3); ">
            <h3 style="margin-bottom: 15px;">POSIT</h3>
            <div style="display: flex; justify-content: center; align-items: center; width: 100%; margin: 5px 0;">
              <label for="posit-description" style="width: 90px; text-align: left;">Descri√ß√£o:</label>
              <input type="text" id="posit-description" style="flex: 1; padding: 5px; border-radius: 6px; border: 1px solid #ccc; text-align: center;" readonly />
            </div>
            <div style="display: flex; justify-content: center; align-items: center; width: 100%; margin: 5px 0;">
              <label for="posit-local" style="width: 90px; text-align: left;">Local:</label>
              <input type="text" id="posit-local" style="flex: 1; padding: 5px; border-radius: 6px; border: 1px solid #ccc; text-align: center;" readonly />
            </div>
            <input type="hidden" id="posit-localidade-hidden" value="" />
            <div style="display: flex; justify-content: center; align-items: center; width: 100%; margin: 5px 0;">
              <label for="posit-status" style="width: 90px; text-align: left;">Estado:</label>
              <select id="posit-status" style="flex: 1; padding: 5px; border-radius: 6px; border: 1px solid #ccc;">
                <option value="Em Curso">Em Curso</option>
                <option value="Em Resolu√ß√£o">Em Resolu√ß√£o</option>
                <option value="Em Conclus√£o">Em Conclus√£o</option>
                <option value="Encerrada">Encerrada</option>
              </select>
            </div>
            <div style="display: flex; justify-content: left; align-items: center; width: 100%; margin: 5px 0;">
              <label for="posit-time" style="width: 90px; text-align: left;">Hora POSIT:</label>
              <input type="text" id="posit-time" style="width: 60px; padding: 5px; border-radius: 6px; border: 1px solid #ccc; text-align: center;" />
            </div>
            <div style="margin-top: 10px; text-align: left;">
              <label for="posit-text" style="display:block; margin-bottom: 5px;">POSIT:</label>
              <textarea id="posit-text" rows="5" style="width: 100%; padding: 5px; border-radius: 6px; border: 1px solid #ccc; resize: vertical;"></textarea>
            </div>
            <div style="margin-top: 5px; text-align: left;"> <input type="checkbox" id="desmobilizacao" />
              <label for="desmobilizacao" style="margin-left: 5px;">Desmobiliza√ß√£o de meios</label>
            </div>
            <button id="posit-send-btn" class="btn btn-danger" style="width: 50%; margin-top: 10px;">Enviar POSIT</button>
          </div>
        </div>
      </div>
      <!---- M√ìDULO NOVA OCORR√äNCIA ---->
      <div id="page_insert_occurrence" class="page">
        <h2 class="section-title">Dados para Nova Ocorr√™ncia</h2>
        <div class="card">
          <div class="card-header">DADOS GLOBAIS</div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-group" style="width: 200px;">
                <label>Tipo Alerta:</label>
                <select id="alert_type">
                </select>
              </div>
              <div class="form-group" style="width: 200px;">
                <label>Fonte Alerta:</label>
                <select id="alert_source">
                </select>
              </div>
              <div class="form-group" id="ems_group" style="width: 100px;">
                <label>Nr. CODU:</label>
                <input type="text" id="ems_nr" placeholder="Ex. 123456789">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="width: 120px;">
                <label>Data Alerta:</label>
                <input type="date" id="alert_date" value="">
              </div>
              <div class="form-group" style="width: 80px;">
                <label>Hora Alerta:</label>
                <input type="time" id="alert_time" value="">
              </div>
              <div class="form-group" style="width: 100px;">
                <label>Class. Ocorr√™ncia:</label>
                <input type="text" id="class_occorr_input" placeholder="Ex. 3103" style="width: 100%; text-align: center;" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 4)">
              </div>
              <div class="form-group" style="width: 100px;">
                <label>Nr. Ocorr√™ncia:</label>
                <input type="text" id="nr_occurrence_input" placeholder="Ex. 123456789" style="width: 100%; text-align: center;" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11)">
              </div>
              <div class="form-group" style="width: 300px; display: none;">
                <label>Descr. Ocorr√™ncia:</label>
                <input type="text" id="occorr_descr_input" placeholder="Inc. Mato">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="width: 350px;">
                <label>Morada Ocorr√™ncia:</label>
                <input type="text" id="occorr_local_input" placeholder="Ex. Rua Serpa Pinto, 00">
              </div>
              <div class="form-group" style="width: 200px;">
                <label>Localidade:</label>
                <input type="text" id="occorr_localitie_input" placeholder="Ex. Faro">
              </div>
              <div class="form-group" style="width: 150px;">
                <label>Concelho:</label>
                <select id="council_select">
                  <option></option>
                </select>
              </div>
              <div class="form-group" style="width: 175px;">
                <label>Freguesia:</label>
                <select id="parish_select">
                </select>
              </div>
              <div class="form-group" style="width: 100px;">
                <label>Canal Manobra:</label>
                <select id="channel_maneuver">
                  <option></option>
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="width: 200px;">
                <label>Tipo PPI:</label>
                <select id="ppi_type">
                </select>
              </div>
              <div class="form-group" style="width: 140px;">
                <label>N√≠vel Alerta:</label>
                <select id="alert_level">
                  <option></option>
                </select>
              </div>
              <div class="form-group" style="width: 140px;">
                <label>Grelha Alarme:</label>
                <select id="alarm_grid">
                  <option></option>
                </select>
              </div>
              <div class="form-group" style="width: 80px;">
                <label>Km:</label>
                <input type="text" id="km">
              </div>
              <div class="form-group" style="width: 200px;">
                <label>Sentido:</label>
                <select id="on_going">
                </select>
              </div>
              <div class="form-group" style="width: 200px;">
                <label>Tipo Incidente:</label>
                <select id="incident_type">
                </select>
              </div>
            </div>
            <div class="form-row">
              <div class="form-group" style="width: 300px;">
                <label>Nome Contactante:</label>
                <input type="text" id="contact_name" placeholder="Ex. Jo√£o Sousa">
              </div>
              <div class="form-group" style="width: 120px;">
                <label>Nr. Contactante:</label>
                <input type="text" id="contact_nr" placeholder="Ex. 910 000 000" style="width: 100%; text-align: center;" maxlength="9" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 9)">
              </div>
            </div>
          </div>
        </div>
        <div class="card last-card">
          <div class="card-header">VE√çCULOS AFETOS √Ä OCORR√äNCIA</div>
          <div class="card-body">
            <div class="grid-2fr">
              <div class="vehicle-card">
                <div class="field-card-title">1¬∫ VE√çCULO</div>
                <div class="vehicle-fields">
                  <div class="vehicle-field" style="width: 120px;">
                    <label>Data Sa√≠da:</label>
                    <input type="date" value="">
                  </div>
                  <div class="vehicle-field" style="width: 150px;">
                    <label>Ve√≠culo:</label>
                    <select>
                      <option></option>
                    </select>
                  </div>
                  <div class="vehicle-field" style="width: 75px;">
                    <label>BBs:</label>
                    <input type="text" placeholder="00" style="width: 100%; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2)">
                  </div>
                  <div class="vehicle-field" style="width: 100px;">
                    <label>Hora Sa√≠da:</label>
                    <input type="time" value="time">
                  </div>
                </div>
              </div>
              <div class="vehicle-card">
                <div class="field-card-title">2¬∫ VE√çCULO</div>
                <div class="vehicle-fields">
                  <div class="vehicle-field" style="width: 120px;">
                    <label>Data Sa√≠da:</label>
                    <input type="date" value="">
                  </div>
                  <div class="vehicle-field" style="width: 150px;">
                    <label>Ve√≠culo:</label>
                    <select>
                      <option></option>
                    </select>
                  </div>
                  <div class="vehicle-field" style="width: 75px;">
                    <label>BBs:</label>
                    <input type="text" placeholder="00" style="width: 100%; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2)">
                  </div>
                  <div class="vehicle-field" style="width: 100px;">
                    <label>Hora Sa√≠da:</label>
                    <input type="time" value="time">
                  </div>
                </div>
              </div>
              <div class="vehicle-card">
                <div class="field-card-title">3¬∫ VE√çCULO</div>
                <div class="vehicle-fields">
                  <div class="vehicle-field" style="width: 120px;">
                    <label>Data Sa√≠da:</label>
                    <input type="date" value="">
                  </div>
                  <div class="vehicle-field" style="width: 150px;">
                    <label>Ve√≠culo:</label>
                    <select>
                      <option></option>
                    </select>
                  </div>
                  <div class="vehicle-field" style="width: 75px;">
                    <label>BBs:</label>
                    <input type="text" placeholder="00" style="width: 100%; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2)">
                  </div>
                  <div class="vehicle-field" style="width: 100px;">
                    <label>Hora Sa√≠da:</label>
                    <input type="time" value="time">
                  </div>
                </div>
              </div>
              <div class="vehicle-card">
                <div class="field-card-title">4¬∫ VE√çCULO</div>
                <div class="vehicle-fields">
                  <div class="vehicle-field" style="width: 120px;">
                    <label>Data Sa√≠da:</label>
                    <input type="date" value="">
                  </div>
                  <div class="vehicle-field" style="width: 150px;">
                    <label>Ve√≠culo:</label>
                    <select>
                      <option></option>
                    </select>
                  </div>
                  <div class="vehicle-field" style="width: 75px;">
                    <label>BBs:</label>
                    <input type="text" placeholder="00" style="width: 100%; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2)">
                  </div>
                  <div class="vehicle-field" style="width: 100px;">
                    <label>Hora Sa√≠da:</label>
                    <input type="time">
                  </div>
                </div>
              </div>
              <div class="vehicle-card">
                <div class="field-card-title">5¬∫ VE√çCULO</div>
                <div class="vehicle-fields">
                  <div class="vehicle-field" style="width: 120px;">
                    <label>Data Sa√≠da:</label>
                    <input type="date" value="">
                  </div>
                  <div class="vehicle-field" style="width: 150px;">
                    <label>Ve√≠culo:</label>
                    <select>
                      <option></option>
                    </select>
                  </div>
                  <div class="vehicle-field" style="width: 75px;">
                    <label>BBs:</label>
                    <input type="text" placeholder="00" style="width: 100%; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2)">
                  </div>
                  <div class="vehicle-field" style="width: 100px;">
                    <label>Hora Sa√≠da:</label>
                    <input type="time">
                  </div>
                </div>
              </div>
              <div class="vehicle-card">
                <div class="field-card-title">6¬∫ VE√çCULO</div>
                <div class="vehicle-fields">
                  <div class="vehicle-field" style="width: 120px;">
                    <label>Data Sa√≠da:</label>
                    <input type="date" value="">
                  </div>
                  <div class="vehicle-field" style="width: 150px;">
                    <label>Ve√≠culo:</label>
                    <select>
                      <option></option>
                    </select>
                  </div>
                  <div class="vehicle-field" style="width: 75px;">
                    <label>BBs:</label>
                    <input type="text" placeholder="00" style="width: 100%; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 2)">
                  </div>
                  <div class="vehicle-field" style="width: 100px;">
                    <label>Hora Sa√≠da:</label>
                    <input type="time">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="warning-text">
            Caso o Tipo de Mensagem seja para enviar igualmente para o GRUPO OCORR√äNCIAS. Preencha todos os campos necess√°rios, e prima em primeiro lugar bot√£o, "WSMS BOMBEIROS", Obrigado.
          </div>
          <textarea id="wsms_output" rows="4" cols="50" readonly style="display: none;"></textarea>
          <div class="action-buttons">
            <button class="btn btn-success" onclick="generateWSMSMessage()">BOMBEIROS</button>
            <button class="btn btn-danger" onclick="generateNewCREPCMessage()">COMUNICAR CREPC</button>
          </div>
        </div>
      </div>
      <!---- M√ìDULO ENCERRAR OCORR√äNCIA ---->
      <div id="page_close_occurrence" class="page">
        <h2 class="section-title">Dados para Encerramento da Ocorr√™ncia</h2>
        <div class="card">
          <div class="card-header">DADOS GLOBAIS</div>
          <div class="card-body">
            <div class="form-row" style="display: flex;">
              <div class="form-group" style="width: 200px;">
                <label>Nr. Ocorr√™ncia:</label>
                <input type="text" id="close_nr_occurrence" placeholder="Ex. 123456789" style="width: 100%; text-align: center;" maxlength="11" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11)">
              </div>
            </div>
          </div>
          <div class="grid-3fr" style="margin: -20px 15px 15px 15px;">
            <div class="vehicle-card" style="min-height: 190px;  margin: 5px;">
              <div class="field-card-title">1¬∫ VE√çCULO</div>
              <div class="vehicle-field-horizontal" style="width: 150px;">
                <label>Ve√≠culo:</label>
                <select style="width: 150px;">
                </select>
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Sd. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Sd. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. Und.:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. Und.:</label>
                <input type="time" style="width: 75px;">
                <label>Kms.:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,4)">
              </div>
              <div class="global-field-horizontal">
                <label>Tempo Bomba:</label>
                <label>Hr:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)">
                <label>Mins:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,2)">
              </div>
            </div>
            <div class="vehicle-card" style="min-height: 190px; margin: 5px;">
              <div class="field-card-title">2¬∫ VE√çCULO</div>
              <div class="vehicle-field-horizontal" style="width: 150px;">
                <label>Ve√≠culo:</label>
                <select style="width: 150px;">
                </select>
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Sd. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Sd. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. Und.:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. Und.:</label>
                <input type="time" style="width: 75px;">
                <label>Kms.:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,4)">
              </div>
              <div class="global-field-horizontal">
                <label>Tempo Bomba:</label>
                <label>Hr:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)">
                <label>Mins:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,2)">
              </div>
            </div>
            <div class="vehicle-card" style="min-height: 190px; margin: 5px;">
              <div class="field-card-title">3¬∫ VE√çCULO</div>
              <div class="vehicle-field-horizontal" style="width: 150px;">
                <label>Ve√≠culo:</label>
                <select style="width: 150px;">
                </select>
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Sd. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Sd. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. Und.:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. Und.:</label>
                <input type="time" style="width: 75px;">
                <label>Kms.:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,4)">
              </div>
              <div class="global-field-horizontal">
                <label>Tempo Bomba:</label>
                <label>Hr:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)">
                <label>Mins:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,2)">
              </div>
            </div>
            <div class="vehicle-card" style="min-height: 190px; margin: 5px;">
              <div class="field-card-title">4¬∫ VE√çCULO</div>
              <div class="vehicle-field-horizontal" style="width: 150px;">
                <label>Ve√≠culo:</label>
                <select style="width: 150px;">
                </select>
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Sd. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Sd. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. Und.:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. Und.:</label>
                <input type="time" style="width: 75px;">
                <label>Kms.:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,4)">
              </div>
              <div class="global-field-horizontal">
                <label>Tempo Bomba:</label>
                <label>Hr:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)">
                <label>Mins:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,2)">
              </div>
            </div>
            <div class="vehicle-card" style="min-height: 190px; margin: 5px;">
              <div class="field-card-title">5¬∫ VE√çCULO</div>
              <div class="vehicle-field-horizontal" style="width: 150px;">
                <label>Ve√≠culo:</label>
                <select style="width: 150px;">
                </select>
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Sd. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Sd. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. Und.:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. Und.:</label>
                <input type="time" style="width: 75px;">
                <label>Kms.:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,4)">
              </div>
              <div class="global-field-horizontal">
                <label>Tempo Bomba:</label>
                <label>Hr:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)">
                <label>Mins:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,2)">
              </div>
            </div>
            <div class="vehicle-card" style="min-height: 190px; margin: 5px;">
              <div class="field-card-title">6¬∫ VE√çCULO</div>
              <div class="vehicle-field-horizontal" style="width: 150px;">
                <label>Ve√≠culo:</label>
                <select style="width: 150px;">
                </select>
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Sd. TO:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Sd. TO:</label>
                <input type="time" style="width: 75px;">
              </div>
              <div class="global-field-horizontal">
                <label>Dt. Ch. Und.:</label>
                <input type="date" style="width: 100px;">
                <label>Hr. Ch. Und.:</label>
                <input type="time" style="width: 75px;">
                <label>Kms.:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="4" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,4)">
              </div>
              <div class="global-field-horizontal">
                <label>Tempo Bomba:</label>
                <label>Hr:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)">
                <label>Mins:</label>
                <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,2)">
              </div>
            </div>
          </div>
        </div>
        <div class="card last-card">
          <div class="card-header">DADOS ADICIONAIS</div>
          <div class="card-body">
            <div class="victims-card" style="min-height: 100px; margin: 5px 0 5px 0;">
              <div class="field-card-title">
                <label style="font-size: 12px;">V√çTIMAS</label>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal">
                  <label>G√©nero:</label>
                  <select id="victim_1_gender" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Idade:</label>
                  <input type="text" id="victim_1_age_unit" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)"> <select id="victim_1_age" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Nacion:</label>
                  <input type="text" id="victim_1_nation" style="width: 175px;">
                </div>
                <div class="global-field-horizontal">
                  <label>Tipo:</label>
                  <select id="victim_1_type" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Estado:</label>
                  <select id="victim_1_status" style="width: 120px;">
                  </select>
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal">
                  <label>G√©nero:</label>
                  <select id="victim_2_gender" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Idade:</label>
                  <input type="text" id="victim_2_age_unit" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)">
                  <select id="victim_2_age" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Nacion:</label>
                  <input type="text" id="victim_2_nation" style="width: 175px;">
                </div>
                <div class="global-field-horizontal">
                  <label>Tipo:</label>
                  <select id="victim_2_type" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Estado:</label>
                  <select id="victim_2_status" style="width: 120px;">
                  </select>
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal">
                  <label>G√©nero:</label>
                  <select id="victim_3_gender" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Idade:</label>
                  <input type="text" id="victim_3_age_unit" placeholder="0" style="width: 50px; text-align: center;" maxlength="3" oninput="this.value = this.value.replace(/[^0-9]/g, '').slice(0,3)">
                  <select id="victim_3_age" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Nacion:</label>
                  <input type="text" id="victim_3_nation" style="width: 175px;">
                </div>
                <div class="global-field-horizontal">
                  <label>Tipo:</label> <select id="victim_3_type" style="width: 120px;">
                  </select>
                </div>
                <div class="global-field-horizontal">
                  <label>Estado:</label>
                  <select id="victim_3_status" style="width: 120px;">
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="grid-2fr" style="margin: -20px 15px 15px 15px;">
            <div class="extras-card" style="min-height: 100px;  max-width: 100%; margin: 5px 0 0 5px ;">
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px;">
                <div class="field-card-title">
                  <label style="font-size: 12px;">OUTROS MEIOS NO TO</label>
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>01.:</label>
                  <input type="text" style="width: 100%;">
                </div>
                <div class="global-field-horizontal">
                  <label>Ve√≠cs.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
                <div class="global-field-horizontal">
                  <label>Elems.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>02.:</label>
                  <input type="text" style="width: 100%;">
                </div>
                <div class="global-field-horizontal">
                  <label>Ve√≠cs.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
                <div class="global-field-horizontal">
                  <label>Elems.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>03.:</label>
                  <input type="text" style="width: 100%;">
                </div>
                <div class="global-field-horizontal">
                  <label>Ve√≠cs.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
                <div class="global-field-horizontal">
                  <label>Elems.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>04.:</label>
                  <input type="text" style="width: 100%;">
                </div>
                <div class="global-field-horizontal">
                  <label>Ve√≠cs.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
                <div class="global-field-horizontal">
                  <label>Elems.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>05.:</label>
                  <input type="text" style="width: 100%;">
                </div>
                <div class="global-field-horizontal">
                  <label>Ve√≠cs.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
                <div class="global-field-horizontal">
                  <label>Elems.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>06.:</label>
                  <input type="text" style="width: 100%;">
                </div>
                <div class="global-field-horizontal">
                  <label>Ve√≠cs.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
                <div class="global-field-horizontal">
                  <label>Elems.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>07.:</label>
                  <input type="text" style="width: 100%;">
                </div>
                <div class="global-field-horizontal">
                  <label>Ve√≠cs.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
                <div class="global-field-horizontal">
                  <label>Elems.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>08.:</label>
                  <input type="text" style="width: 100%;">
                </div>
                <div class="global-field-horizontal">
                  <label>Ve√≠cs.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
                <div class="global-field-horizontal">
                  <label>Elems.:</label>
                  <input type="text" placeholder="0" style="width: 50px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
            </div>
            <div class="demage-card" style="min-height: 100px; max-width: 100%; margin: 5px 5px 0 0 ;">
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px;">
                <div class="field-card-title">
                  <label style="font-size: 12px;">DANOS CAUSADOS</label>
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>01.:</label>
                  <input type="text" style="width: 100%;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>02.:</label>
                  <input type="text" style="width: 100%;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>03.:</label>
                  <input type="text" style="width: 100%;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>04.:</label>
                  <input type="text" style="width: 100%;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>05.:</label>
                  <input type="text" style="width: 100%;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>06.:</label>
                  <input type="text" style="width: 100%;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>07.:</label>
                  <input type="text" style="width: 100%;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>08.:</label>
                  <input type="text" style="width: 100%;">
                </div>
              </div>
            </div>
          </div>

          <div class="grid-2fr" style="margin: -10px 15px 15px 15px;">
            <div class="burned-card" style="min-height: 100px;  max-width: 100%; margin: 5px 0 15px 5px ;">
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px;">
                <div class="field-card-title">
                  <label style="font-size: 12px;">√ÅREA ARDIDA</label>
                </div>
              </div>
              <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>01.:</label>
                  <input type="number" id="area_m2" placeholder="0" style="width: 15%; text-align: center;" oninput="updateHectares()">
                  <label>Mts.2</label>
                </div>
              </div>
              <div class="form-row" style="display: flex; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="flex:1;">
                  <label>02.:</label>
                  <input type="text" id="area_ha" placeholder="0" style="width: 15%; text-align: center;" readonly>
                  <label>Ha.</label>
                </div>
              </div>
            </div>
            <div class="demage-card" style="min-height: 100px; max-width: 100%; margin: 5px 5px 15px 0 ;">
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px;">
                <div class="field-card-title">
                  <label style="font-size: 12px;">OBSERVA√á√ïES</label>
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="width: 100%;">
                  <textarea placeholder="Escreva suas observa√ß√µes..." rows="4" style="width: 100%; resize: vertical;"></textarea>
                </div>
              </div>
            </div>
          </div>
          <div class="form-row" style="margin: 33px 0 0 0; display: flex; flex-wrap: wrap; justify-content: flex-end;">
            <div class="action-buttons">
              <button class="btn btn-danger" onclick="generateCloseCREPCMessage()">COMUNICAR CREPC</button>
            </div>
          </div>
        </div>
      </div>

      <!---- M√ìDULO SOLICITA√á√ÉO DE DISPONIBILIDADES ---->
      <div id="page-solicitation" class="page">
        <h2 class="section-title">Solicita√ß√£o de Disponibilidades para Servi√ßos</h2>
        <div class="card">
          <div class="card-header">TIPO DE SOLICITA√á√ÉO</div>
          <div class="card-body">
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label>Data do Servi√ßo:</label>
                <input type="date" id="solicitation_date" style="width: 100px;">
              </div>
            </div>
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label>Tipo de Solicita√ß√£o:</label>
                <select id="solicitation_type" style="width: 200px;">
                </select>
              </div>
            </div>
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label>Motivo da Solicita√ß√£o:</label>
                <select id="solicitation_motive" style="width: 200px;">
                </select>
              </div>
            </div>
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label>Turno:</label>
                <select id="solicitation_shift" style="width: 75px;">
                </select>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">MEIOS SOLICITADOS</div>
          <div class="card-body">
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label>Motoritas:</label>
                <div class="global-field-horizontal">
                  <input type="text" id="drivers" placeholder="0" style="width: 75px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
              <div class="global-field-horizontal">
                <label>Elementos:</label>
                <div class="global-field-horizontal">
                  <input type="text" id="elements" placeholder="0" style="width: 75px; text-align: center;" maxlength="2" oninput="this.value=this.value.replace(/[^0-9]/g,'').slice(0,2)">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">DESTINO DO SERVI√áO</div>
          <div class="card-body">
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label>Hora de Sa√≠da:</label>
                <div class="global-field-horizontal">
                  <input type="time" id="exit_hour" style="width: 75px;">
                </div>
              </div>
              <div class="global-field-horizontal">
                <label>ULS Destino:</label>
                <div class="global-field-horizontal">
                  <input type="text" id="uls_desteny" placeholder="Ex. IPO Lisboa" style="width: 250px; text-align: center;">
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="form-row" style="margin-top: 35px; margin-right: -20px; display: flex; justify-content: flex-end;">
          <div class="action-buttons">
            <button class="btn btn-success" onclick="generateAvailability()">SOLICITAR</button>
          </div>
        </div>
      </div>

      <!---- M√ìDULO INDISPONIBILIDADE DE VE√çCULOS ---->
      <div id="page-indisp" class="page">
        <h2 class="section-title">Indisponibilidade Ve√≠culos</h2>
        <div class="card">
          <div class="card-header">NOVA INDISPONIBILIDADE DE V√âICULO</div>
          <div class="card-body">
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="vehicle-field-horizontal" style="width: 150px;">
                <label>Ve√≠culo:</label>
                <select id="new_vehicle_unavailable" style="width: 150px;">
                </select>
              </div>
              <div class="global-field-horizontal" style="width: 300px;">
                <label>Motivo da Indisponibilidade:</label>
                <select id="new_reason_unavailability" style="width: 150px;">
                </select>
              </div>
            </div>
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: -3px;">
              <div class="global-field-horizontal">
                <label>Data da Indisponibilidade:</label>
                <div class="extras-field-horizontal">
                  <input type="date" id="new_unavailability_date" style="width: 100px;">
                </div>
              </div>
              <div class="global-field-horizontal">
                <label>Hora da Indisponibilidade:</label>
                <div class="global-field-horizontal">
                  <input type="time" id="new_unavailability_hour" style="width: 75px;">
                </div>
              </div>
            </div>
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal" style="width: 300px;">
                <label>Local da Indisponibilidade:</label>
                <select id="new_unavailability_local" style="width: 150px;">
                </select>
              </div>
            </div>
          </div>
          <div class="form-row" style="margin-top: 20px; margin-bottom: 0px; display: flex; justify-content: flex-end;">
            <div class="action-buttons">
              <button class="btn btn-danger" onclick="generateNewUnvailability()">ENVIAR INDISPONIBILIDADE</button>
            </div>
          </div>
        </div>
        <div class="card">
          <div class="card-header">VE√çCULOS INDISPON√çVEIS</div>
          <div class="card-body">
            <table id="active-unavailability-table" style="width: 100%; border-collapse: collapse; font-size: 11px;">
              <thead>
                <tr style="background-color: #F8F9FA; border-bottom: 2px solid #DEE2E6;">
                  <th style="width: 150px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Data/Hora</th>
                  <th style="width: 200px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Ve√≠culo</th>
                  <th style="width: 400px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Motivo</th>
                  <th style="width: 200px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Estado</th>
                  <th style="width: 200px; padding: 8px; text-align: center; border: 1px solid #DEE2E6;">Parar</th>
                </tr>
              </thead>
              <tbody id="active-unavailability-tbody">
              </tbody>
            </table>
          </div>
          <div class="form-row" style="margin-top: 20px; margin-bottom: 0px; display: flex; justify-content: flex-end;">
            <div class="action-buttons">
              <button class="btn btn-success" onclick="loadActiveUnavailability()">ATUALIZAR LISTA</button>
            </div>
          </div>
        </div>
        <div id="availability-card" class="card last-card">
          <div class="card-header">FIM DE INDISPONIBILIDADE DE V√âICULO DE V√âICULO</div>
          <div class="card-body">
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal" style="width: 150px;">
                <label>Ve√≠culo:</label>
                <div class="global-field-horizontal">
                  <input type="text" id="end_vehicle_unavailable" style="width: 100px; text-align: center;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal" style="width: 300px;">
                  <label>Motivo da Indisponibilidade:</label>
                  <div class="extras-field-horizontal">
                    <input type="text" id="end_reason_unavailability" style="width: 150px; text-align: center;">
                  </div>
                </div>
              </div>
            </div>
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label>Data da Disponibilidade:</label>
                <div class="global-field-horizontal">
                  <input type="date" id="end_unavailability_date" style="width: 100px;">
                </div>
              </div>
              <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
                <div class="global-field-horizontal">
                  <label>Hora da Disponibilidade:</label>
                  <div class="global-field-horizontal">
                    <input type="time" id="end_unavailability_hour" style="width: 75px;">
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="form-row" style="margin-top: 20px; margin-bottom: 15px; display: flex; justify-content: flex-end;">
            <div class="action-buttons">
              <button class="btn btn-success" onclick="generateEndUnavailability()">ENVIAR DISPONIBILIDADE</button>
            </div>
          </div>
        </div>
      </div>

      <!---- M√ìDULO INFORMA√á√ÉO DE ESTADO GRELHA DO MUNIC√çPIO ---->
      <div id="page-municipality-grid" class="page">
        <h2 class="section-title">Info. Grelha Munic√≠pio</h2>
        <div class="card" style="margin: 0 0 25px 0;">
          <div class="card-header">ESTADO OPERACIONAL DA GRELHA DO MUNIC√çPIO</div>
          <div class="card-body">
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label style="font-size: 12px;">Estado Operacional:</label>
                <select id="state_municipality_grid" style="width: 200px;" onchange="toggleMunicipalityGridOutput()">
                </select>
              </div>
            </div>
            <div class="form-row" style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 0px;">
              <div class="global-field-horizontal">
                <label style="font-size: 12px;">Motivo do Estado:</label>
                <input type="text" id="municipality_grid_output" placeholder="Indique um motivo para o estado da grelha." style="width: 700px;">
              </div>
            </div>
            <div class="form-row" style="margin: 30px -25px -25px 0;display: flex; justify-content: flex-end;">
              <div class="action-buttons">
                <button class="btn btn-success" onclick="generateMunicipalityGridMessage()">ENVIAR ESTADO</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="page-utilities" class="page">
        <h2 class="section-title">Utili√°rios</h2>
        <div class="card card last-card">
          <div class="card-header">CONSOLA DE UTILIT√ÅRIOS</div>
          <div class="digital-panel-container">
            <div class="panel-sidebar">
              <button class="panel-menu-button active" onclick="showPanelCard('epe')">Estado EPE/PPI</button>
              <button class="panel-menu-button" onclick="showPanelCard('system')">Sitop. Ve√≠culos</button>
              <button class="panel-menu-button" onclick="showPanelCard('monitoring')">Monitoriza√ß√£o</button>
              <button class="panel-menu-button" onclick="showPanelCard('logs')">Logs do Sistema</button>
              <button class="panel-menu-button" onclick="showPanelCard('settings')">Configura√ß√µes</button>
              <button class="panel-menu-button" onclick="showPanelCard('analytics')">An√°lises</button>
            </div>

            <!-- √Årea de Conte√∫do -->
            <div class="panel-content">
              <!-- Card: Dashboard -->
              <div id="panel-epe" class="panel-card active">
                <h3>ESTADOS DE PRONTID√ÉO ESPECIAL / PLANOS PR√âVIOS DE INTERVEN√á√ÉO</h3>
                <p>Vis√£o geral dos Estados de Prontid√£o Especiais e Planos Pr√©vios de Interven√ß√£o.</p>

                <div class="data-grid">

                  <div class="data-item">
                    <span class="data-value" style="font-size: 15px;">EPE SIOPS DECIR</span>

                    <div class="button-container" id="epe-decir">
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">MONITORIZA√á√ÉO</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL I</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL II</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL III</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL IV</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                    </div>
                  </div>

                  <div class="data-item">
                    <span class="data-value" style="font-size: 15px;">EPE SIOPS DIOPS</span>
                    <div class="button-container" id="epe-diops">
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">MONITORIZA√á√ÉO</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL I</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL II</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL III</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL IV</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                    </div>
                  </div>

                  <div class="data-item">
                    <span class="data-value" style="font-size: 15px;">EPE SIOPS NRBQ</span>
                    <div class="button-container" id="epe-nrbq">
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">MONITORIZA√á√ÉO</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL I</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL II</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL III</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">N√çVEL IV</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                    </div>
                  </div>
                </div>

                <div class="data-grid">
                  <div class="data-item">
                    <span class="data-value" style="font-size: 15px;">PPI AEROPORTO</span>
                    <div class="button-container" id="ppi-aero">
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">MONITORIZA√á√ÉO</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">AMARELO</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">VERMELHO</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                    </div>
                  </div>

                  <div class="data-item">
                    <span class="data-value" style="font-size: 15px;">PPI A22</span>
                    <div class="button-container" id="ppi-a22">
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">MONITORIZA√á√ÉO</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">1¬∫ ALARME</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">2¬∫ ALARME</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">ALARME ESPECIAL</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                    </div>
                  </div>

                  <div class="data-item">
                    <span class="data-value" style="font-size: 15px;">PPI LINHA F√âRREA</span>
                    <div class="button-container" id="ppi-linfer">
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">MONITORIZA√á√ÉO</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">1¬∫ ALARME</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">2¬∫ ALARME</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;">ALARME ESPECIAL</button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                      <button class="panel-btn" style="background-color: lightgrey; color: black;"></button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Card: Sistema -->
              <div id="panel-system" class="panel-card">
                <h3>SITUA√á√ÉO OPERACIONAL DE VE√çCULOS</h3>
                <p>Vis√£o geral do estado operacional dos ve√≠culos.</p>
                <div id="vehicleStatus" class="loading">A carregar ve√≠culos...</div>
                <div class="vehicle-grid" id="vehicleGrid"></div>
              </div>

              <!-- Card: Monitoriza√ß√£o -->
              <div id="panel-monitoring" class="panel-card">
                <h3>Monitoriza√ß√£o em Tempo Real</h3>
                <p>Acompanhamento das opera√ß√µes cr√≠ticas do sistema.</p>                
              </div>

              <!-- Card: Logs -->
              <div id="panel-logs" class="panel-card">
                <h3>Logs do Sistema</h3>
                <p>Registo detalhado das opera√ß√µes do sistema.</p>                      
              </div>

              <!-- Card: Configura√ß√µes -->
              <div id="panel-settings" class="panel-card">
                <h3>Configura√ß√µes do Sistema</h3>
                <p>Defini√ß√µes e par√¢metros de funcionamento.</p>
               
              </div>
              
              <!-- Card: An√°lises -->
              <div id="panel-analytics" class="panel-card">
                <h3>An√°lises e Relat√≥rios</h3>
                <p>Estat√≠sticas e m√©tricas de performance do sistema.</p>
                
              </div>
            </div>
          </div>
        </div>
      </div>

      <!---- M√ìDULO GEST√ÉO DE DADOS ---->
      <div id="page-data" class="page">
        <h2 class="section-title">Data Center</h2>
        <div class="card">
          <div class="card-header">CENTRO DE DADOS</div>
          <div class="card-body">
            <p>Centro de dados do sistema em desenvolvimento.</p>
          </div>
        </div>
      </div>
    </main>
    <footer class="status-bar">
      <div class="system-info">
        WSMS Auto Creator v3.147.24 | Powered by: F√°bio Martins | Sistemas de Informa√ß√£o
      </div>
    </footer>
  </div>
  <script src="js/initcfg.js"></script>
  <script src="js/clsoccr.js"></script>
  <script src="js/solicit.js"></script>
  <script src="js/veicindisp.js"></script>
  <script src="js/mncgrid.js"></script>
  <script src="js/utilities.js"></script>
  <script>
    /* ==============================
        GRUPO UTILIT√ÅRIOS
     ============================== */
    /* ---- TRATAMENTO SCROLL BAR ----*/
    function showPageAndResetScroll(pageId, {
      smooth = false
    } = {}) {
      document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
        p.style.display = 'none';
      });
      const page = document.getElementById(pageId);
      if (!page) return;
      page.style.display = 'block';
      page.classList.add('active');
      requestAnimationFrame(() => {
        const main = document.querySelector('.main-content');
        if (main) {
          if (smooth) main.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
          else main.scrollTop = 0;
        }
        if (page.scrollTop !== undefined) {
          if (smooth) page.scrollTo({
            top: 0,
            behavior: 'smooth'
          });
          else page.scrollTop = 0;
        }
        if (smooth) window.scrollTo({
          top: 0,
          behavior: 'smooth'
        });
        else window.scrollTo(0, 0);
        clearFormFields();
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.sidebar-menu-button[data-page]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const pageId = btn.getAttribute('data-page');
          if (!pageId) return;
          showPageAndResetScroll(pageId, {
            smooth: false
          });
          document.querySelectorAll('.sidebar-menu-button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
        });
      });
    });
    /* ---- NAVEGA√á√ÉO DA SIDEBAR ----*/
    document.addEventListener("DOMContentLoaded", () => {
      const buttons = document.querySelectorAll(".sidebar-menu-button");
      const pages = document.querySelectorAll(".page");

      function hideAllPages() {
        pages.forEach(p => p.classList.remove("active"));
      }

      function removeActiveFromButtons() {
        buttons.forEach(btn => btn.classList.remove("active"));
      }
      buttons.forEach(btn => {
        btn.addEventListener("click", () => {
          hideAllPages();
          removeActiveFromButtons();
          btn.classList.add("active");
          const page = document.getElementById(btn.getAttribute("data-page"));
          if (page) page.classList.add("active");
        });
      });
    });
    /* ---- OBTEN√á√ÉO E FORMATA√á√ÉO DE DATAS ----*/
    function padNumber(num) {
      return String(num).padStart(2, '0');
    }

    function getCurrentDateStr() {
      const d = new Date();
      return `${d.getFullYear()}-${padNumber(d.getMonth()+1)}-${padNumber(d.getDate())}`;
    }

    function formatGDH(dateStr, timeStr) {
      if (!dateStr || !timeStr) return '';
      const date = new Date(dateStr + 'T' + timeStr);
      const day = padNumber(date.getDate());
      const hours = padNumber(date.getHours());
      const minutes = padNumber(date.getMinutes());
      const monthNames = ["JAN", "FEV", "MAR", "ABR", "MAI", "JUN", "JUL", "AGO", "SET", "OUT", "NOV", "DEZ"];
      const month = monthNames[date.getMonth()];
      const year = String(date.getFullYear()).slice(-2);
      return `${day} *${hours}${minutes}* ${month}${year}`;
    }
    /* ---- CARREGAMENTO DE DADOS PARA CAMPOS ---- */
    /* --- Carregamento de Ve√≠culos ---*/
    async function fetchVehiclesFromSupabase() {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/vehicle_status?select=vehicle`, {
          headers: getSupabaseHeaders()
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const vehicles = await response.json();
        return vehicles.map(vehicle => vehicle.vehicle);
      } catch (error) {
        console.error('Erro ao carregar ve√≠culos do Supabase:', error);
        return fallbackVehicles;
      }
    }
    async function populateVehicleSelects() {
      const vehicleSelects = document.querySelectorAll('.vehicle-field select, .vehicle-field-horizontal select');
      vehicleSelects.forEach(select => {
        select.innerHTML = '<option></option>';
      });
      let vehicles = await fetchVehiclesFromSupabase();
      vehicles.sort((a, b) => a.localeCompare(b, 'pt', {
        sensitivity: 'base'
      }));
      vehicleSelects.forEach(select => {
        select.innerHTML = '<option value=""></option>';
        vehicles.forEach(vehicle => {
          const option = document.createElement('option');
          option.value = vehicle;
          option.textContent = vehicle;
          select.appendChild(option);
        });
      });
    }
    /* --- Tratamento Tipo de Ocorr√™ncia --- */
    async function fetchClassOccorrById(classId) {
      try {
        const response = await fetch(`${SUPABASE_URL}/rest/v1/class_occorr?select=occorr_descr&class_occorr=eq.${encodeURIComponent(classId)}`, {
          headers: getSupabaseHeaders()
        });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        return data.length > 0 ? data[0].occorr_descr : '';
      } catch (error) {
        console.error("Erro ao buscar descri√ß√£o da classe:", error);
        return '';
      }
    }
    const classOccorrInput = document.getElementById('class_occorr_input');
    if (classOccorrInput) {
      classOccorrInput.addEventListener('input', async (e) => {
        const classId = e.target.value.trim();
        const descrInput = document.getElementById('occorr_descr_input');
        if (!classId) {
          descrInput.value = '';
          return;
        }
        const descr = await fetchClassOccorrById(classId);
        descrInput.value = descr;
      });
    }
    /* --- Carregamento de Concelhos --- */
    async function fetchCouncilsFromSupabase() {
      try {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/councils_select?select=id,council`, {
          headers: getSupabaseHeaders()
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const councils = await resp.json();
        return councils.map(c => ({
          id: c.id,
          name: c.council
        }));
      } catch (e) {
        console.error("Erro ao buscar concelhos:", e);
        return fallbackCouncils;
      }
    }
    async function populateCouncilSelect() {
      const sel = document.getElementById('council_select');
      if (!sel) return;
      sel.innerHTML = '<option></option>';
      const councils = (await fetchCouncilsFromSupabase()).sort((a, b) =>
        a.name.localeCompare(b.name, 'pt', {
          sensitivity: 'base'
        })
      );
      sel.innerHTML = '<option></option>';
      councils.forEach(c => {
        const o = document.createElement('option');
        o.value = c.id;
        o.textContent = c.name;
        sel.appendChild(o);
      });
      if (sel.value) {
        populateParishes(sel.value);
      }
    }
    /* --- Carregamento de Freguesias ---*/
    async function fetchParishesByCouncil(councilId) {
      if (!councilId) return [];
      try {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/parishes_select?select=parish&council_id=eq.${councilId}`, {
          headers: getSupabaseHeaders()
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const parishes = await resp.json();
        return parishes.map(p => p.parish);
      } catch (e) {
        console.error("Erro ao buscar freguesias:", e);
        return fallbackParishes[councilId] || [];
      }
    }
    async function populateParishes(councilId) {
      const sel = document.getElementById('parish_select');
      if (!sel) return;
      sel.innerHTML = '';
      const parishes = (await fetchParishesByCouncil(councilId)).sort((a, b) =>
        a.localeCompare(b, 'pt', {
          sensitivity: 'base'
        })
      );
      sel.innerHTML = '';
      parishes.forEach(p => {
        const o = document.createElement('option');
        o.value = p;
        o.textContent = p;
        sel.appendChild(o);
      });
    }
    document.addEventListener('DOMContentLoaded', () => {
      const councilSelect = document.getElementById('council_select');
      if (councilSelect) {
        populateCouncilSelect();
        councilSelect.addEventListener('change', async (e) => {
          const councilId = e.target.value;
          const parishSelect = document.getElementById('parish_select');
          if (!councilId) {
            parishSelect.innerHTML = '<option value=""></option>';
            return;
          }
          await populateParishes(councilId);
        });
      }
    });
    /* --- Carregamento de Par√¢metros Globais ---*/
    async function fetchGlobalOptions(category) {
      try {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/static_options?select=value&category=eq.${category}`, {
          headers: getSupabaseHeaders()
        });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const data = await resp.json();
        return data.map(d => d.value).filter(v => v); // ignora nulos
      } catch (e) {
        console.error(`Erro ao buscar op√ß√µes de ${category}:`, e);
        return [];
      }
    }
    async function populateGlobalSelects() {
      const globalFields = [{
          id: 'alert_type',
          category: 'alert_type'
        },
        {
          id: 'alert_source',
          category: 'alert_source'
        },
        {
          id: 'channel_maneuver',
          category: 'channel_maneuver'
        },
        {
          id: 'ppi_type',
          category: 'ppi_type'
        },
        {
          id: 'solicitation_type',
          category: 'solicitation_type'
        },
        {
          id: 'solicitation_motive',
          category: 'solicitation_motive'
        },
        {
          id: 'solicitation_shift',
          category: 'solicitation_shift'
        },
        {
          id: 'new_reason_unavailability',
          category: 'reason_unavailability'
        },
        {
          id: 'new_unavailability_local',
          category: 'local_unavailability'
        },
        {
          id: 'state_municipality_grid',
          category: 'municipality_grid'
        }
      ];
      const victimCategories = ['victim_gender', 'victim_age', 'victim_type', 'victim_status'];
      const victimsCount = 3;
      const victimFields = [];
      for (let i = 1; i <= victimsCount; i++) {
        for (let cat of victimCategories) {
          const fieldId = `victim_${i}_${cat.split('_')[1]}`;
          victimFields.push({
            id: fieldId,
            category: cat
          });
        }
      }
      const allFields = [...globalFields, ...victimFields];
      for (let f of allFields) {
        const select = document.getElementById(f.id);
        if (!select) {
          console.warn(`Select com id "${f.id}" n√£o encontrado.`);
          continue;
        }
        select.innerHTML = '<option></option>';
        const options = await fetchGlobalOptions(f.category);
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          select.appendChild(o);
        });
      }
    }
    document.addEventListener('DOMContentLoaded', populateGlobalSelects);
    /* ---- POPUPUS E AVISOS ----*/
    function showPopupMissingFields(fields) {
      const modal = document.getElementById('popup-modal');
      const list = document.getElementById('missing-fields-list');
      if (!modal || !list) return;
      list.innerHTML = '';
      fields.forEach(f => {
        const li = document.createElement('li');
        li.textContent = f;
        list.appendChild(li);
      });
      modal.classList.add('show');
      const okBtn = document.getElementById('popup-ok-btn');
      if (okBtn) okBtn.onclick = () => modal.classList.remove('show');
    }

    function showPopupSuccess(clearFields = false) {
      const modal = document.getElementById('popup-success-modal');
      if (!modal) return;
      modal.classList.add('show');
      const okBtn = document.getElementById('popup-success-ok-btn');
      if (okBtn) {
        okBtn.onclick = () => {
          modal.classList.remove('show');
          if (clearFields) clearFormFields();
        };
      }
    }

    function showPopupWarning(message) {
      const modal = document.getElementById('popup-warning-modal');
      if (!modal) return;
      const textElem = modal.querySelector('p');
      if (textElem) textElem.textContent = message;
      modal.classList.add('show');
      const okBtn = document.getElementById('popup-warning-ok-btn');
      if (okBtn) okBtn.onclick = () => modal.classList.remove('show');
    }
    /* ==============================
       GRUPO OCORR√äNCIAS EM CURSO
    ============================== */
    function parseDateTime(dateTimeStr) {
      if (!dateTimeStr) return null;
      const [datePart, timePart] = dateTimeStr.split(' ');
      if (!datePart || !timePart) return null;
      const [day, month, year] = datePart.split('/').map(Number);
      const [hours, minutes] = timePart.split(':').map(Number);
      return new Date(year, month - 1, day, hours, minutes);
    }
    /* ---- LEITURA, CARREGAMENTO E AVISO DE OCORR√äNCIAS ---- */
    let blinkInterval = null;

    function startBlinkingSidebarButton() {
      const btn = document.querySelector('.sidebar-menu-button[data-page="page-active_occurrences"]');
      if (!btn || blinkInterval) return;
      const originalColor = '#343A40';
      const activeColor = '#DC3545';
      let isOriginal = false;
      blinkInterval = setInterval(() => {
        btn.style.backgroundColor = isOriginal ? originalColor : activeColor;
        isOriginal = !isOriginal;
      }, 900);
    }

    function stopBlinkingSidebarButton() {
      const btn = document.querySelector('.sidebar-menu-button[data-page="page-active_occurrences"]');
      if (!btn) return;
      clearInterval(blinkInterval);
      blinkInterval = null;
      btn.style.backgroundColor = '';
    }
    async function tableHasData() {
      const tbody = document.getElementById('active-occurrences-tbody');
      if (!tbody) return false;
      return Array.from(tbody.rows).some(row => !row.querySelector('td[colspan]'));
    }
    async function updateSidebarButtonBlinking() {
      if (await tableHasData()) {
        startBlinkingSidebarButton();
      } else {
        stopBlinkingSidebarButton();
      }
    }
    loadActiveOccurrences().then(() => updateSidebarButtonBlinking());
    setInterval(updateSidebarButtonBlinking, 1000);
    async function loadActiveOccurrences() {
      const tbody = document.getElementById('active-occurrences-tbody');
      if (!tbody) return;
      tbody.innerHTML = '';
      try {
        const resp = await fetch(`${SUPABASE_URL}/rest/v1/occurrences_control?select=*,vehicles&status=in.(Em Curso,Em Resolu√ß√£o,Em Conclus√£o)`, {
          headers: getSupabaseHeaders()
        });
        if (!resp.ok) throw new Error(`HTTP error! status: ${resp.status}`);
        const occurrences = await resp.json();
        if (occurrences.length === 0) {
          tbody.innerHTML = `
        <tr>
          <td colspan="8" style="padding: 20px; text-align: center; color: #6C757D;">
            N√£o existem ocorr√™ncias ativas neste momento.
          </td>
        </tr>`;
          return;
        }
        occurrences.forEach(occ => {
          const startDate = parseDateTime(occ.start_date);
          let formattedDate = occ.start_date;
          if (startDate) {
            formattedDate = `${String(startDate.getDate()).padStart(2,'0')}/${String(startDate.getMonth()+1).padStart(2,'0')}/${startDate.getFullYear()} ${String(startDate.getHours()).padStart(2,'0')}:${String(startDate.getMinutes()).padStart(2,'0')}`;
          }
          let vehiclesCount = 0;
          if (Array.isArray(occ.vehicles)) vehiclesCount = occ.vehicles.length;
          else if (typeof occ.vehicles === 'string') vehiclesCount = occ.vehicles.split(',').filter(v => v.trim() !== '').length;
          const tr = document.createElement('tr');
          tr.innerHTML = `
        <td style="text-align: center; border: 1px solid #DEE2E6;">${formattedDate}</td>
        <td style="text-align: center; border: 1px solid #DEE2E6;">${occ.occorrence}</td>
        <td style="text-align: center; border: 1px solid #DEE2E6;">${occ.local}</td>
        <td style="text-align: center; border: 1px solid #DEE2E6;">${occ.localitie}</td>
        <td style="text-align: center; border: 1px solid #DEE2E6;">${vehiclesCount}</td>
        <td style="text-align: center; border: 1px solid #DEE2E6;">${occ.status}</td>
        <td style="text-align: center; border: 1px solid #DEE2E6;">
          <button class="btn btn-danger posit-btn" style="font-size: 10px;">POSIT</button>
        </td>        
      `;
          tbody.appendChild(tr);
          tr.querySelector('.posit-btn').addEventListener('click', () => openPositPopup(occ));
        });
      } catch (error) {
        console.error("Erro ao carregar ocorr√™ncias ativas:", error);
        tbody.innerHTML = `
      <tr>
        <td colspan="8" style="padding: 20px; text-align: center; color: red;">
          Erro ao carregar ocorr√™ncias
        </td>
      </tr>`;
      }
    }
    /* ---- POPUP ESPECIAL DE  POSIT ---- */
    let currentPositId = null;

    function openPositPopup(occurrence) {
      currentPositId = occurrence.id;
      document.getElementById('posit-description').value = occurrence.occorrence || '';
      document.getElementById('posit-local').value = occurrence.local || '';
      document.getElementById('posit-localidade-hidden').value = occurrence.localitie || '';
      document.getElementById('posit-status').value = occurrence.status || '';
      document.getElementById('posit-text').value = '';
      document.getElementById('posit-time').value = '';
      document.getElementById('desmobilizacao').checked = false;
      document.getElementById('popup-posit-modal').style.display = 'flex';
    }
    const positTimeInput = document.getElementById('posit-time');
    positTimeInput.addEventListener('input', (e) => {
      let val = e.target.value.replace(/\D/g, '');
      if (val.length > 4) val = val.slice(0, 4);
      let hours = val.slice(0, 2);
      let minutes = val.slice(2, 4);
      if ((hours.length === 2 && Number(hours) > 23) || (minutes.length === 2 && Number(minutes) > 59)) {
        e.target.value = '';
        return;
      }
      e.target.value = minutes ? `${hours}:${minutes}` : hours;
    });

    function closePositPopup() {
      document.getElementById('popup-posit-modal').style.display = 'none';
      loadActiveOccurrences();
    }
    document.getElementById('posit-send-btn').onclick = async function() {
      const status = document.getElementById('posit-status').value;
      if (!currentPositId) {
        showPopupWarning("N√£o selecionou nenhuma ocorr√™ncia.");
        return;
      }
      const occorrence = document.getElementById('posit-description').value;
      const local = document.getElementById('posit-local').value;
      const localidade = document.getElementById('posit-localidade-hidden').value;
      const horaPosit = document.getElementById('posit-time').value;
      const positText = document.getElementById('posit-text').value;
      const desmobilizacao = document.getElementById('desmobilizacao').checked;
      let mensagem = `*üö®üö®INFORMA√á√ÉOüö®üö®*\n\n`;
      mensagem += `*Ocorr√™ncia: ${occorrence}, _${local}, ${localidade}._*\n`;
      mensagem += `*\\\\POSIT: ${horaPosit},* _${positText}_`;
      if (desmobilizacao) mensagem += ` _*Desmobiliza√ß√£o dos Meios Integrantes.*_`;
      try {
        if (status === "Encerrada") {
          const resp = await fetch(`${SUPABASE_URL}/rest/v1/occurrences_control?id=eq.${currentPositId}`, {
            method: "DELETE",
            headers: getSupabaseHeaders()
          });
          if (!resp.ok) throw new Error(`Erro ao apagar ocorr√™ncia: ${resp.status}`);
        } else if (status !== document.getElementById('posit-status').defaultValue) {
          const resp = await fetch(`${SUPABASE_URL}/rest/v1/occurrences_control?id=eq.${currentPositId}`, {
            method: "PATCH",
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json',
              'Prefer': 'return=representation'
            },
            body: JSON.stringify({
              status
            })
          });
          if (!resp.ok) throw new Error(`Erro ao atualizar ocorr√™ncia: ${resp.status}`);
        }
        navigator.clipboard.writeText(mensagem).then(() => {
          if (typeof showPopupSuccess === 'function') {}
          showPopupSuccess("Mensagem POSIT copiada!");
          setTimeout(() => closePositPopup(), 500);
        }).catch(err => {
          console.error("Erro ao copiar POSIT:", err);
        });
      } catch (err) {
        console.error("Erro POSIT:", err);
        showPopupWarning("Erro ao enviar POSIT!");
      }
    };
    document.addEventListener('DOMContentLoaded', () => {
      const btnActive = document.querySelector('button[data-page="page-active_occurrences"]');
      if (btnActive) {
        btnActive.addEventListener('click', () => {
          loadActiveOccurrences();
        });
      }
    });
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('popup-posit-modal').style.display = 'none';
      loadActiveOccurrences();
    });
    /* ==============================
       GRUPO INSERIR OCORR√äNCIAS
    ============================== */
    /* ---- TOOGLE DE CAMPO DIN√ÇMICOS ----*/
    /* --- Toogle Tipo de Alerta ---*/
    function toggleAlertTypeFields() {
      const alertType = document.getElementById('alert_type')?.value;
      const ppiType = document.getElementById('ppi_type')?.value;
      const ppiTypeField = document.getElementById('ppi_type');
      const alertLevel = document.getElementById('alert_level');
      const alarmGrid = document.getElementById('alarm_grid');
      const kmField = document.getElementById('km');
      const kmLabel = document.querySelector('label[for="km"]');
      const onGoing = document.getElementById('on_going');
      const incidentType = document.getElementById('incident_type');
      const blockFields = [ppiTypeField, alertLevel, alarmGrid, kmField, onGoing, incidentType];
      if (alertType !== 'Plano Pr√©vio de Interven√ß√£o') {
        blockFields.forEach(field => {
          if (!field) return;
          field.value = '';
          field.disabled = true;
          if (field.tagName === 'SELECT' && field !== ppiTypeField) {
            field.innerHTML = '<option value=""></option>';
          }
        });
        if (ppiTypeField) {
          ppiTypeField.disabled = true;
          ppiTypeField.value = '';
        }
        if (kmLabel) kmLabel.textContent = "Km:";
        return;
      }
      blockFields.forEach(field => {
        if (field) field.disabled = false;
      });
      if (ppiType === 'PPI Aeroporto Gago Coutinho') {
        ['km', 'on_going', 'incident_type'].forEach(id => {
          const f = document.getElementById(id);
          if (f) f.disabled = true;
        });
      }
      if (kmLabel || kmField) {
        let label = kmLabel || kmField?.previousElementSibling;
        if (label) {
          if (ppiType === 'PPI Via do Infante - A22') {
            label.textContent = "Km:";
          } else if (ppiType === 'PPI Linha F√©rrea do Algarve') {
            label.textContent = "Pkm:";
          } else {
            label.textContent = "Km:";
          }
        }
      }
      if (alertLevel) {
        alertLevel.innerHTML = '<option value=""></option>';
        let options = [];
        if (ppiType === 'PPI Aeroporto Gago Coutinho') {
          options = ['AMARELO', 'VERMELHO'];
        } else if (ppiType) {
          options = ['1¬∫ ALARME', '2¬∫ ALARME', 'ALARME ESPECIAL'];
        }
        options.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          alertLevel.appendChild(o);
        });
      }
      if (alarmGrid) {
        alarmGrid.innerHTML = '<option value=""></option>';
        let gridOptions = [];
        if (ppiType === 'PPI Aeroporto Gago Coutinho') {
          gridOptions = ['A1', 'A2', 'A3', 'A4', 'B1'];
        } else if (ppiType === 'PPI Via do Infante - A22') {
          const letters = 'ABCDEFGHIJKLMNOPQRST';
          letters.split('').forEach(l => {
            gridOptions.push(`1${l}`);
            gridOptions.push(`2${l}`);
          });
        } else if (ppiType === 'PPI Linha F√©rrea do Algarve') {
          const letters = 'ABCDEFGHIJKLMNOP';
          gridOptions = letters.split('');
        }
        gridOptions.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          alarmGrid.appendChild(o);
        });
      }
      if (incidentType) {
        incidentType.innerHTML = '<option value=""></option>';
        let incidents = [];
        if (ppiType === 'PPI Via do Infante - A22') {
          incidents = ['Acidente', 'Subst√¢ncias Perigosas', 'Inc√™ndio em Transportes'];
        } else if (ppiType === 'PPI Linha F√©rrea do Algarve') {
          incidents = [
            'Acidente - Abalroamento, Choque e Descarrilamento',
            'Subst√¢ncias Perigosas - Produtos Qu√≠micos/Produtos Biol√≥gicos',
            'Inc√™ndio em Transportes'
          ];
        }
        incidents.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          incidentType.appendChild(o);
        });
      }
      if (onGoing) {
        onGoing.innerHTML = '<option value=""></option>';
        let directions = [];
        if (ppiType === 'PPI Via do Infante - A22') {
          directions = [
            'Faro --- Vila Real de Santo Ant√≥nio',
            'Faro --- Portim√£o'
          ];
        } else if (ppiType === 'PPI Linha F√©rrea do Algarve') {
          directions = [
            'Tunes --- Lagos',
            'Tunes --- Vila Real de Santo Ant√≥nio'
          ];
        }
        directions.forEach(opt => {
          const o = document.createElement('option');
          o.value = opt;
          o.textContent = opt;
          onGoing.appendChild(o);
        });
      }
    }
    /* --- Toogle INEM-CODU ---*/
    function toggleEMSNrField() {
      const alertSource = document.getElementById('alert_source')?.value;
      const emsGroup = document.getElementById('ems_group');
      if (!emsGroup) return;
      emsGroup.style.display = (alertSource === 'CODU' || alertSource === 'INEM') ? 'flex' : 'none';
    }
    /* --- Toogle Contactos ---*/
    function toggleContactFields() {
      const alertSource = document.getElementById('alert_source')?.value;
      const contactName = document.getElementById('contact_name');
      const contactNr = document.getElementById('contact_nr');
      if (!contactName || !contactNr) return;
      if (alertSource === 'Popular') {
        contactName.disabled = false;
        contactNr.disabled = false;
      } else {
        contactName.disabled = true;
        contactNr.disabled = true;
        contactName.value = '';
        contactNr.value = '';
      }
    }
    document.addEventListener('DOMContentLoaded', () => {
      toggleAlertTypeFields();
      document.getElementById('alert_type')?.addEventListener('change', toggleAlertTypeFields);
      document.getElementById('ppi_type')?.addEventListener('change', toggleAlertTypeFields);
      const alertSourceSelect = document.getElementById('alert_source');
      if (alertSourceSelect) {
        toggleEMSNrField();
        toggleContactFields();
        alertSourceSelect.addEventListener('change', () => {
          toggleEMSNrField();
          toggleContactFields();
        });
      }
    });
    /* ---- LIMPEZA E VALIDAL√á√ÉO DE CAMPOS ---- */
    function getAlertTime() {
      const t = document.getElementById('alert_time')?.value;
      return t || '';
    }

    function clearFormFields() {
      const today = getCurrentDateStr();
      document.querySelectorAll('input[type="text"], input[type="time"]').forEach(i => i.value = '');
      document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
      document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);
      document.querySelectorAll('textarea').forEach(t => t.value = '');
      setTimeout(() => {
        const parishSelect = document.getElementById('parish_select');
        if (parishSelect) {
          parishSelect.innerHTML = '';
        }
      }, 10);
    }

    function validateRequiredFields() {
      const missingFields = [];
      const alertType = document.getElementById('alert_type')?.value;
      const alertSource = document.getElementById('alert_source')?.value;
      if (!alertType) missingFields.push("Tipo de Alerta");
      if (!alertSource) missingFields.push("Fonte do Alerta");
      const emsGroup = document.getElementById('ems_group');
      const emsNr = document.getElementById('ems_nr');
      if (emsGroup && emsGroup.style.display !== 'none' && !emsNr.value.trim()) missingFields.push("Nr. CODU");
      if (!document.getElementById('alert_time')?.value) missingFields.push("Hora do Alerta");
      if (!document.getElementById('class_occorr_input')?.value) missingFields.push("Classifica√ß√£o da Ocorr√™ncia");
      if (!document.getElementById('occorr_local_input')?.value) missingFields.push("Local da Ocorr√™ncia");
      if (!document.getElementById('occorr_localitie_input')?.value) missingFields.push("Localidade da Ocorr√™ncia");
      if (alertSource === 'Popular') {
        if (!document.getElementById('contact_name')?.value.trim()) missingFields.push("Nome do Contactante");
        if (!document.getElementById('contact_nr')?.value.trim()) missingFields.push("Contacto do Contactante");
      }
      const hasVehicle = Array.from(document.querySelectorAll('.vehicle-card select')).some(sel => sel.value.trim() !== '');
      if (!hasVehicle) missingFields.push("A ocorr√™ncia deve conter pelo menos 1 Ve√≠culo");
      if (missingFields.length > 0) {
        showPopupMissingFields(missingFields);
        return false;
      }
      return true;
    }
    /* ---- CRIA√á√ÉO DE MENSAGEM DE NOVA OCORR√äNCIA CREPC ----*/
    function generateNewCREPCMessage() {
      if (!validateRequiredFields()) return '';
      const alertSource = 'CREPC Algarve';
      const alertDate = document.getElementById('alert_date')?.value || '';
      const alertTime = document.getElementById('alert_time')?.value || '';
      const classOccorr = document.getElementById('class_occorr_input')?.value || '';
      const localOccorr = document.getElementById('occorr_local_input')?.value || '';
      const localitie = document.getElementById('occorr_localitie_input')?.value || '';
      const councilSelect = document.getElementById('council_select');
      const council = councilSelect ? councilSelect.options[councilSelect.selectedIndex]?.text || '' : '';
      const parishSelect = document.getElementById('parish_select');
      const parish = parishSelect ? parishSelect.options[parishSelect.selectedIndex]?.text || '' : '';
      const nrOccurrence = document.getElementById('nr_occurrence_input')?.value?.trim() || '';
      const gdhAlerta = formatGDH(alertDate, alertTime);
      const vehicles = [];
      document.querySelectorAll('.vehicle-card').forEach(card => {
        const vehicle = card.querySelector('select')?.value?.trim() || '';
        const bbs = card.querySelector('input[type="text"]')?.value?.trim() || '';
        const vDate = card.querySelector('input[type="date"]')?.value || '';
        const vTime = card.querySelector('input[type="time"]')?.value || '';
        const gdhVehicle = formatGDH(vDate, vTime);
        if (vehicle) {
          vehicles.push(`*GDH Sd Und:* ${vehicle} | ${gdhVehicle} | ${bbs ? bbs + ' BBs.' : ''}`);
        }
      });
      let message = '';
      if (nrOccurrence) {
        message =
          `*‚ûï Agregar √† Ocorr√™ncia*\n\n` +
          `*FONTE ALERTA:* ${alertSource}\n` +
          `*N. OC:* ${nrOccurrence}\n` +
          `*GDH ALERTA:* ${gdhAlerta}\n` +
          `*CLASS OC:* ${classOccorr}\n` +
          `*LOCAL:* ${localOccorr} - ${localitie} - ${council} - ${parish}\n` +
          `${vehicles.join('\n')}`;
      } else {
        message =
          `*‚úÖ Registo de Nova Ocorr√™ncia*\n\n` +
          `*FONTE ALERTA:* ${alertSource}\n` +
          `*GDH ALERTA:* ${gdhAlerta}\n` +
          `*CLASS OC:* ${classOccorr}\n` +
          `*LOCAL:* ${localOccorr} - ${localitie} - ${council} - ${parish}\n` +
          `${vehicles.join('\n')}\n\n` +
          `*Agrade√ßo N. OC:*`;
      }
      const out = document.getElementById('wsms_output');
      if (out) out.value = message;
      if (navigator.clipboard?.writeText) navigator.clipboard.writeText(message).catch(() => {});
      showPopupSuccess(true);
      return message;
    }
    /* ---- CRIA√á√ÉO DE MENSAGEM DE NOVA OCORR√äNCIA GLOBAL ----*/
    let lastWSMSData = null;
    async function generateWSMSMessage() {
      if (!validateRequiredFields()) return '';
      const alertTime = getAlertTime();
      const alertType = document.getElementById('alert_type')?.value || '';
      const alertSource = document.getElementById('alert_source')?.value || '';
      const descrOccorr = document.getElementById('occorr_descr_input')?.value || '';
      const localitie = document.getElementById('occorr_localitie_input')?.value || '';
      const localOccorr = document.getElementById('occorr_local_input')?.value || '';
      const ppiType = document.getElementById('ppi_type')?.value || '';
      const alertLevel = document.getElementById('alert_level')?.value || '';
      const ppiGrid = document.getElementById('alarm_grid')?.value || '';
      const ppiKm = document.getElementById('km')?.value || '';
      const ppiDirection = document.getElementById('on_going')?.value || '';
      const ppiIncident = document.getElementById('incident_type')?.value || '';
      const channelManeuver = document.getElementById('channel_maneuver')?.value?.trim() || '';
      const vehicles = [];
      document.querySelectorAll('.vehicle-card').forEach(card => {
        const vehicle = card.querySelector('select')?.value?.trim() || '';
        const bbs = card.querySelector('input[type="text"]')?.value?.trim() || '';
        if (vehicle) vehicles.push(bbs ? `${vehicle}|${bbs} BBs.` : vehicle);
      });
      const currentData = {
        alertType,
        alertSource,
        descrOccorr,
        localitie,
        localOccorr,
        ppiType,
        alertLevel,
        ppiGrid,
        ppiKm,
        ppiDirection,
        ppiIncident,
        vehicles: vehicles.join(',')
      };
      if (lastWSMSData && JSON.stringify(lastWSMSData) === JSON.stringify(currentData)) {
        showPopupWarning("J√° existe uma ocorr√™ncia com as mesmas caracter√≠sticas.");
        return document.getElementById('wsms_output')?.value || '';
      }
      lastWSMSData = currentData;
      let message = '';
      const vehicleText = vehicles.length ? `Sa√≠da de ${vehicles.join(', ')}` : '';
      const vehicleSufix = vehicleText ? `, ${vehicleText}` : '';
      if (alertType === 'Ocorr√™ncia') {
        message = `*üö®üö®INFORMA√á√ÉOüö®üö®*\n\n*\\\\${alertSource}, HI: ${alertTime}, Ativa√ß√£o para ${descrOccorr} em Faro\\${localitie}\\${localOccorr}${vehicleSufix}* `;
      } else if (alertType === 'Plano Pr√©vio de Interven√ß√£o') {
        if (ppiType === 'PPI Aeroporto Gago Coutinho') {
          if (alertLevel === 'Amarelo') {
            message = `*üö®üö®INFORMA√á√ÉOüö®üö®*\n\n*\\\\${alertSource}, HI: ${alertTime}, Ativa√ß√£o do ${ppiType} de n√≠vel ${alertLevel}, para a Grelha ${ppiGrid}, PREVEN√á√ÉO LOCAL.*`;
          } else if (alertLevel === 'Vermelho') {
            const zoneLRT = "37.020046,-7.973326";
            const zoneZCR = "37.019382,-7.977624";
            const vehiclesLRT = "VCOT, ABSC - Devem Posicionar-se na LRT";
            const vehiclesZCR = "VCI, VTT - Devem Posicionar-se na ZCR";
            message = `*üö®üö®INFORMA√á√ÉOüö®üö®*\n\n*\\\\${alertSource}, HI: ${alertTime}, Ativa√ß√£o do ${ppiType} de n√≠vel VERMELHO, para a Grelha ${ppiGrid}, MOBILIZA√á√ÉO TOTAL DO CB.*\n\n*Ve√≠culos: ${vehiclesLRT}*\n*Ve√≠culos: ${vehiclesZCR}*\n\n*LOCALIZA√á√ÉO LRT:* (https://www.google.com/maps?q=${zoneLRT})\n*LOCALIZA√á√ÉO ZCR:* (https://www.google.com/maps?q=${zoneZCR})`;
          }
        } else {
          message = `*üö®üö®INFORMA√á√ÉOüö®üö®*\n\n*\\\\${alertSource}, HI: ${alertTime}, Ativa√ß√£o do ${alertLevel} para o ${ppiType}, para a Grelha ${ppiGrid}, ao km: ${ppiKm}, no sentido ${ppiDirection} para ${ppiIncident}*`;
        }
      }
      if (channelManeuver) {
        message += `*Canal Manobra:${channelManeuver}*`;
      }
      const out = document.getElementById('wsms_output');
      if (out) out.value = message;
      if (navigator.clipboard?.writeText) navigator.clipboard.writeText(message).catch(() => {});
      showPopupSuccess(false);
      await saveOccurrenceToSupabase(currentData, vehicles.length);
      loadActiveOccurrences();
      return message;
    }
    /* ---- GRAVA√á√ÉO DE OCORR√äNCIA EM DB ----*/
    async function saveOccurrenceToSupabase(data, vehiclesCount) {
      try {
        const alertDate = document.getElementById('alert_date')?.value || '';
        const alertTime = document.getElementById('alert_time')?.value || '';
        if (!alertDate || !alertTime) {
          console.error("Data ou hora do alerta em falta");
          return null;
        }
        const startDateTime = new Date(`${alertDate}T${alertTime}`);
        const formattedDate =
          `${String(startDateTime.getDate()).padStart(2,'0')}/${String(startDateTime.getMonth()+1).padStart(2,'0')}/${startDateTime.getFullYear()} ` +
          `${String(startDateTime.getHours()).padStart(2,'0')}:${String(startDateTime.getMinutes()).padStart(2,'0')}`;
        const query = `occorrence=eq.${encodeURIComponent(data.descrOccorr)}&local=eq.${encodeURIComponent(data.localOccorr)}&localitie=eq.${encodeURIComponent(data.localitie)}&start_date=eq.${encodeURIComponent(formattedDate)}`;
        const checkResp = await fetch(`${SUPABASE_URL}/rest/v1/occurrences_control?${query}`, {
          headers: getSupabaseHeaders()
        });
        const existing = await checkResp.json();
        if (existing.length > 0) {
          const existingOccurrence = existing[0];
          let existingVehiclesCount = 0;
          if (Array.isArray(existingOccurrence.vehicles)) {
            existingVehiclesCount = existingOccurrence.vehicles.length;
          } else if (typeof existingOccurrence.vehicles === 'string') {
            existingVehiclesCount = existingOccurrence.vehicles.split(',').filter(v => v.trim() !== '').length;
          }
          if (existingVehiclesCount === vehiclesCount) {
            showPopupWarning("J√° existe uma ocorr√™ncia com estas caracter√≠sticas.");
            return null;
          } else {
            const updateResp = await fetch(`${SUPABASE_URL}/rest/v1/occurrences_control?id=eq.${existingOccurrence.id}`, {
              method: 'PATCH',
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json',
                'Prefer': 'return=representation'
              },
              body: JSON.stringify({
                vehicles: vehiclesCount
              })
            });
            return await updateResp.json();
          }
        }
        const insertResp = await fetch(`${SUPABASE_URL}/rest/v1/occurrences_control`, {
          method: 'POST',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          },
          body: JSON.stringify({
            start_date: formattedDate,
            occorrence: data.descrOccorr,
            local: data.localOccorr,
            localitie: data.localitie,
            vehicles: vehiclesCount,
            status: "Em Curso"
          })
        });
        return await insertResp.json();
      } catch (e) {
        console.error("Erro ao gravar ocorr√™ncia:", e);
        showPopupWarning("‚ùå Erro inesperado.");
        return null;
      }
    }
    document.addEventListener('DOMContentLoaded', async () => {
      document.querySelectorAll('input[type="date"]').forEach(i => i.value = getCurrentDateStr());
      document.querySelectorAll('input[type="time"]').forEach(i => i.value = '');
      await populateCouncilSelect();
      await populateVehicleSelects();
      toggleEMSNrField();
      toggleContactFields();
      document.getElementById('alert_source')?.addEventListener('change', () => {
        toggleEMSNrField();
        toggleContactFields();
      });
    });
  </script>

</body>

</html>
